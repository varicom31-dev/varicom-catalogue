<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARICOM - Administration Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a3a6c;
            --secondary-color: #e63946;
            --accent-color: #2a9d8f;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 1400px;
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .upload-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.5s ease;
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-success { background: #28a745; border-left: 5px solid #1e7e34; }
        .sync-warning { background: #ffc107; color: #000; border-left: 5px solid #e0a800; }
        .sync-error { background: #dc3545; border-left: 5px solid #bd2130; }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .stats-card:hover { transform: translateY(-5px); }

        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .btn-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .ai-image-result {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            height: 100%;
        }

        .ai-image-result:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ai-image-result.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }

        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .search-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-tag:hover {
            background: var(--primary-color);
            color: white;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-source-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .smart-suggestions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .suggestion-tag {
            display: inline-block;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-tag:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .image-select-card {
            transition: all 0.3s;
            cursor: pointer;
        }

        .image-select-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .auto-search-progress {
            height: 5px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .auto-search-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status"></div>

    <div class="admin-container">
        <div class="admin-header text-center">
            <h1><i class="fas fa-user-shield me-3"></i>PANEL ADMINISTRATEUR VARICOM</h1>
            <p class="lead mb-0">Solution Professionnelle - Synchronisation Temps R√©el</p>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 bg-light border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0 text-primary"><i class="fas fa-bolt me-2"></i>Tableau de Bord</h4>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-warning btn-lg me-2" onclick="autoSearchProductImages()">
                        <i class="fas fa-robot me-2"></i>ÿ®ÿ≠ÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                    </button>
                    <button class="btn btn-success btn-lg me-2" onclick="uploadToGitHubGist()" id="publishBtn">
                        <i class="fab fa-github me-2"></i>Publier / Synchroniser
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="generateClientLink()">
                        <i class="fas fa-link me-2"></i>Lien Client
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row m-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-box fa-2x text-primary mb-2"></i>
                    <h3 id="statsProducts">0</h3>
                    <p class="text-muted mb-0">Produits Totaux</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-star fa-2x text-warning mb-2"></i>
                    <h3 id="statsNewProducts">0</h3>
                    <p class="text-muted mb-0">Nouveaut√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-bell fa-2x text-info mb-2"></i>
                    <h3 id="statsNotifications">0</h3>
                    <p class="text-muted mb-0">Notifications</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-sync fa-2x text-success mb-2"></i>
                    <h3 id="statsStatus">Inactif</h3>
                    <p class="text-muted mb-0">Statut Sync</p>
                </div>
            </div>
        </div>

        <!-- Smart Search Section -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-search-plus me-2"></i>ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä ŸÖÿ™ŸÇÿØŸÖ ÿ®ÿßŸÑÿµŸàÿ±</h5>
                    </div>
                    <div class="card-body">
                        <div class="smart-suggestions">
                            <h6><i class="fas fa-lightbulb me-2"></i>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ©:</h6>
                            <div id="smartSuggestions">
                                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã -->
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="smartSearchInput" 
                                           placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÑŸÖŸÜÿ™ÿ¨...">
                                    <button class="btn btn-primary" onclick="smartImageSearch()">
                                        <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="searchSource">
                                    <option value="auto">ÿ™ŸÑŸÇÿßÿ¶Ÿä (ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨)</option>
                                    <option value="bing">Bing Images</option>
                                    <option value="unsplash">Unsplash</option>
                                    <option value="google">Google Images</option>
                                    <option value="pixabay">Pixabay</option>
                                </select>
                            </div>
                        </div>

                        <div id="autoSearchProgress" class="auto-search-progress" style="display: none;">
                            <div id="autoSearchProgressBar" class="auto-search-progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="row g-3" id="smartResults"></div>
                        
                        <div class="mt-3 text-center" id="applyButtonContainer" style="display: none;">
                            <button class="btn btn-success btn-lg" onclick="applySelectedImageToCurrentProduct()">
                                <i class="fas fa-check-circle me-2"></i>ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨
                            </button>
                            <p class="text-muted mt-2 small" id="currentProductInfo"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Upload -->
        <div class="upload-section">
            <h4><i class="fas fa-file-excel me-2"></i>Importation Produits Excel</h4>
            <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelFile').click()">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h5>Cliquez ou glissez votre fichier Excel ici</h5>
                <p class="small opacity-75">Supporte .xlsx, .xls, .csv</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display: none;"
                    onchange="handleExcelUpload(this.files[0])">
            </div>
            <div class="mt-3 text-center">
                <button class="btn btn-outline-light btn-sm" onclick="downloadTemplate()">
                    <i class="fas fa-download me-1"></i>T√©l√©charger Mod√®le
                </button>
            </div>
        </div>

        <div class="row m-4">
            <!-- New Products -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ajouter Produit / Nouveaut√©</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="newProductName" placeholder="Nom du produit">
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="newProductPrice" placeholder="Prix (DA)">
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="newProductCategory">
                                        <option value="G√©n√©ral">Cat√©gorie...</option>
                                        <option value="Ordinateurs">Ordinateurs</option>
                                        <option value="T√©l√©phones">T√©l√©phones</option>
                                        <option value="Accessoires">Accessoires</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" class="form-control mt-2" id="newProductImage" placeholder="URL de l'image (https://...)">
                        </div>
                        <button class="btn btn-primary w-100" onclick="addNewProduct()">
                            <i class="fas fa-plus me-2"></i>Ajouter √† la liste
                        </button>

                        <hr>
                        <h6 class="text-muted">Produits Nouveaux Actifs:</h6>
                        <ul id="activeNewProducts" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>G√©rer Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="notifTitle" placeholder="Titre (ex: Promo)">
                            <textarea class="form-control mb-2" id="notifMessage" rows="2" placeholder="Message..."></textarea>
                            <select class="form-select" id="notifType">
                                <option value="info">Information ‚ÑπÔ∏è</option>
                                <option value="success">Succ√®s ‚úÖ</option>
                                <option value="warning">Attention ‚ö†Ô∏è</option>
                                <option value="error">Urgent ‚ùå</option>
                            </select>
                        </div>
                        <button class="btn btn-warning w-100" onclick="createNotification()">
                            <i class="fas fa-paper-plane me-2"></i>Publier Notification
                        </button>

                        <hr>
                        <h6 class="text-muted">Notifications Actives:</h6>
                        <ul id="activeNotifications" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Token GitHub (Personnel Access Token)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-github"></i></span>
                                    <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleToken()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">N√©cessaire pour la synchronisation. Stock√© localement.</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="resetSync()">
                                    <i class="fas fa-trash-alt me-2"></i>R√©initialiser Sync
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catalog Management -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Gestion du Catalogue</h5>
                        <button class="btn btn-light btn-sm text-primary fw-bold" onclick="openBulkImageModal()">
                            <i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Ref</th>
                                        <th>D√©signation</th>
                                        <th>Prix</th>
                                        <th style="width: 25%;">Image URL</th>
                                        <th style="width: 20%;">Description URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="catalogTableBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">Affichage limit√© aux 100 premiers produits pour la performance.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Image Modal -->
    <div class="modal fade" id="bulkImageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="bulkTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mode-hosted-tab" data-bs-toggle="tab" data-bs-target="#mode-hosted" type="button" role="tab">üìÇ Images H√©berg√©es</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-magic-tab" data-bs-toggle="tab" data-bs-target="#mode-magic" type="button" role="tab">‚ú® Images Magiques</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-ai-tab" data-bs-toggle="tab" data-bs-target="#mode-ai" type="button" role="tab">ü§ñ IA Intelligente</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-desc-tab" data-bs-toggle="tab" data-bs-target="#mode-desc" type="button" role="tab">üìù Descriptions Auto</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bulkTabsContent">
                        <!-- Hosted Mode -->
                        <div class="tab-pane fade show active" id="mode-hosted" role="tabpanel">
                            <p class="small text-muted">Utilisez ce mode si vous avez vos propres images h√©berg√©es (ex: GitHub Pages, Imgur).</p>
                            <div class="mb-3">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-control" id="bulkBaseUrl" placeholder="ex: https://monsite.com/images/">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Champ</label>
                                    <select class="form-select" id="bulkField">
                                        <option value="ref">R√©f√©rence</option>
                                        <option value="designation">D√©signation</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Extension</label>
                                    <select class="form-select" id="bulkExt">
                                        <option value=".jpg">.jpg</option>
                                        <option value=".png">.png</option>
                                        <option value=".webp">.webp</option>
                                        <option value="">(Aucune)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Magic Mode -->
                        <div class="tab-pane fade" id="mode-magic" role="tabpanel">
                            <div class="alert alert-warning small">
                                <i class="fas fa-exclamation-triangle me-2"></i><strong>Note:</strong> L'association <em>automatique</em> ne fonctionne qu'avec <strong>Bing</strong> pour des raisons techniques.
                            </div>
                            <p class="small text-muted">Recherche automatique d'images sur Bing via la D√©signation.</p>
                        </div>

                        <!-- AI Mode -->
                        <div class="tab-pane fade" id="mode-ai" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-robot me-2"></i><strong>Recherche Intelligente:</strong> Utilise l'IA pour trouver les meilleures images depuis plusieurs sources.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Recherche intelligente</label>
                                    <input type="text" class="form-control" id="aiSearchQuery" placeholder="Entrez le nom du produit ou laissez vide pour utiliser la d√©signation">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sources</label>
                                    <select class="form-select" id="aiSources" multiple>
                                        <option value="bing" selected>Bing</option>
                                        <option value="unsplash" selected>Unsplash</option>
                                        <option value="google">Google</option>
                                        <option value="pixabay">Pixabay</option>
                                    </select>
                                    <small class="text-muted">Maintenez Ctrl pour s√©lectionner plusieurs</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Type d'image</label>
                                    <select class="form-select" id="aiImageType">
                                        <option value="product">Produit commercial</option>
                                        <option value="photo">Photo r√©aliste</option>
                                        <option value="illustration">Illustration</option>
                                        <option value="logo">Logo/Marque</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Filtre IA</label>
                                    <select class="form-select" id="aiFilter">
                                        <option value="relevance">Pertinence IA</option>
                                        <option value="quality">Haute qualit√©</option>
                                        <option value="commercial">Usage commercial</option>
                                        <option value="recent">R√©cent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="search-tags mb-3">
                                <span class="search-tag" onclick="setSearchTag('produit')">produit</span>
                                <span class="search-tag" onclick="setSearchTag('fond blanc')">fond blanc</span>
                                <span class="search-tag" onclick="setSearchTag('professionnel')">professionnel</span>
                                <span class="search-tag" onclick="setSearchTag('haute qualit√©')">haute qualit√©</span>
                                <span class="search-tag" onclick="setSearchTag('commercial')">commercial</span>
                                <span class="search-tag" onclick="setSearchTag('isol√©')">isol√©</span>
                            </div>
                            
                            <button class="btn btn-primary w-100 mb-3" onclick="searchAIImages()">
                                <i class="fas fa-search me-2"></i>Rechercher avec IA
                            </button>
                            
                            <div id="aiResults" class="row g-3"></div>
                            <div id="aiLoader" class="text-center" style="display: none;">
                                <div class="loader"></div>
                                <p class="mt-2">Recherche intelligente en cours...</p>
                            </div>
                        </div>

                        <!-- Description Mode -->
                        <div class="tab-pane fade" id="mode-desc" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle me-2"></i><strong>Info:</strong> G√©n√®re un lien de recherche.
                            </div>
                            <p class="small text-muted">Cr√©e un lien "Fiche Technique" vers Bing pour chaque produit.</p>
                        </div>
                    </div>

                    <div class="alert alert-info small mt-3">
                        <strong>Aper√ßu:</strong> <span id="bulkPreview" class="text-break">...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="applyBulkActions()">Appliquer √† tous</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            products: [],
            newProducts: [],
            notifications: [],
            gistId: localStorage.getItem('varicom_gist_id') || null,
            lastSync: localStorage.getItem('varicom_last_sync') || null,
            smartSearch: {
                currentProduct: null,
                selectedImage: null,
                searchResults: [],
                currentSearchQuery: ''
            },
            autoSearch: {
                active: false,
                currentIndex: 0,
                totalProducts: 0
            }
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            updateUI();
            generateSmartSuggestions();

            // Token listener
            const tokenInput = document.getElementById('githubToken');
            tokenInput.value = localStorage.getItem('varicom_github_token') || '';
            tokenInput.addEventListener('input', (e) => localStorage.setItem('varicom_github_token', e.target.value));

            // Bulk Preview Listener
            ['bulkBaseUrl', 'bulkField', 'bulkExt'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateBulkPreview);
            });

            // Tab Change Listener
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateBulkPreview);
            });

            // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ŸÑÿ≤ÿ± Enter ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä
            document.getElementById('smartSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    smartImageSearch();
                }
            });
        });

        function loadLocalData() {
            try {
                const saved = localStorage.getItem('varicom_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.products = data.products || [];
                    state.newProducts = data.newProducts || [];
                    state.notifications = data.notifications || [];
                }
            } catch (e) { console.error('Error loading local data', e); }
        }

        function saveData() {
            localStorage.setItem('varicom_data', JSON.stringify({
                products: state.products,
                newProducts: state.newProducts,
                notifications: state.notifications
            }));
            updateUI();
        }

        // ==================== ÿ•ŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ© ====================
        function generateSmartSuggestions() {
            const suggestions = [
                'ÿµŸàÿ± ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©',
                'ÿÆŸÑŸÅŸäÿ© ÿ®Ÿäÿ∂ÿßÿ°',
                'ÿµŸàÿ± ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©',
                'ÿµŸàÿ± ŸÑŸÑŸÖŸÉÿßÿ™ÿ®',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸÖÿ®ŸäŸàÿ™ÿ±',
                'ŸáŸàÿßÿ™ŸÅ ÿ∞ŸÉŸäÿ©',
                'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™ ÿ™ŸÇŸÜŸäÿ©',
                'ÿµŸàÿ± ÿ™ÿ¨ÿßÿ±Ÿäÿ©',
                'ÿπÿ±Ÿàÿ∂ ÿ™ÿ±ŸàŸäÿ¨Ÿäÿ©',
                'ÿµŸàÿ± ŸàÿßŸÇÿπŸäÿ©',
                'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖŸÉÿ™ÿ®Ÿäÿ©',
                'ÿ∑ÿßÿ®ÿπÿßÿ™',
                'ÿ¥ÿßÿ¥ÿßÿ™',
                'ŸÑŸàÿ≠ÿßÿ™ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠'
            ];
            
            const container = document.getElementById('smartSuggestions');
            container.innerHTML = suggestions.map(tag => 
                `<span class="suggestion-tag" onclick="addSuggestion('${tag}')">${tag}</span>`
            ).join('');
        }

        function addSuggestion(tag) {
            document.getElementById('smartSearchInput').value = tag;
            smartImageSearch();
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ====================
        async function smartImageSearch() {
            const query = document.getElementById('smartSearchInput').value;
            const source = document.getElementById('searchSource').value;
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            state.smartSearch.currentSearchQuery = query;
            state.smartSearch.selectedImage = null;
            
            // ÿπÿ±ÿ∂ ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
            const resultsDiv = document.getElementById('smartResults');
            resultsDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ÿ¨ÿßÿ± ÿßŸÑÿ®ÿ≠ÿ´...</span>
                    </div>
                    <p class="mt-3">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿµŸàÿ± ŸÑŸÄ "${query}"...</p>
                </div>
            `;
            
            // ÿ•ÿÆŸÅÿßÿ° ÿ≤ÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´
            document.getElementById('applyButtonContainer').style.display = 'none';
            
            try {
                let images = [];
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿµÿØÿ± ÿßŸÑŸÖÿ≠ÿØÿØ
                switch(source) {
                    case 'bing':
                        images = await searchBingImages(query);
                        break;
                    case 'unsplash':
                        images = await searchUnsplashSimple(query);
                        break;
                    case 'google':
                        images = await searchGoogleImagesSimple(query);
                        break;
                    case 'pixabay':
                        images = await searchPixabaySimple(query);
                        break;
                    case 'auto':
                    default:
                        // ÿ®ÿ≠ÿ´ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ±
                        const bingImages = await searchBingImages(query);
                        const unsplashImages = await searchUnsplashSimple(query);
                        images = [...bingImages, ...unsplashImages];
                        break;
                }
                
                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ Ÿàÿ™ÿ≠ÿØŸäÿØ ÿ£ŸàŸÑ 12 ÿµŸàÿ±ÿ©
                images = removeDuplicates(images).slice(0, 12);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                state.smartSearch.searchResults = images;
                
                // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                displaySmartResults(images);
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ÿØÿØÿå ÿπÿ±ÿ∂ ÿ≤ÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                if (state.smartSearch.currentProduct) {
                    const product = state.products.find(p => p.id === state.smartSearch.currentProduct);
                    if (product) {
                        document.getElementById('currentProductInfo').textContent = `ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä: ${product.designation}`;
                        document.getElementById('applyButtonContainer').style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´: ${error.message}
                            <br><small>ÿ¨ÿ±ÿ® ŸÖÿµÿØÿ± ÿ®ÿ≠ÿ´ ŸÖÿÆÿ™ŸÑŸÅ</small>
                        </div>
                    </div>
                `;
            }
        }

        // ==================== ŸÖÿµÿßÿØÿ± ÿßŸÑÿ®ÿ≠ÿ´ ====================

        // 1. Bing Images - ŸäÿπŸÖŸÑ ÿ®ÿØŸàŸÜ API!
        async function searchBingImages(query) {
            const encodedQuery = encodeURIComponent(query + ' product white background commercial professional');
            
            try {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿàÿßÿ¨Ÿáÿ© Bing ÿßŸÑÿπÿßŸÖÿ©
                const timestamp = Date.now();
                const imageUrl = `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=500&h=500&c=7&rs=1&p=0&dpr=2&tid=image&t=${timestamp}`;
                
                return [{
                    url: imageUrl,
                    thumb: `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=300&h=300&c=7&rs=1&p=0`,
                    title: query,
                    source: 'Bing Images',
                    quality: 'high',
                    commercial: true,
                    width: 500,
                    height: 500
                }];
                
            } catch (e) {
                console.log('Using fallback Bing search');
                return [];
            }
        }

        // 2. Unsplash - ÿ®ÿØŸàŸÜ API key
        async function searchUnsplashSimple(query) {
            const encodedQuery = encodeURIComponent(query);
            
            try {
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Unsplash ÿ®ÿØŸàŸÜ API
                const imageUrl = `https://source.unsplash.com/featured/500x500/?${encodedQuery},product,white-background`;
                
                return [{
                    url: imageUrl,
                    thumb: `https://source.unsplash.com/featured/300x300/?${encodedQuery},product`,
                    title: query,
                    source: 'Unsplash',
                    quality: 'very-high',
                    commercial: true,
                    width: 500,
                    height: 500
                }];
            } catch (e) {
                return [];
            }
        }

        // 3. Google Images - ÿ∑ÿ±ŸäŸÇÿ© ÿ®ÿ≥Ÿäÿ∑ÿ©
        async function searchGoogleImagesSimple(query) {
            const encodedQuery = encodeURIComponent(query);
            
            return [{
                url: `https://www.google.com/search?tbm=isch&q=${encodedQuery}&tbs=ic:color,itp:photo,isz:l`,
                thumb: `https://via.placeholder.com/300x200/4A90E2/FFFFFF?text=Google+Search`,
                title: query,
                source: 'Google Images',
                quality: 'high',
                commercial: false,
                note: 'ÿßŸÜŸÇÿ± ŸÑŸÅÿ™ÿ≠ ÿ®ÿ≠ÿ´ Google'
            }];
        }

        // 4. Pixabay - ÿ∑ÿ±ŸäŸÇÿ© ÿ®ÿ≥Ÿäÿ∑ÿ©
        async function searchPixabaySimple(query) {
            const encodedQuery = encodeURIComponent(query);
            
            return [{
                url: `https://pixabay.com/images/search/${encodedQuery}/?orientation=horizontal&colors=grayscale`,
                thumb: `https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885_640.jpg`,
                title: query,
                source: 'Pixabay',
                quality: 'high',
                commercial: true,
                note: 'ÿßŸÜŸÇÿ± ŸÑŸÅÿ™ÿ≠ Pixabay'
            }];
        }

        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™
        function removeDuplicates(images) {
            const seen = new Set();
            return images.filter(img => {
                if (!img.url) return false;
                const key = img.url.split('?')[0];
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ∞ŸÉŸäÿ©
        function displaySmartResults(images) {
            const resultsDiv = document.getElementById('smartResults');
            
            if (!images.length) {
                resultsDiv.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p>ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±. ÿ¨ÿ±ÿ® ŸÉŸÑŸÖÿßÿ™ ÿ®ÿ≠ÿ´ ÿ£ÿÆÿ±Ÿâ.</p>
                        <button class="btn btn-primary mt-2" onclick="smartImageSearch()">
                            <i class="fas fa-redo me-2"></i>ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ®ÿ≠ÿ´
                        </button>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = images.map((img, index) => `
                <div class="col-md-3 col-sm-4 col-6">
                    <div class="card h-100 image-select-card" onclick="selectSmartImage(${index})" 
                         data-index="${index}">
                        <div class="position-relative" style="height: 180px; overflow: hidden;">
                            <img src="${img.thumb || img.url}" 
                                 class="card-img-top h-100 w-100" 
                                 alt="${img.title}"
                                 style="object-fit: cover;"
                                 onerror="this.src='https://via.placeholder.com/300x200/CCCCCC/969696?text=No+Image'">
                            <span class="search-source-badge">${img.source}</span>
                            ${img.quality === 'very-high' ? 
                                '<span class="badge bg-success position-absolute top-0 start-0 m-1">HD</span>' : ''}
                            ${img.commercial ? 
                                '<span class="badge bg-info position-absolute top-0 end-0 m-1">ÿ™ÿ¨ÿßÿ±Ÿä</span>' : ''}
                        </div>
                        <div class="card-body p-2">
                            <small class="text-muted d-block text-truncate" title="${img.title}">
                                ${img.title.substring(0, 25)}${img.title.length > 25 ? '...' : ''}
                            </small>
                            ${img.note ? 
                                `<small class="text-info d-block"><i class="fas fa-info-circle"></i> ${img.note}</small>` : ''}
                            <small class="text-success d-block">
                                <i class="fas fa-check-circle"></i> ${img.width || 500}√ó${img.height || 500}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸàÿ±ÿ© ÿ∞ŸÉŸäÿ©
        function selectSmartImage(index) {
            // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≥ÿßÿ®ŸÇ
            document.querySelectorAll('.image-select-card').forEach(card => {
                card.classList.remove('border-primary', 'border-3');
                card.classList.add('border-light');
            });
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ¨ÿØŸäÿØ
            const selectedCard = document.querySelector(`.image-select-card[data-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.remove('border-light');
                selectedCard.classList.add('border-primary', 'border-3');
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
                
                // ÿπÿ±ÿ∂ ÿ≤ÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖŸÜÿ™ÿ¨ ŸÖÿ≠ÿØÿØ
                if (state.smartSearch.currentProduct) {
                    document.getElementById('applyButtonContainer').style.display = 'block';
                }
                
                showStatus(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ© ŸÖŸÜ ${state.smartSearch.searchResults[index].source}`, 'info');
            }
        }

        // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä
        function applySelectedImageToCurrentProduct() {
            if (!state.smartSearch.currentProduct) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ™ÿ¨. ÿßÿÆÿ™ÿ± ŸÖŸÜÿ™ÿ¨ÿßŸã ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            if (!state.smartSearch.selectedImage) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ©. ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            updateProductImage(state.smartSearch.currentProduct, state.smartSearch.selectedImage.url);
            showStatus('‚úì ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
            
            // ÿ•ÿÆŸÅÿßÿ° ÿ≤ÿ± ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ§ŸÇÿ™ÿßŸã
            setTimeout(() => {
                document.getElementById('applyButtonContainer').style.display = 'none';
            }, 2000);
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ====================
        async function autoSearchProductImages() {
            if (state.products.length === 0) {
                showStatus('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ®ÿØŸàŸÜ ÿµŸàÿ± ÿ£Ÿà ÿ®ÿµŸàÿ± ÿ∫Ÿäÿ± ÿ¨ŸäÿØÿ©
            const productsNeedingImages = state.products.filter(p => {
                const hasImage = p.image && p.image.trim() !== '';
                const isGoodImage = hasImage && (
                    p.image.includes('bing.net') || 
                    p.image.includes('unsplash') ||
                    p.image.includes('google') ||
                    p.image.includes('pixabay')
                );
                return !hasImage || !isGoodImage;
            }).slice(0, 20); // ÿ≠ÿØ ÿ£ŸÇÿµŸâ 20 ŸÖŸÜÿ™ÿ¨
            
            if (productsNeedingImages.length === 0) {
                showStatus('ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿµŸàÿ± ÿ¨ŸäÿØÿ©', 'info');
                return;
            }
            
            state.autoSearch = {
                active: true,
                currentIndex: 0,
                totalProducts: productsNeedingImages.length,
                products: productsNeedingImages
            };
            
            // ÿπÿ±ÿ∂ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
            document.getElementById('autoSearchProgress').style.display = 'block';
            updateAutoSearchProgress();
            
            showStatus(`ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÄ ${productsNeedingImages.length} ŸÖŸÜÿ™ÿ¨...`, 'info');
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿ™ÿ≥ŸÑÿ≥ŸÑŸä
            for (let i = 0; i < productsNeedingImages.length; i++) {
                if (!state.autoSearch.active) break;
                
                const product = productsNeedingImages[i];
                state.autoSearch.currentIndex = i + 1;
                
                try {
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± Bing (ÿßŸÑÿ£ŸÅÿ∂ŸÑ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™)
                    const images = await searchBingImages(product.designation);
                    if (images.length > 0) {
                        updateProductImage(product.id, images[0].url);
                        
                        // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                        updateAutoSearchProgress();
                        
                        showStatus(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${product.designation} (${i+1}/${productsNeedingImages.length})`, 'success');
                    }
                } catch (e) {
                    console.error(`Failed to search for: ${product.designation}`);
                }
                
                // ÿßŸÜÿ™ÿ∏ÿßÿ± 1.5 ÿ´ÿßŸÜŸäÿ© ÿ®ŸäŸÜ ŸÉŸÑ ÿ®ÿ≠ÿ´ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ÿ∏ÿ±
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            state.autoSearch.active = false;
            document.getElementById('autoSearchProgress').style.display = 'none';
            showStatus('ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä!', 'success');
        }

        function updateAutoSearchProgress() {
            if (!state.autoSearch.active) return;
            
            const progress = (state.autoSearch.currentIndex / state.autoSearch.totalProducts) * 100;
            document.getElementById('autoSearchProgressBar').style.width = `${progress}%`;
        }

        // ==================== Excel Handling ====================
        function handleExcelUpload(file) {
            if (!file) return;

            showStatus('Lecture du fichier...', 'info');
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processExcelData(jsonData);
                } catch (err) {
                    showStatus('Erreur lecture Excel: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const processed = data.map((row, idx) => ({
                id: `prod_${Date.now()}_${idx}`,
                ref: row['Ref'] || row['R√©f√©rence'] || row['Code'] || 'N/A',
                designation: row['Designation'] || row['D√©signation'] || row['Nom'] || 'Produit sans nom',
                famille: row['Famille'] || row['Categorie'] || 'G√©n√©ral',
                prix: parseFloat(row['Prix'] || row['Price'] || 0),
                image: row['Image'] || row['Photo'] || '',
                description: row['Description'] || row['Desc'] || ''
            })).filter(p => p.prix > 0);

            state.products = processed;
            saveData();
            showStatus(`${processed.length} produits import√©s avec succ√®s!`, 'success');
        }

        // ==================== Product & Notification Management ====================
        function addNewProduct() {
            const name = document.getElementById('newProductName').value;
            const price = document.getElementById('newProductPrice').value;
            const cat = document.getElementById('newProductCategory').value;
            const img = document.getElementById('newProductImage').value;

            if (!name || !price) return showStatus('Nom et Prix requis', 'warning');

            state.newProducts.unshift({
                id: `new_${Date.now()}`,
                name,
                price: parseFloat(price),
                category: cat,
                image: img,
                timestamp: new Date().toISOString()
            });

            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            saveData();
            showStatus('Nouveau produit ajout√©', 'success');
        }

        function createNotification() {
            const title = document.getElementById('notifTitle').value;
            const msg = document.getElementById('notifMessage').value;
            const type = document.getElementById('notifType').value;

            if (!title || !msg) return showStatus('Titre et Message requis', 'warning');

            state.notifications.unshift({
                id: `notif_${Date.now()}`,
                title,
                message: msg,
                type,
                timestamp: new Date().toISOString()
            });

            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            saveData();
            showStatus('Notification cr√©√©e', 'success');
        }

        function removeNewProduct(id) {
            state.newProducts = state.newProducts.filter(p => p.id !== id);
            saveData();
        }

        function removeNotification(id) {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
        }

        // ==================== Bulk Functions ====================
        function openBulkImageModal() {
            new bootstrap.Modal(document.getElementById('bulkImageModal')).show();
            updateBulkPreview();
        }

        function updateBulkPreview() {
            const activeTab = document.querySelector('.nav-link.active').id;

            if (activeTab === 'mode-magic-tab') {
                document.getElementById('bulkPreview').textContent = `https://tse2.mm.bing.net/th?q=Exemple...`;
            } else if (activeTab === 'mode-desc-tab') {
                document.getElementById('bulkPreview').textContent = `https://www.bing.com/search?q=fiche+technique+Exemple`;
            } else if (activeTab === 'mode-ai-tab') {
                document.getElementById('bulkPreview').textContent = `Recherche IA avec ${document.getElementById('aiSources').selectedOptions.length} sources`;
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl').value || 'https://site.com/img/';
                const field = document.getElementById('bulkField').value;
                const ext = document.getElementById('bulkExt').value;
                const example = field === 'ref' ? 'REF123' : 'Produit_Exemple';
                document.getElementById('bulkPreview').textContent = `${baseUrl}${example}${ext}`;
            }
        }

        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´
        function setSearchTag(tag) {
            const input = document.getElementById('aiSearchQuery');
            const current = input.value.trim();
            input.value = current ? `${current} ${tag}` : tag;
        }

        // ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©
        async function searchAIImages() {
            const query = document.getElementById('aiSearchQuery').value;
            const sources = Array.from(document.getElementById('aiSources').selectedOptions).map(o => o.value);
            const imageType = document.getElementById('aiImageType').value;
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }

            document.getElementById('aiLoader').style.display = 'block';
            document.getElementById('aiResults').innerHTML = '';

            try {
                let images = [];
                
                // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ± ÿßŸÑŸÖÿ≠ÿØÿØÿ©
                for (const source of sources) {
                    let sourceImages = [];
                    switch(source) {
                        case 'bing':
                            sourceImages = await searchBingImages(query);
                            break;
                        case 'unsplash':
                            sourceImages = await searchUnsplashSimple(query);
                            break;
                        case 'google':
                            sourceImages = await searchGoogleImagesSimple(query);
                            break;
                        case 'pixabay':
                            sourceImages = await searchPixabaySimple(query);
                            break;
                    }
                    images = [...images, ...sourceImages];
                }

                // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™
                images = removeDuplicates(images).slice(0, 9);
                
                // ÿ≠ŸÅÿ∏ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
                state.smartSearch.searchResults = images;
                
                // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸÅŸä ÿßŸÑÿ™ÿ®ŸàŸäÿ®
                displayAIResults(images);
                
            } catch (error) {
                console.error('AI Search error:', error);
                document.getElementById('aiResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Erreur de recherche: ${error.message}
                        </div>
                    </div>
                `;
            } finally {
                document.getElementById('aiLoader').style.display = 'none';
            }
        }

        function displayAIResults(results) {
            const container = document.getElementById('aiResults');
            
            if (!results.length) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Aucune image trouv√©e. Essayez avec d'autres termes.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map((img, index) => `
                <div class="col-md-4 col-sm-6">
                    <div class="ai-image-result" onclick="selectAIImage(${index})">
                        <img src="${img.thumb}" class="img-fluid w-100" style="height: 150px; object-fit: cover;">
                        <div class="p-2">
                            <small class="d-block text-truncate">${img.title}</small>
                            <small class="text-muted">
                                <i class="fas fa-${img.source === 'Unsplash' ? 'camera' : 'search'} me-1"></i>
                                ${img.source}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectAIImage(index) {
            document.querySelectorAll('.ai-image-result').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selected = document.querySelectorAll('.ai-image-result')[index];
            if (selected) {
                selected.classList.add('selected');
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
            }
        }

        function applyBulkActions() {
            const activeTab = document.querySelector('.nav-link.active').id;

            if (confirm(`Cela va modifier ${state.products.length} produits. Continuer?`)) {

                if (activeTab === 'mode-magic-tab') {
                    // Magic Images
                    state.products = state.products.map(p => ({
                        ...p,
                        image: `https://tse2.mm.bing.net/th?q=${encodeURIComponent(p.designation)}&w=500&h=500&c=7&rs=1&p=0`
                    }));
                } else if (activeTab === 'mode-desc-tab') {
                    // Magic Descriptions
                    state.products = state.products.map(p => ({
                        ...p,
                        description: `https://www.bing.com/search?q=fiche+technique+${encodeURIComponent(p.designation)}`
                    }));
                } else if (activeTab === 'mode-ai-tab') {
                    // AI Images
                    if (state.smartSearch.selectedImage) {
                        const selectedUrl = state.smartSearch.selectedImage.url;
                        state.products = state.products.map(p => ({
                            ...p,
                            image: selectedUrl
                        }));
                        showStatus('Image IA appliqu√©e √† tous les produits', 'success');
                    } else {
                        showStatus('Veuillez d\'abord s√©lectionner une image', 'warning');
                        return;
                    }
                } else {
                    // Hosted Images
                    const baseUrl = document.getElementById('bulkBaseUrl').value;
                    const field = document.getElementById('bulkField').value;
                    const ext = document.getElementById('bulkExt').value;

                    if (!baseUrl) return alert('Veuillez entrer une URL de base');

                    state.products = state.products.map(p => {
                        const val = p[field] ? p[field].toString().trim() : '';
                        const safeVal = field === 'designation' ? val.replace(/[^a-zA-Z0-9-_]/g, '_') : val;
                        return {
                            ...p,
                            image: `${baseUrl}${safeVal}${ext}`
                        };
                    });
                }

                saveData();
                bootstrap.Modal.getInstance(document.getElementById('bulkImageModal')).hide();
                showStatus('Mise √† jour effectu√©e avec succ√®s!', 'success');
            }
        }

        // ==================== ÿØÿßŸÑÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ¨ÿØŸàŸÑ ====================
        function searchImage(term, provider) {
            const query = encodeURIComponent(term);
            let url = '';

            switch (provider) {
                case 'google': url = `https://www.google.com/search?tbm=isch&q=${query}`; break;
                case 'bing': url = `https://www.bing.com/images/search?q=${query}`; break;
                case 'unsplash': url = `https://unsplash.com/s/photos/${query}`; break;
                case 'facebook': url = `https://www.facebook.com/search/photos/?q=${query}`; break;
            }

            if (url) window.open(url, '_blank');
        }

        // ŸÅÿ™ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿπŸäŸÜ ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ
        function openSmartSearchForProduct(productId, designation) {
            state.smartSearch.currentProduct = productId;
            document.getElementById('smartSearchInput').value = designation;
            document.getElementById('searchSource').value = 'auto';
            
            // ÿ™ŸÖÿ±Ÿäÿ± ÿ•ŸÑŸâ ŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä
            document.querySelector('.smart-suggestions').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            
            // ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ ÿ™ÿ£ÿÆŸäÿ± ÿ®ÿ≥Ÿäÿ∑
            setTimeout(() => {
                smartImageSearch();
                showStatus(`ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÄ ${designation}ÿå ÿ´ŸÖ ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ© ÿ´ŸÖ ÿπŸÑŸâ "ÿ™ÿ∑ÿ®ŸäŸÇ"`, 'info');
            }, 800);
        }

        // ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ÿ®ÿßŸÑÿµŸàÿ±
        async function quickImageSearch(productId, designation) {
            showStatus(`ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ${designation}...`, 'info');
            
            try {
                const images = await searchBingImages(designation + ' product white background');
                if (images.length > 0) {
                    updateProductImage(productId, images[0].url);
                    showStatus(`‚úì ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${designation}`, 'success');
                } else {
                    showStatus('ŸÑŸÖ ÿ£ÿ¨ÿØ ÿµŸàÿ±ÿßŸã ŸÖŸÜÿßÿ≥ÿ®ÿ©', 'warning');
                }
            } catch (error) {
                showStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´', 'error');
            }
        }

        // ==================== Product Image/Desc Updates ====================
        function updateProductImage(id, newUrl) {
            const p = state.products.find(p => p.id === id);
            if (p) {
                p.image = newUrl;
                saveData();
                updateUI(); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸÅŸàÿ±ÿßŸã
            }
        }

        function updateProductDesc(id, newUrl) {
            const p = state.products.find(p => p.id === id);
            if (p) {
                p.description = newUrl;
                saveData();
            }
        }

        // ==================== GitHub Sync ====================
        async function uploadToGitHubGist() {
            const token = document.getElementById('githubToken').value;
            if (!token) return showStatus('Token GitHub manquant!', 'error');

            if (state.products.length === 0 && state.newProducts.length === 0) {
                return showStatus('Aucun produit √† publier! Veuillez importer des donn√©es.', 'warning');
            }

            const btn = document.getElementById('publishBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            btn.disabled = true;

            const payload = {
                description: "VARICOM Catalog Data",
                public: true,
                files: {
                    "varicom_data.json": {
                        content: JSON.stringify({
                            products: state.products,
                            newProducts: state.newProducts,
                            notifications: state.notifications,
                            lastUpdate: new Date().toISOString(),
                            meta: { version: "2.0", source: "VaricomAdmin" }
                        })
                    }
                }
            };

            try {
                let url = 'https://api.github.com/gists';
                let method = 'POST';

                if (state.gistId) {
                    url += `/${state.gistId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 404 && state.gistId) {
                        state.gistId = null;
                        return uploadToGitHubGist();
                    }
                    throw new Error(`Erreur GitHub: ${response.status}`);
                }

                const result = await response.json();
                state.gistId = result.id;
                state.lastSync = new Date().toISOString();

                localStorage.setItem('varicom_gist_id', state.gistId);
                localStorage.setItem('varicom_last_sync', state.lastSync);

                showStatus('‚úÖ Synchronisation r√©ussie! Donn√©es publi√©es.', 'success');
                updateUI();

            } catch (err) {
                console.error(err);
                showStatus('Erreur Sync: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== UI Updates ====================
        function updateUI() {
            // Stats
            document.getElementById('statsProducts').textContent = state.products.length;
            document.getElementById('statsNewProducts').textContent = state.newProducts.length;
            document.getElementById('statsNotifications').textContent = state.notifications.length;
            document.getElementById('statsStatus').textContent = state.gistId ? 'Actif' : 'Inactif';
            document.getElementById('statsStatus').className = state.gistId ? 'text-success' : 'text-danger';

            // Helper functions for escaping
            const escapeHtml = (str) => str ? str.toString().replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
            const escapeJs = (str) => str ? str.toString().replace(/'/g, "\\'") : '';

            // Lists
            const npList = document.getElementById('activeNewProducts');
            npList.innerHTML = state.newProducts.map(p => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${escapeHtml(p.name)}</strong> - ${p.price} DA</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNewProduct('${escapeJs(p.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');

            const notifList = document.getElementById('activeNotifications');
            notifList.innerHTML = state.notifications.map(n => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><span class="badge bg-${getBadgeClass(n.type)}">${n.type}</span> ${escapeHtml(n.title)}</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNotification('${escapeJs(n.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');

            // Catalog Table
            const tableBody = document.getElementById('catalogTableBody');
            tableBody.innerHTML = state.products.slice(0, 100).map(p => `
                <tr>
                    <td><small>${escapeHtml(p.ref)}</small></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${escapeHtml(p.designation)}">${escapeHtml(p.designation)}</td>
                    <td>${p.prix} DA</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" 
                                   value="${escapeHtml(p.image || '')}" 
                                   onchange="updateProductImage('${escapeJs(p.id)}', this.value)"
                                   placeholder="URL Image...">
                            <button class="btn btn-outline-primary" 
                                    onclick="quickImageSearch('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ">
                                <i class="fas fa-bolt"></i>
                            </button>
                        </div>
                        ${p.image ? `<small class="text-success"><i class="fas fa-check-circle"></i> ŸÖŸàÿ¨ŸàÿØÿ©</small>` : 
                                    `<small class="text-danger"><i class="fas fa-times-circle"></i> ŸÖŸÅŸÇŸàÿØÿ©</small>`}
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${escapeHtml(p.description || '')}" 
                               onchange="updateProductDesc('${escapeJs(p.id)}', this.value)"
                               placeholder="URL Desc...">
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" 
                                    onclick="openSmartSearchForProduct('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-outline-primary" 
                                    onclick="window.open('https://www.bing.com/images/search?q=${encodeURIComponent(p.designation + ' product')}', '_blank')"
                                    title="Bing">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-info" 
                                    onclick="window.open('https://unsplash.com/s/photos/${encodeURIComponent(p.designation)}', '_blank')"
                                    title="Unsplash">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getBadgeClass(type) {
            switch (type) {
                case 'info': return 'info';
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                default: return 'secondary';
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('syncStatus');
            el.textContent = msg;
            el.className = 'sync-status';
            el.classList.add(type === 'success' ? 'sync-success' : type === 'warning' ? 'sync-warning' : 'sync-error');
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function generateClientLink() {
            if (!state.gistId) return showStatus('Veuillez d\'abord publier le catalogue', 'warning');

            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            const clientUrl = `${baseUrl}index.html?gist=${state.gistId}`;

            navigator.clipboard.writeText(clientUrl).then(() => {
                showStatus('‚úÖ Lien client copi√©!', 'success');
            }).catch(() => {
                prompt('Copiez ce lien manuellement:', clientUrl);
                showStatus('Lien pr√™t √† √™tre copi√©', 'info');
            });
        }

        function toggleToken() {
            const input = document.getElementById('githubToken');
            const icon = input.parentNode.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function resetSync() {
            if (confirm('Voulez-vous vraiment r√©initialiser la synchronisation? Cela d√©connectera le catalogue actuel.')) {
                localStorage.removeItem('varicom_gist_id');
                localStorage.removeItem('varicom_last_sync');
                state.gistId = null;
                state.lastSync = null;
                updateUI();
                showStatus('Synchronisation r√©initialis√©e', 'info');
            }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([
                { Ref: 'REF001', Designation: 'Exemple Produit', Famille: 'Informatique', Prix: 1000, Image: '', Description: '' }
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Modele");
            XLSX.writeFile(wb, "modele_import_varicom.xlsx");
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
