<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARICOM - Administration Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a3a6c;
            --secondary-color: #e63946;
            --accent-color: #2a9d8f;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 1400px;
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .upload-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.5s ease;
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-success { background: #28a745; border-left: 5px solid #1e7e34; }
        .sync-warning { background: #ffc107; color: #000; border-left: 5px solid #e0a800; }
        .sync-error { background: #dc3545; border-left: 5px solid #bd2130; }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .stats-card:hover { transform: translateY(-5px); }

        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .btn-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .ai-image-result {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .ai-image-result:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ai-image-result.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }

        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .search-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-tag:hover {
            background: var(--primary-color);
            color: white;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status"></div>

    <div class="admin-container">
        <div class="admin-header text-center">
            <h1><i class="fas fa-user-shield me-3"></i>PANEL ADMINISTRATEUR VARICOM</h1>
            <p class="lead mb-0">Solution Professionnelle - Synchronisation Temps R√©el</p>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 bg-light border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0 text-primary"><i class="fas fa-bolt me-2"></i>Tableau de Bord</h4>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success btn-lg me-2" onclick="uploadToGitHubGist()" id="publishBtn">
                        <i class="fab fa-github me-2"></i>Publier / Synchroniser
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="generateClientLink()">
                        <i class="fas fa-link me-2"></i>Lien Client
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row m-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-box fa-2x text-primary mb-2"></i>
                    <h3 id="statsProducts">0</h3>
                    <p class="text-muted mb-0">Produits Totaux</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-star fa-2x text-warning mb-2"></i>
                    <h3 id="statsNewProducts">0</h3>
                    <p class="text-muted mb-0">Nouveaut√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-bell fa-2x text-info mb-2"></i>
                    <h3 id="statsNotifications">0</h3>
                    <p class="text-muted mb-0">Notifications</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-sync fa-2x text-success mb-2"></i>
                    <h3 id="statsStatus">Inactif</h3>
                    <p class="text-muted mb-0">Statut Sync</p>
                </div>
            </div>
        </div>

        <!-- AI Configuration Section -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Configuration IA - Recherche Intelligente</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cl√© API Unsplash</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                    <input type="password" class="form-control" id="unsplashKey" 
                                           placeholder="Votre cl√© Unsplash">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleUnsplashKey()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Pour les images professionnelles gratuites</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cl√© API Google Custom Search</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-google"></i></span>
                                    <input type="password" class="form-control" id="googleKey" 
                                           placeholder="Cl√© API Google">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleGoogleKey()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Pour la recherche Google avanc√©e</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Moteur de recherche IA</label>
                                <select class="form-select" id="aiEngine">
                                    <option value="unsplash">Unsplash (Images professionnelles)</option>
                                    <option value="google">Google Images</option>
                                    <option value="pixabay">Pixabay (Libre de droits)</option>
                                    <option value="multiple">Recherche multiple</option>
                                </select>
                                <small class="text-muted">S√©lectionnez la source principale</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Langue de recherche</label>
                                <select class="form-select" id="searchLanguage">
                                    <option value="fr">Fran√ßais</option>
                                    <option value="en">Anglais</option>
                                    <option value="ar">Arabe</option>
                                    <option value="auto">Auto-d√©tection</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Filtre de contenu</label>
                                <select class="form-select" id="contentFilter">
                                    <option value="high">Strict (Supprime les images inappropri√©es)</option>
                                    <option value="medium">Mod√©r√©</option>
                                    <option value="low">Basique</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success" onclick="saveAIConfig()">
                            <i class="fas fa-save me-2"></i>Enregistrer Configuration IA
                        </button>
                        <button class="btn btn-outline-info ms-2" onclick="testAIAPI()">
                            <i class="fas fa-test me-2"></i>Tester les APIs
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Upload -->
        <div class="upload-section">
            <h4><i class="fas fa-file-excel me-2"></i>Importation Produits Excel</h4>
            <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelFile').click()">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h5>Cliquez ou glissez votre fichier Excel ici</h5>
                <p class="small opacity-75">Supporte .xlsx, .xls, .csv</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display: none;"
                    onchange="handleExcelUpload(this.files[0])">
            </div>
            <div class="mt-3 text-center">
                <button class="btn btn-outline-light btn-sm" onclick="downloadTemplate()">
                    <i class="fas fa-download me-1"></i>T√©l√©charger Mod√®le
                </button>
            </div>
        </div>

        <div class="row m-4">
            <!-- New Products -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ajouter Produit / Nouveaut√©</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="newProductName" placeholder="Nom du produit">
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="newProductPrice" placeholder="Prix (DA)">
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="newProductCategory">
                                        <option value="G√©n√©ral">Cat√©gorie...</option>
                                        <option value="Ordinateurs">Ordinateurs</option>
                                        <option value="T√©l√©phones">T√©l√©phones</option>
                                        <option value="Accessoires">Accessoires</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" class="form-control mt-2" id="newProductImage" placeholder="URL de l'image (https://...)">
                        </div>
                        <button class="btn btn-primary w-100" onclick="addNewProduct()">
                            <i class="fas fa-plus me-2"></i>Ajouter √† la liste
                        </button>

                        <hr>
                        <h6 class="text-muted">Produits Nouveaux Actifs:</h6>
                        <ul id="activeNewProducts" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>G√©rer Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="notifTitle" placeholder="Titre (ex: Promo)">
                            <textarea class="form-control mb-2" id="notifMessage" rows="2" placeholder="Message..."></textarea>
                            <select class="form-select" id="notifType">
                                <option value="info">Information ‚ÑπÔ∏è</option>
                                <option value="success">Succ√®s ‚úÖ</option>
                                <option value="warning">Attention ‚ö†Ô∏è</option>
                                <option value="error">Urgent ‚ùå</option>
                            </select>
                        </div>
                        <button class="btn btn-warning w-100" onclick="createNotification()">
                            <i class="fas fa-paper-plane me-2"></i>Publier Notification
                        </button>

                        <hr>
                        <h6 class="text-muted">Notifications Actives:</h6>
                        <ul id="activeNotifications" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Token GitHub (Personnel Access Token)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-github"></i></span>
                                    <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleToken()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">N√©cessaire pour la synchronisation. Stock√© localement.</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="resetSync()">
                                    <i class="fas fa-trash-alt me-2"></i>R√©initialiser Sync
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catalog Management -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Gestion du Catalogue</h5>
                        <button class="btn btn-light btn-sm text-primary fw-bold" onclick="openBulkImageModal()">
                            <i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Ref</th>
                                        <th>D√©signation</th>
                                        <th>Prix</th>
                                        <th style="width: 25%;">Image URL</th>
                                        <th style="width: 20%;">Description URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="catalogTableBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">Affichage limit√© aux 100 premiers produits pour la performance.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Image Modal -->
    <div class="modal fade" id="bulkImageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="bulkTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mode-hosted-tab" data-bs-toggle="tab" data-bs-target="#mode-hosted" type="button" role="tab">üìÇ Images H√©berg√©es</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-magic-tab" data-bs-toggle="tab" data-bs-target="#mode-magic" type="button" role="tab">‚ú® Images Magiques</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-ai-tab" data-bs-toggle="tab" data-bs-target="#mode-ai" type="button" role="tab">ü§ñ IA Intelligente</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-desc-tab" data-bs-toggle="tab" data-bs-target="#mode-desc" type="button" role="tab">üìù Descriptions Auto</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bulkTabsContent">
                        <!-- Hosted Mode -->
                        <div class="tab-pane fade show active" id="mode-hosted" role="tabpanel">
                            <p class="small text-muted">Utilisez ce mode si vous avez vos propres images h√©berg√©es (ex: GitHub Pages, Imgur).</p>
                            <div class="mb-3">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-control" id="bulkBaseUrl" placeholder="ex: https://monsite.com/images/">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Champ</label>
                                    <select class="form-select" id="bulkField">
                                        <option value="ref">R√©f√©rence</option>
                                        <option value="designation">D√©signation</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Extension</label>
                                    <select class="form-select" id="bulkExt">
                                        <option value=".jpg">.jpg</option>
                                        <option value=".png">.png</option>
                                        <option value=".webp">.webp</option>
                                        <option value="">(Aucune)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Magic Mode -->
                        <div class="tab-pane fade" id="mode-magic" role="tabpanel">
                            <div class="alert alert-warning small">
                                <i class="fas fa-exclamation-triangle me-2"></i><strong>Note:</strong> L'association <em>automatique</em> ne fonctionne qu'avec <strong>Bing</strong> pour des raisons techniques.
                            </div>
                            <p class="small text-muted">Recherche automatique d'images sur Bing via la D√©signation.</p>
                        </div>

                        <!-- AI Mode -->
                        <div class="tab-pane fade" id="mode-ai" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-robot me-2"></i><strong>Recherche Intelligente:</strong> Utilise l'IA pour trouver les meilleures images depuis plusieurs sources.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Recherche intelligente</label>
                                    <input type="text" class="form-control" id="aiSearchQuery" placeholder="Entrez le nom du produit ou laissez vide pour utiliser la d√©signation">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sources</label>
                                    <select class="form-select" id="aiSources" multiple>
                                        <option value="unsplash" selected>Unsplash</option>
                                        <option value="pixabay" selected>Pixabay</option>
                                        <option value="google">Google</option>
                                        <option value="facebook">Facebook (public)</option>
                                    </select>
                                    <small class="text-muted">Maintenez Ctrl pour s√©lectionner plusieurs</small>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Type d'image</label>
                                    <select class="form-select" id="aiImageType">
                                        <option value="product">Produit commercial</option>
                                        <option value="photo">Photo r√©aliste</option>
                                        <option value="illustration">Illustration</option>
                                        <option value="logo">Logo/Marque</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Filtre IA</label>
                                    <select class="form-select" id="aiFilter">
                                        <option value="relevance">Pertinence IA</option>
                                        <option value="quality">Haute qualit√©</option>
                                        <option value="commercial">Usage commercial</option>
                                        <option value="recent">R√©cent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="search-tags mb-3">
                                <span class="search-tag" onclick="setSearchTag('professionnel')">professionnel</span>
                                <span class="search-tag" onclick="setSearchTag('blanc')">fond blanc</span>
                                <span class="search-tag" onclick="setSearchTag('3d')">rendu 3D</span>
                                <span class="search-tag" onclick="setSearchTag('isol√©')">isol√©</span>
                                <span class="search-tag" onclick="setSearchTag('haute qualit√©')">haute qualit√©</span>
                                <span class="search-tag" onclick="setSearchTag('commercial')">commercial</span>
                            </div>
                            
                            <button class="btn btn-primary w-100 mb-3" onclick="searchAIImages()">
                                <i class="fas fa-search me-2"></i>Rechercher avec IA
                            </button>
                            
                            <div id="aiResults" class="row g-3"></div>
                            <div id="aiLoader" class="text-center" style="display: none;">
                                <div class="loader"></div>
                                <p class="mt-2">Recherche intelligente en cours...</p>
                            </div>
                        </div>

                        <!-- Description Mode -->
                        <div class="tab-pane fade" id="mode-desc" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle me-2"></i><strong>Info:</strong> G√©n√®re un lien de recherche.
                            </div>
                            <p class="small text-muted">Cr√©e un lien "Fiche Technique" vers Bing pour chaque produit.</p>
                        </div>
                    </div>

                    <div class="alert alert-info small mt-3">
                        <strong>Aper√ßu:</strong> <span id="bulkPreview" class="text-break">...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="applyBulkActions()">Appliquer √† tous</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Single Product Search Modal -->
    <div class="modal fade" id="aiProductSearchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Recherche IA pour Produit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 id="currentProductName" class="mb-3"></h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="productSearchQuery" placeholder="Termes de recherche additionnels...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="searchForCurrentProduct()">
                                <i class="fas fa-search me-2"></i>Rechercher
                            </button>
                        </div>
                    </div>
                    
                    <div class="search-tags mb-3">
                        <span class="search-tag" onclick="addProductSearchTag('fond blanc')">fond blanc</span>
                        <span class="search-tag" onclick="addProductSearchTag('professionnel')">professionnel</span>
                        <span class="search-tag" onclick="addProductSearchTag('haute qualit√©')">haute qualit√©</span>
                        <span class="search-tag" onclick="addProductSearchTag('commercial')">commercial</span>
                        <span class="search-tag" onclick="addProductSearchTag('isol√©')">isol√©</span>
                        <span class="search-tag" onclick="addProductSearchTag('3d rendu')">rendu 3D</span>
                    </div>
                    
                    <div id="productAiResults" class="row g-3"></div>
                    <div id="productAiLoader" class="text-center" style="display: none;">
                        <div class="loader"></div>
                        <p class="mt-2">Analyse IA en cours...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="applySelectedImageToProduct()">
                        <i class="fas fa-check me-2"></i>Appliquer l'image s√©lectionn√©e
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            products: [],
            newProducts: [],
            notifications: [],
            gistId: localStorage.getItem('varicom_gist_id') || null,
            lastSync: localStorage.getItem('varicom_last_sync') || null,
            aiConfig: JSON.parse(localStorage.getItem('varicom_ai_config')) || {
                unsplashKey: '',
                googleKey: '',
                engine: 'unsplash',
                language: 'fr',
                filter: 'high'
            },
            currentAISearch: {
                productId: null,
                selectedImage: null,
                searchResults: []
            }
        };

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            updateUI();
            loadAIConfig();

            // Token listener
            const tokenInput = document.getElementById('githubToken');
            tokenInput.value = localStorage.getItem('varicom_github_token') || '';
            tokenInput.addEventListener('input', (e) => localStorage.setItem('varicom_github_token', e.target.value));

            // Bulk Preview Listener
            ['bulkBaseUrl', 'bulkField', 'bulkExt'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateBulkPreview);
            });

            // Tab Change Listener
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateBulkPreview);
            });
        });

        function loadLocalData() {
            try {
                const saved = localStorage.getItem('varicom_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.products = data.products || [];
                    state.newProducts = data.newProducts || [];
                    state.notifications = data.notifications || [];
                }
            } catch (e) { console.error('Error loading local data', e); }
        }

        function loadAIConfig() {
            document.getElementById('unsplashKey').value = state.aiConfig.unsplashKey || '';
            document.getElementById('googleKey').value = state.aiConfig.googleKey || '';
            document.getElementById('aiEngine').value = state.aiConfig.engine || 'unsplash';
            document.getElementById('searchLanguage').value = state.aiConfig.language || 'fr';
            document.getElementById('contentFilter').value = state.aiConfig.filter || 'high';
        }

        function saveAIConfig() {
            state.aiConfig = {
                unsplashKey: document.getElementById('unsplashKey').value,
                googleKey: document.getElementById('googleKey').value,
                engine: document.getElementById('aiEngine').value,
                language: document.getElementById('searchLanguage').value,
                filter: document.getElementById('contentFilter').value
            };
            localStorage.setItem('varicom_ai_config', JSON.stringify(state.aiConfig));
            showStatus('Configuration IA sauvegard√©e!', 'success');
        }

        function saveData() {
            localStorage.setItem('varicom_data', JSON.stringify({
                products: state.products,
                newProducts: state.newProducts,
                notifications: state.notifications
            }));
            updateUI();
        }

        // Excel Handling
        function handleExcelUpload(file) {
            if (!file) return;

            showStatus('Lecture du fichier...', 'info');
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processExcelData(jsonData);
                } catch (err) {
                    showStatus('Erreur lecture Excel: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            const processed = data.map((row, idx) => ({
                id: `prod_${Date.now()}_${idx}`,
                ref: row['Ref'] || row['R√©f√©rence'] || row['Code'] || 'N/A',
                designation: row['Designation'] || row['D√©signation'] || row['Nom'] || 'Produit sans nom',
                famille: row['Famille'] || row['Categorie'] || 'G√©n√©ral',
                prix: parseFloat(row['Prix'] || row['Price'] || 0),
                image: row['Image'] || row['Photo'] || '',
                description: row['Description'] || row['Desc'] || ''
            })).filter(p => p.prix > 0);

            state.products = processed;
            saveData();
            showStatus(`${processed.length} produits import√©s avec succ√®s!`, 'success');
        }

        // Product & Notification Management
        function addNewProduct() {
            const name = document.getElementById('newProductName').value;
            const price = document.getElementById('newProductPrice').value;
            const cat = document.getElementById('newProductCategory').value;
            const img = document.getElementById('newProductImage').value;

            if (!name || !price) return showStatus('Nom et Prix requis', 'warning');

            state.newProducts.unshift({
                id: `new_${Date.now()}`,
                name,
                price: parseFloat(price),
                category: cat,
                image: img,
                timestamp: new Date().toISOString()
            });

            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            saveData();
            showStatus('Nouveau produit ajout√©', 'success');
        }

        function createNotification() {
            const title = document.getElementById('notifTitle').value;
            const msg = document.getElementById('notifMessage').value;
            const type = document.getElementById('notifType').value;

            if (!title || !msg) return showStatus('Titre et Message requis', 'warning');

            state.notifications.unshift({
                id: `notif_${Date.now()}`,
                title,
                message: msg,
                type,
                timestamp: new Date().toISOString()
            });

            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            saveData();
            showStatus('Notification cr√©√©e', 'success');
        }

        function removeNewProduct(id) {
            state.newProducts = state.newProducts.filter(p => p.id !== id);
            saveData();
        }

        function removeNotification(id) {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
        }

        // --- AI Functions ---
        async function searchAIImages() {
            const query = document.getElementById('aiSearchQuery').value;
            const sources = Array.from(document.getElementById('aiSources').selectedOptions).map(o => o.value);
            const imageType = document.getElementById('aiImageType').value;
            const filter = document.getElementById('aiFilter').value;
            
            if (!sources.length) {
                showStatus('Veuillez s√©lectionner au moins une source', 'warning');
                return;
            }

            document.getElementById('aiLoader').style.display = 'block';
            document.getElementById('aiResults').innerHTML = '';

            try {
                const results = [];
                
                // Recherche dans toutes les sources s√©lectionn√©es
                for (const source of sources) {
                    const sourceResults = await searchImageSource(source, query, imageType, filter);
                    results.push(...sourceResults);
                }

                // M√©langer les r√©sultats pour vari√©t√©
                results.sort(() => Math.random() - 0.5);
                
                displayAIResults(results.slice(0, 12)); // Limiter √† 12 r√©sultats
                
            } catch (error) {
                console.error('AI Search error:', error);
                document.getElementById('aiResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Erreur de recherche: ${error.message}
                        </div>
                    </div>
                `;
            } finally {
                document.getElementById('aiLoader').style.display = 'none';
            }
        }

        async function searchImageSource(source, query, imageType, filter) {
            switch(source) {
                case 'unsplash':
                    return await searchUnsplash(query, imageType, filter);
                case 'pixabay':
                    return await searchPixabay(query, imageType, filter);
                case 'google':
                    return await searchGoogle(query, imageType, filter);
                case 'facebook':
                    return await searchFacebook(query);
                default:
                    return [];
            }
        }

        async function searchUnsplash(query, imageType, filter) {
            const key = state.aiConfig.unsplashKey;
            if (!key) {
                throw new Error('Cl√© Unsplash non configur√©e');
            }

            let searchQuery = query;
            if (imageType === 'product') searchQuery += ' product commercial white background';
            if (imageType === 'photo') searchQuery += ' professional photo';
            
            const url = `https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchQuery)}&per_page=6&client_id=${key}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erreur Unsplash API');
            
            const data = await response.json();
            return data.results.map(img => ({
                url: img.urls.regular,
                thumb: img.urls.thumb,
                title: img.description || 'Image Unsplash',
                source: 'Unsplash',
                author: img.user.name,
                likes: img.likes,
                commercial: true
            }));
        }

        async function searchPixabay(query, imageType, filter) {
            // Note: Pixabay n√©cessite une cl√© API
            const key = ''; // √Ä configurer par l'utilisateur
            if (!key) return [];
            
            let searchQuery = query;
            if (imageType === 'product') searchQuery += ' product white background';
            
            const url = `https://pixabay.com/api/?key=${key}&q=${encodeURIComponent(searchQuery)}&image_type=photo&per_page=6`;
            
            const response = await fetch(url);
            if (!response.ok) return [];
            
            const data = await response.json();
            return data.hits.map(img => ({
                url: img.largeImageURL,
                thumb: img.previewURL,
                title: img.tags,
                source: 'Pixabay',
                author: img.user,
                likes: img.likes,
                commercial: true
            }));
        }

        async function searchGoogle(query, imageType, filter) {
            // Utilise Custom Search JSON API
            const key = state.aiConfig.googleKey;
            const cx = ''; // Search Engine ID - √† configurer
            
            if (!key || !cx) return [];
            
            let searchQuery = query;
            if (imageType === 'product') searchQuery += ' product';
            if (filter === 'commercial') searchQuery += ' commercial use';
            
            const url = `https://www.googleapis.com/customsearch/v1?q=${encodeURIComponent(searchQuery)}&cx=${cx}&key=${key}&searchType=image&num=6`;
            
            const response = await fetch(url);
            if (!response.ok) return [];
            
            const data = await response.json();
            return (data.items || []).map(img => ({
                url: img.link,
                thumb: img.image.thumbnailLink,
                title: img.title,
                source: 'Google',
                commercial: false
            }));
        }

        async function searchFacebook(query) {
            // Note: Facebook Graph API n√©cessite un token
            // Pour l'instant, retourner des r√©sultats simul√©s ou utiliser une approche diff√©rente
            return [];
        }

        function displayAIResults(results) {
            const container = document.getElementById('aiResults');
            
            if (!results.length) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Aucune image trouv√©e. Essayez avec d'autres termes.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map((img, index) => `
                <div class="col-md-4 col-sm-6">
                    <div class="ai-image-result" onclick="selectAIImage(${index})">
                        <img src="${img.thumb}" class="img-fluid w-100" style="height: 150px; object-fit: cover;">
                        <div class="p-2">
                            <small class="d-block text-truncate">${img.title}</small>
                            <small class="text-muted">
                                <i class="fas fa-${img.source === 'Unsplash' ? 'camera' : 'search'} me-1"></i>
                                ${img.source}
                                ${img.likes ? `<i class="fas fa-heart ms-2"></i> ${img.likes}` : ''}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectAIImage(index) {
            // Retirer la s√©lection pr√©c√©dente
            document.querySelectorAll('.ai-image-result').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Ajouter la nouvelle s√©lection
            const selected = document.querySelectorAll('.ai-image-result')[index];
            if (selected) {
                selected.classList.add('selected');
                state.currentAISearch.selectedImage = state.currentAISearch.searchResults[index];
            }
        }

        function setSearchTag(tag) {
            const input = document.getElementById('aiSearchQuery');
            const current = input.value.trim();
            input.value = current ? `${current} ${tag}` : tag;
        }

        // --- Bulk Functions ---
        function openBulkImageModal() {
            new bootstrap.Modal(document.getElementById('bulkImageModal')).show();
            updateBulkPreview();
        }

        function updateBulkPreview() {
            const activeTab = document.querySelector('.nav-link.active').id;

            if (activeTab === 'mode-magic-tab') {
                document.getElementById('bulkPreview').textContent = `https://tse2.mm.bing.net/th?q=Exemple...`;
            } else if (activeTab === 'mode-desc-tab') {
                document.getElementById('bulkPreview').textContent = `https://www.bing.com/search?q=fiche+technique+Exemple`;
            } else if (activeTab === 'mode-ai-tab') {
                document.getElementById('bulkPreview').textContent = `Recherche IA avec ${document.getElementById('aiSources').selectedOptions.length} sources`;
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl').value || 'https://site.com/img/';
                const field = document.getElementById('bulkField').value;
                const ext = document.getElementById('bulkExt').value;
                const example = field === 'ref' ? 'REF123' : 'Produit_Exemple';
                document.getElementById('bulkPreview').textContent = `${baseUrl}${example}${ext}`;
            }
        }

        function applyBulkActions() {
            const activeTab = document.querySelector('.nav-link.active').id;

            if (confirm(`Cela va modifier ${state.products.length} produits. Continuer?`)) {

                if (activeTab === 'mode-magic-tab') {
                    // Magic Images
                    state.products = state.products.map(p => ({
                        ...p,
                        image: `https://tse2.mm.bing.net/th?q=${encodeURIComponent(p.designation)}&w=500&h=500&c=7&rs=1&p=0`
                    }));
                } else if (activeTab === 'mode-desc-tab') {
                    // Magic Descriptions
                    state.products = state.products.map(p => ({
                        ...p,
                        description: `https://www.bing.com/search?q=fiche+technique+${encodeURIComponent(p.designation)}`
                    }));
                } else if (activeTab === 'mode-ai-tab') {
                    // AI Images - utiliser l'image s√©lectionn√©e ou la derni√®re recherche
                    if (state.currentAISearch.selectedImage) {
                        const selectedUrl = state.currentAISearch.selectedImage.url;
                        state.products = state.products.map(p => ({
                            ...p,
                            image: selectedUrl
                        }));
                        showStatus('Image IA appliqu√©e √† tous les produits', 'success');
                    } else {
                        showStatus('Veuillez d\'abord s√©lectionner une image', 'warning');
                        return;
                    }
                } else {
                    // Hosted Images
                    const baseUrl = document.getElementById('bulkBaseUrl').value;
                    const field = document.getElementById('bulkField').value;
                    const ext = document.getElementById('bulkExt').value;

                    if (!baseUrl) return alert('Veuillez entrer une URL de base');

                    state.products = state.products.map(p => {
                        const val = p[field] ? p[field].toString().trim() : '';
                        const safeVal = field === 'designation' ? val.replace(/[^a-zA-Z0-9-_]/g, '_') : val;
                        return {
                            ...p,
                            image: `${baseUrl}${safeVal}${ext}`
                        };
                    });
                }

                saveData();
                bootstrap.Modal.getInstance(document.getElementById('bulkImageModal')).hide();
                showStatus('Mise √† jour effectu√©e avec succ√®s!', 'success');
            }
        }

        // --- Single Product AI Search ---
        function openAIProductSearch(productId, designation) {
            state.currentAISearch.productId = productId;
            document.getElementById('currentProductName').textContent = `Produit: ${designation}`;
            document.getElementById('productSearchQuery').value = designation;
            
            new bootstrap.Modal(document.getElementById('aiProductSearchModal')).show();
        }

        async function searchForCurrentProduct() {
            const query = document.getElementById('productSearchQuery').value;
            if (!query) return;
            
            document.getElementById('productAiLoader').style.display = 'block';
            document.getElementById('productAiResults').innerHTML = '';
            
            try {
                // Rechercher avec Unsplash par d√©faut
                const results = await searchUnsplash(query, 'product', 'relevance');
                state.currentAISearch.searchResults = results;
                
                displayProductAIResults(results);
                
            } catch (error) {
                console.error('Product search error:', error);
                document.getElementById('productAiResults').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            Erreur: ${error.message}
                        </div>
                    </div>
                `;
            } finally {
                document.getElementById('productAiLoader').style.display = 'none';
            }
        }

        function displayProductAIResults(results) {
            const container = document.getElementById('productAiResults');
            
            container.innerHTML = results.map((img, index) => `
                <div class="col-md-6 col-sm-6">
                    <div class="ai-image-result" onclick="selectProductAIImage(${index})">
                        <img src="${img.thumb}" class="img-fluid w-100" style="height: 200px; object-fit: cover;">
                        <div class="p-2">
                            <small class="d-block text-truncate">${img.title}</small>
                            <small class="text-muted">
                                <i class="fas fa-${img.source === 'Unsplash' ? 'camera' : 'search'} me-1"></i>
                                ${img.source}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectProductAIImage(index) {
            document.querySelectorAll('#productAiResults .ai-image-result').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selected = document.querySelectorAll('#productAiResults .ai-image-result')[index];
            if (selected) {
                selected.classList.add('selected');
                state.currentAISearch.selectedImage = state.currentAISearch.searchResults[index];
            }
        }

        function applySelectedImageToProduct() {
            if (!state.currentAISearch.productId || !state.currentAISearch.selectedImage) {
                showStatus('Veuillez s√©lectionner une image', 'warning');
                return;
            }
            
            updateProductImage(state.currentAISearch.productId, state.currentAISearch.selectedImage.url);
            bootstrap.Modal.getInstance(document.getElementById('aiProductSearchModal')).hide();
            showStatus('Image appliqu√©e au produit avec succ√®s!', 'success');
        }

        function addProductSearchTag(tag) {
            const input = document.getElementById('productSearchQuery');
            const current = input.value.trim();
            input.value = current ? `${current} ${tag}` : tag;
        }

        function searchImage(term, provider) {
            const query = encodeURIComponent(term);
            let url = '';

            switch (provider) {
                case 'google': url = `https://www.google.com/search?tbm=isch&q=${query}`; break;
                case 'bing': url = `https://www.bing.com/images/search?q=${query}`; break;
                case 'unsplash': url = `https://unsplash.com/s/photos/${query}`; break;
                case 'facebook': url = `https://www.facebook.com/search/photos/?q=${query}`; break;
            }

            if (url) window.open(url, '_blank');
        }

        function updateProductImage(id, newUrl) {
            const p = state.products.find(p => p.id === id);
            if (p) {
                p.image = newUrl;
                saveData();
            }
        }

        function updateProductDesc(id, newUrl) {
            const p = state.products.find(p => p.id === id);
            if (p) {
                p.description = newUrl;
                saveData();
            }
        }

        // GitHub Sync
        async function uploadToGitHubGist() {
            const token = document.getElementById('githubToken').value;
            if (!token) return showStatus('Token GitHub manquant!', 'error');

            if (state.products.length === 0 && state.newProducts.length === 0) {
                return showStatus('Aucun produit √† publier! Veuillez importer des donn√©es.', 'warning');
            }

            const btn = document.getElementById('publishBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            btn.disabled = true;

            const payload = {
                description: "VARICOM Catalog Data",
                public: true,
                files: {
                    "varicom_data.json": {
                        content: JSON.stringify({
                            products: state.products,
                            newProducts: state.newProducts,
                            notifications: state.notifications,
                            lastUpdate: new Date().toISOString(),
                            meta: { version: "2.0", source: "VaricomAdmin" }
                        })
                    }
                }
            };

            try {
                let url = 'https://api.github.com/gists';
                let method = 'POST';

                if (state.gistId) {
                    url += `/${state.gistId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 404 && state.gistId) {
                        state.gistId = null;
                        return uploadToGitHubGist();
                    }
                    throw new Error(`Erreur GitHub: ${response.status}`);
                }

                const result = await response.json();
                state.gistId = result.id;
                state.lastSync = new Date().toISOString();

                localStorage.setItem('varicom_gist_id', state.gistId);
                localStorage.setItem('varicom_last_sync', state.lastSync);

                showStatus('‚úÖ Synchronisation r√©ussie! Donn√©es publi√©es.', 'success');
                updateUI();

            } catch (err) {
                console.error(err);
                showStatus('Erreur Sync: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // UI Updates
        function updateUI() {
            // Stats
            document.getElementById('statsProducts').textContent = state.products.length;
            document.getElementById('statsNewProducts').textContent = state.newProducts.length;
            document.getElementById('statsNotifications').textContent = state.notifications.length;
            document.getElementById('statsStatus').textContent = state.gistId ? 'Actif' : 'Inactif';
            document.getElementById('statsStatus').className = state.gistId ? 'text-success' : 'text-danger';

            // Helper functions for escaping
            const escapeHtml = (str) => str ? str.toString().replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
            const escapeJs = (str) => str ? str.toString().replace(/'/g, "\\'") : '';

            // Lists
            const npList = document.getElementById('activeNewProducts');
            npList.innerHTML = state.newProducts.map(p => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><strong>${escapeHtml(p.name)}</strong> - ${p.price} DA</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNewProduct('${escapeJs(p.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');

            const notifList = document.getElementById('activeNotifications');
            notifList.innerHTML = state.notifications.map(n => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div><span class="badge bg-${getBadgeClass(n.type)}">${n.type}</span> ${escapeHtml(n.title)}</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNotification('${escapeJs(n.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');

            // Catalog Table
            const tableBody = document.getElementById('catalogTableBody');
            tableBody.innerHTML = state.products.slice(0, 100).map(p => `
                <tr>
                    <td><small>${escapeHtml(p.ref)}</small></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${escapeHtml(p.designation)}">${escapeHtml(p.designation)}</td>
                    <td>${p.prix}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${escapeHtml(p.image || '')}" 
                               onchange="updateProductImage('${escapeJs(p.id)}', this.value)"
                               placeholder="URL Image...">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${escapeHtml(p.description || '')}" 
                               onchange="updateProductDesc('${escapeJs(p.id)}', this.value)"
                               placeholder="URL Desc...">
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="searchImage('${escapeJs(p.designation)}', 'google')" title="Google">
                                <i class="fab fa-google"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="searchImage('${escapeJs(p.designation)}', 'bing')" title="Bing">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="openAIProductSearch('${escapeJs(p.id)}', '${escapeJs(p.designation)}')" title="Recherche IA">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="searchImage('${escapeJs(p.designation)}', 'unsplash')" title="Unsplash">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getBadgeClass(type) {
            switch (type) {
                case 'info': return 'info';
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                default: return 'secondary';
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('syncStatus');
            el.textContent = msg;
            el.className = 'sync-status';
            el.classList.add(type === 'success' ? 'sync-success' : type === 'warning' ? 'sync-warning' : 'sync-error');
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function generateClientLink() {
            if (!state.gistId) return showStatus('Veuillez d\'abord publier le catalogue', 'warning');

            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            const clientUrl = `${baseUrl}index.html?gist=${state.gistId}`;

            navigator.clipboard.writeText(clientUrl).then(() => {
                showStatus('‚úÖ Lien client copi√©!', 'success');
            }).catch(() => {
                prompt('Copiez ce lien manuellement:', clientUrl);
                showStatus('Lien pr√™t √† √™tre copi√©', 'info');
            });
        }

        function toggleToken() {
            const input = document.getElementById('githubToken');
            const icon = input.parentNode.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function toggleUnsplashKey() {
            const input = document.getElementById('unsplashKey');
            const icon = input.parentNode.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function toggleGoogleKey() {
            const input = document.getElementById('googleKey');
            const icon = input.parentNode.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function resetSync() {
            if (confirm('Voulez-vous vraiment r√©initialiser la synchronisation? Cela d√©connectera le catalogue actuel.')) {
                localStorage.removeItem('varicom_gist_id');
                localStorage.removeItem('varicom_last_sync');
                state.gistId = null;
                state.lastSync = null;
                updateUI();
                showStatus('Synchronisation r√©initialis√©e', 'info');
            }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([
                { Ref: 'REF001', Designation: 'Exemple Produit', Famille: 'Informatique', Prix: 1000, Image: '', Description: '' }
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Modele");
            XLSX.writeFile(wb, "modele_import_varicom.xlsx");
        }

        function testAIAPI() {
            const unsplashKey = document.getElementById('unsplashKey').value;
            if (unsplashKey) {
                fetch(`https://api.unsplash.com/photos/random?client_id=${unsplashKey}`)
                    .then(response => {
                        if (response.ok) {
                            showStatus('‚úÖ API Unsplash fonctionne!', 'success');
                        } else {
                            showStatus('‚ùå API Unsplash √©chou√©e', 'error');
                        }
                    })
                    .catch(() => showStatus('‚ùå Erreur de connexion', 'error'));
            } else {
                showStatus('Veuillez entrer une cl√© API', 'warning');
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
