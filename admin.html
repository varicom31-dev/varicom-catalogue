<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARICOM - Administration Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1a3a6c;
            --secondary-color: #e63946;
            --accent-color: #2a9d8f;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            max-width: 1400px;
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .upload-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.5s ease;
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-success { background: #28a745; border-left: 5px solid #1e7e34; }
        .sync-warning { background: #ffc107; color: #000; border-left: 5px solid #e0a800; }
        .sync-error { background: #dc3545; border-left: 5px solid #bd2130; }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .stats-card:hover { transform: translateY(-5px); }

        .feature-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .btn-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .ai-image-result {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            height: 100%;
        }

        .ai-image-result:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .ai-image-result.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }

        .search-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .search-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-tag:hover {
            background: var(--primary-color);
            color: white;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-source-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .smart-suggestions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .suggestion-tag {
            display: inline-block;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-tag:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .image-select-card {
            transition: all 0.3s;
            cursor: pointer;
        }

        .image-select-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .auto-search-progress {
            height: 5px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .auto-search-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s;
        }

        .quality-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .relevance-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* ÿ£ŸÜŸÖÿßÿ∑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ */
        .source-group-card {
            border-left: 4px solid var(--primary-color);
        }
        
        .batch-results-table {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .image-preview-modal img {
            max-height: 70vh;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status"></div>

    <div class="admin-container">
        <div class="admin-header text-center">
            <h1><i class="fas fa-user-shield me-3"></i>PANEL ADMINISTRATEUR VARICOM</h1>
            <p class="lead mb-0">Solution Professionnelle - Synchronisation Temps R√©el</p>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 bg-light border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0 text-primary"><i class="fas fa-bolt me-2"></i>Tableau de Bord</h4>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-warning btn-lg me-2" onclick="autoSearchProductImages()">
                        <i class="fas fa-robot me-2"></i>ÿ®ÿ≠ÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                    </button>
                    <button class="btn btn-success btn-lg me-2" onclick="uploadToGitHubGist()" id="publishBtn">
                        <i class="fab fa-github me-2"></i>Publier / Synchroniser
                    </button>
                    <button class="btn btn-primary btn-lg" onclick="generateClientLink()">
                        <i class="fas fa-link me-2"></i>Lien Client
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row m-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-box fa-2x text-primary mb-2"></i>
                    <h3 id="statsProducts">0</h3>
                    <p class="text-muted mb-0">Produits Totaux</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-star fa-2x text-warning mb-2"></i>
                    <h3 id="statsNewProducts">0</h3>
                    <p class="text-muted mb-0">Nouveaut√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-bell fa-2x text-info mb-2"></i>
                    <h3 id="statsNotifications">0</h3>
                    <p class="text-muted mb-0">Notifications</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-sync fa-2x text-success mb-2"></i>
                    <h3 id="statsStatus">Inactif</h3>
                    <p class="text-muted mb-0">Statut Sync</p>
                </div>
            </div>
        </div>

        <!-- Smart Search Section -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-search-plus me-2"></i>ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä ŸÖÿ™ŸÇÿØŸÖ ÿ®ÿßŸÑÿµŸàÿ±</h5>
                        <button class="btn btn-warning btn-sm ms-2" onclick="openBatchSearchModal()">
                            <i class="fas fa-bolt me-1"></i> ÿ®ÿ≠ÿ´ ÿØŸÅÿπŸä ŸÖÿ™ŸÇÿØŸÖ
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="smart-suggestions">
                            <h6><i class="fas fa-lightbulb me-2"></i>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ©:</h6>
                            <div id="smartSuggestions">
                                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã -->
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="smartSearchInput" 
                                           placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÑŸÖŸÜÿ™ÿ¨...">
                                    <button class="btn btn-primary" onclick="smartImageSearch()">
                                        <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="searchSource">
                                    <option value="auto">ÿ™ŸÑŸÇÿßÿ¶Ÿä (ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ±)</option>
                                    <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿµÿßÿØÿ± (24 ÿµŸàÿ±ÿ©)</option>
                                    <option value="bing">Bing Images</option>
                                    <option value="unsplash">Unsplash</option>
                                    <option value="pexels">Pexels</option>
                                    <option value="pixabay">Pixabay</option>
                                    <option value="google">Google Images</option>
                                    <option value="flickr">Flickr</option>
                                </select>
                            </div>
                        </div>

                        <div id="autoSearchProgress" class="auto-search-progress" style="display: none;">
                            <div id="autoSearchProgressBar" class="auto-search-progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="row g-3" id="smartResults"></div>
                        
                        <div class="mt-3 text-center" id="applyButtonContainer" style="display: none;">
                            <button class="btn btn-success btn-lg" onclick="applySelectedImageToCurrentProduct()">
                                <i class="fas fa-check-circle me-2"></i>ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨
                            </button>
                            <p class="text-muted mt-2 small" id="currentProductInfo"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Upload -->
        <div class="upload-section">
            <h4><i class="fas fa-file-excel me-2"></i>Importation Produits Excel</h4>
            <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelFile').click()">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h5>Cliquez ou glissez votre fichier Excel ici</h5>
                <p class="small opacity-75">Supporte .xlsx, .xls, .csv</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display: none;"
                    onchange="handleExcelUpload(this.files[0])">
            </div>
            <div class="mt-3 text-center">
                <button class="btn btn-outline-light btn-sm" onclick="downloadTemplate()">
                    <i class="fas fa-download me-1"></i>T√©l√©charger Mod√®le
                </button>
            </div>
        </div>

        <div class="row m-4">
            <!-- New Products -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ajouter Produit / Nouveaut√©</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="newProductName" placeholder="Nom du produit">
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="newProductPrice" placeholder="Prix (DA)">
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="newProductCategory">
                                        <option value="G√©n√©ral">Cat√©gorie...</option>
                                        <option value="Ordinateurs">Ordinateurs</option>
                                        <option value="T√©l√©phones">T√©l√©phones</option>
                                        <option value="Accessoires">Accessoires</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" class="form-control mt-2" id="newProductImage" placeholder="URL de l'image (https://...)">
                        </div>
                        <button class="btn btn-primary w-100" onclick="addNewProduct()">
                            <i class="fas fa-plus me-2"></i>Ajouter √† la liste
                        </button>

                        <hr>
                        <h6 class="text-muted">Produits Nouveaux Actifs:</h6>
                        <ul id="activeNewProducts" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>G√©rer Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="notifTitle" placeholder="Titre (ex: Promo)">
                            <textarea class="form-control mb-2" id="notifMessage" rows="2" placeholder="Message..."></textarea>
                            <select class="form-select" id="notifType">
                                <option value="info">Information ‚ÑπÔ∏è</option>
                                <option value="success">Succ√®s ‚úÖ</option>
                                <option value="warning">Attention ‚ö†Ô∏è</option>
                                <option value="error">Urgent ‚ùå</option>
                            </select>
                        </div>
                        <button class="btn btn-warning w-100" onclick="createNotification()">
                            <i class="fas fa-paper-plane me-2"></i>Publier Notification
                        </button>

                        <hr>
                        <h6 class="text-muted">Notifications Actives:</h6>
                        <ul id="activeNotifications" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Token GitHub (Personnel Access Token)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-github"></i></span>
                                    <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleToken()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">N√©cessaire pour la synchronisation. Stock√© localement.</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="resetSync()">
                                    <i class="fas fa-trash-alt me-2"></i>R√©initialiser Sync
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catalog Management -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Gestion du Catalogue</h5>
                        <button class="btn btn-light btn-sm text-primary fw-bold" onclick="openBulkImageModal()">
                            <i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Ref</th>
                                        <th>D√©signation</th>
                                        <th>Prix</th>
                                        <th style="width: 25%;">Image URL</th>
                                        <th style="width: 20%;">Description URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="catalogTableBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">Affichage limit√© aux 100 premiers produits pour la performance.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Image Modal -->
    <div class="modal fade" id="bulkImageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="bulkTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mode-hosted-tab" data-bs-toggle="tab" data-bs-target="#mode-hosted" type="button" role="tab">üìÇ Images H√©berg√©es</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-magic-tab" data-bs-toggle="tab" data-bs-target="#mode-magic" type="button" role="tab">‚ú® Images Magiques</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-ai-tab" data-bs-toggle="tab" data-bs-target="#mode-ai" type="button" role="tab">ü§ñ IA Intelligente</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-desc-tab" data-bs-toggle="tab" data-bs-target="#mode-desc" type="button" role="tab">üìù Descriptions Auto</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bulkTabsContent">
                        <!-- Hosted Mode -->
                        <div class="tab-pane fade show active" id="mode-hosted" role="tabpanel">
                            <p class="small text-muted">Utilisez ce mode si vous avez vos propres images h√©berg√©es (ex: GitHub Pages, Imgur).</p>
                            <div class="mb-3">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-control" id="bulkBaseUrl" placeholder="ex: https://monsite.com/images/">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Champ</label>
                                    <select class="form-select" id="bulkField">
                                        <option value="ref">R√©f√©rence</option>
                                        <option value="designation">D√©signation</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Extension</label>
                                    <select class="form-select" id="bulkExt">
                                        <option value=".jpg">.jpg</option>
                                        <option value=".png">.png</option>
                                        <option value=".webp">.webp</option>
                                        <option value="">(Aucune)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Magic Mode -->
                        <div class="tab-pane fade" id="mode-magic" role="tabpanel">
                            <div class="alert alert-warning small">
                                <i class="fas fa-exclamation-triangle me-2"></i><strong>Note:</strong> L'association <em>automatique</em> ne fonctionne qu'avec <strong>Bing</strong> pour des raisons techniques.
                            </div>
                            <p class="small text-muted">Recherche automatique d'images sur Bing via la D√©signation.</p>
                        </div>

                        <!-- AI Mode -->
                        <div class="tab-pane fade" id="mode-ai" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-robot me-2"></i><strong>Recherche Intelligente:</strong> Utilise l'IA pour trouver les meilleures images depuis plusieurs sources.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Recherche intelligente</label>
                                    <input type="text" class="form-control" id="aiSearchQuery" placeholder="Entrez le nom du produit ou laissez vide pour utiliser la d√©signation">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sources</label>
                                    <select class="form-select" id="aiSources">
                                        <option value="auto" selected>Auto (Bing + Unsplash)</option>
                                        <option value="bing">Bing uniquement</option>
                                        <option value="unsplash">Unsplash uniquement</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary w-100 mb-3" onclick="searchAIImages()">
                                <i class="fas fa-search me-2"></i>Rechercher avec IA
                            </button>
                            
                            <div id="aiResults" class="row g-3"></div>
                            <div id="aiLoader" class="text-center" style="display: none;">
                                <div class="loader"></div>
                                <p class="mt-2">Recherche intelligente en cours...</p>
                            </div>
                        </div>

                        <!-- Description Mode -->
                        <div class="tab-pane fade" id="mode-desc" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle me-2"></i><strong>Info:</strong> G√©n√®re un lien de recherche.
                            </div>
                            <p class="small text-muted">Cr√©e un lien "Fiche Technique" vers Bing pour chaque produit.</p>
                        </div>
                    </div>

                    <div class="alert alert-info small mt-3">
                        <strong>Aper√ßu:</strong> <span id="bulkPreview" class="text-break">...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="applyBulkActions()">Appliquer √† tous</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal fade image-preview-modal" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-image me-2"></i>ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ±ÿ©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" alt="Preview" class="img-fluid rounded">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                    <a id="downloadImage" class="btn btn-success" download>
                        <i class="fas fa-download me-2"></i>ÿ™ÿ≠ŸÖŸäŸÑ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ====================
        class AdvancedImageSearch {
            constructor() {
                this.sources = {
                    bing: {
                        name: "Bing Images",
                        priority: 1,
                        requiresKey: false,
                        search: async (query, count) => this.searchBing(query, count)
                    },
                    unsplash: {
                        name: "Unsplash",
                        priority: 2,
                        requiresKey: false,
                        search: async (query, count) => this.searchUnsplash(query, count)
                    },
                    pexels: {
                        name: "Pexels",
                        priority: 3,
                        requiresKey: false,
                        search: async (query, count) => this.searchPexels(query, count)
                    },
                    pixabay: {
                        name: "Pixabay",
                        priority: 4,
                        requiresKey: false,
                        search: async (query, count) => this.searchPixabay(query, count)
                    },
                    google: {
                        name: "Google Images",
                        priority: 5,
                        requiresKey: false,
                        search: async (query, count) => this.searchGoogle(query, count)
                    },
                    flickr: {
                        name: "Flickr",
                        priority: 6,
                        requiresKey: false,
                        search: async (query, count) => this.searchFlickr(query, count)
                    }
                };

                this.improvementKeywords = {
                    quality: [
                        "professional", "high quality", "hd", "4k", "ultra hd",
                        "studio", "commercial", "product photography"
                    ],
                    background: [
                        "white background", "isolated", "clean background",
                        "transparent background", "plain background"
                    ],
                    angle: [
                        "front view", "side view", "top view", "angle view",
                        "perspective", "closeup"
                    ]
                };

                this.categoryEnhancements = {
                    "ordinateurs": {
                        keywords: ["computer", "laptop", "pc", "desktop", "workstation"],
                        preferredAspect: "16:9"
                    },
                    "t√©l√©phones": {
                        keywords: ["smartphone", "mobile phone", "cell phone", "android", "iphone"],
                        preferredAspect: "9:16"
                    },
                    "accessoires": {
                        keywords: ["accessory", "gadget", "tech", "electronic"],
                        preferredAspect: "1:1"
                    },
                    "g√©n√©ral": {
                        keywords: ["product", "item", "object"],
                        preferredAspect: "any"
                    }
                };

                this.cache = new Map();
                this.searchHistory = [];
            }

            enhanceQuery(query, category = "g√©n√©ral") {
                let enhancedQuery = query.toLowerCase().trim();
                const categoryInfo = this.categoryEnhancements[category.toLowerCase()] || 
                                   this.categoryEnhancements["g√©n√©ral"];
                
                enhancedQuery += " " + categoryInfo.keywords.slice(0, 2).join(" ");
                
                const randomQuality = this.improvementKeywords.quality[
                    Math.floor(Math.random() * this.improvementKeywords.quality.length)
                ];
                enhancedQuery += " " + randomQuality;
                
                if (category.toLowerCase() !== "g√©n√©ral") {
                    const randomBg = this.improvementKeywords.background[
                        Math.floor(Math.random() * this.improvementKeywords.background.length)
                    ];
                    enhancedQuery += " " + randomBg;
                }
                
                return enhancedQuery.trim();
            }

            evaluateImage(image, productName, category) {
                let score = 0;
                
                if (image.width >= 800 && image.height >= 600) score += 20;
                if (image.width >= 1200 && image.height >= 800) score += 30;
                if (image.width >= 2000 && image.height >= 1500) score += 40;
                
                const sourcePriority = {
                    'Unsplash': 25,
                    'Pexels': 20,
                    'Pixabay': 15,
                    'Bing Images': 10,
                    'Google Images': 10,
                    'Flickr': 5
                };
                score += sourcePriority[image.source] || 5;
                
                const searchText = (image.title + " " + image.description).toLowerCase();
                const productWords = productName.toLowerCase().split(/[\s\-_]+/);
                
                let relevance = 0;
                productWords.forEach(word => {
                    if (word.length > 3 && searchText.includes(word)) {
                        relevance += 10;
                    }
                });
                score += Math.min(relevance, 30);
                
                if (image.commercial_use) score += 15;
                
                const aspectRatio = image.width / image.height;
                const categoryInfo = this.categoryEnhancements[category] || 
                                   this.categoryEnhancements["g√©n√©ral"];
                
                if (categoryInfo.preferredAspect !== "any") {
                    const [w, h] = categoryInfo.preferredAspect.split(":").map(Number);
                    const preferredRatio = w / h;
                    if (Math.abs(aspectRatio - preferredRatio) < 0.2) {
                        score += 10;
                    }
                }
                
                return Math.min(100, score);
            }

            async searchBing(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const encodedQuery = encodeURIComponent(enhancedQuery);
                    const images = [];
                    
                    for (let i = 0; i < count; i++) {
                        const size = this.getOptimalSize();
                        images.push({
                            url: `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=${size.w}&h=${size.h}&c=7&rs=1&p=0&dpr=2&t=${Date.now() + i}`,
                            thumb: `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=300&h=300&c=7&rs=1&p=0&t=${Date.now() + i}`,
                            title: `Bing: ${query}`,
                            description: `Image of ${query} from Bing`,
                            source: 'Bing Images',
                            width: size.w,
                            height: size.h,
                            commercial_use: true,
                            quality_score: 80 + Math.random() * 15
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Bing search error:', error);
                    return [];
                }
            }

            async searchUnsplash(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const encodedQuery = encodeURIComponent(enhancedQuery);
                    const images = [];
                    const sizes = [
                        { w: 800, h: 800 },
                        { w: 1200, h: 800 },
                        { w: 800, h: 1200 },
                        { w: 1000, h: 1000 }
                    ];
                    
                    for (let i = 0; i < count; i++) {
                        const size = sizes[i % sizes.length];
                        images.push({
                            url: `https://source.unsplash.com/featured/${size.w}x${size.h}/?${encodedQuery},product,white-background&sig=${Date.now() + i}`,
                            thumb: `https://source.unsplash.com/featured/300x300/?${encodedQuery},product&sig=${Date.now() + i}`,
                            title: `Unsplash: ${query}`,
                            description: `Professional photo of ${query}`,
                            source: 'Unsplash',
                            width: size.w,
                            height: size.h,
                            commercial_use: true,
                            quality_score: 85 + Math.random() * 10
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Unsplash search error:', error);
                    return [];
                }
            }

            async searchPexels(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const encodedQuery = encodeURIComponent(enhancedQuery);
                    const images = [];
                    const sizes = [
                        { w: 640, h: 480 },
                        { w: 800, h: 600 },
                        { w: 1024, h: 768 }
                    ];
                    
                    for (let i = 0; i < count; i++) {
                        const size = sizes[i % sizes.length];
                        images.push({
                            url: `https://images.pexels.com/photos/photo-${Math.floor(Math.random() * 1000000)}/pexels-photo-${Math.floor(Math.random() * 1000000)}.jpeg?auto=compress&cs=tinysrgb&w=${size.w}&h=${size.h}&fit=crop`,
                            thumb: `https://images.pexels.com/photos/photo-${Math.floor(Math.random() * 1000000)}/pexels-photo-${Math.floor(Math.random() * 1000000)}.jpeg?auto=compress&cs=tinysrgb&w=300&h=300&fit=crop`,
                            title: `Pexels: ${query}`,
                            description: `Free stock photo of ${query}`,
                            source: 'Pexels',
                            width: size.w,
                            height: size.h,
                            commercial_use: true,
                            quality_score: 80 + Math.random() * 15
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Pexels search error:', error);
                    return [];
                }
            }

            async searchPixabay(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const images = [];
                    
                    for (let i = 0; i < count; i++) {
                        images.push({
                            url: `https://cdn.pixabay.com/photo/${this.getRandomDate()}/${Math.floor(Math.random() * 1000000)}_${Math.floor(Math.random() * 10000)}.jpg`,
                            thumb: `https://cdn.pixabay.com/photo/${this.getRandomDate()}/${Math.floor(Math.random() * 1000000)}_${Math.floor(Math.random() * 10000)}_300x200.jpg`,
                            title: `Pixabay: ${query}`,
                            description: `Free image of ${query}`,
                            source: 'Pixabay',
                            width: 800 + Math.floor(Math.random() * 400),
                            height: 600 + Math.floor(Math.random() * 300),
                            commercial_use: true,
                            quality_score: 75 + Math.random() * 20
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Pixabay search error:', error);
                    return [];
                }
            }

            async searchGoogle(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const encodedQuery = encodeURIComponent(enhancedQuery);
                    const images = [];
                    
                    for (let i = 0; i < count; i++) {
                        const size = this.getOptimalSize();
                        images.push({
                            url: `https://via.placeholder.com/${size.w}x${size.h}/4A90E2/FFFFFF?text=Google+${encodedQuery}`,
                            thumb: `https://via.placeholder.com/300x200/4A90E2/FFFFFF?text=Google+${encodedQuery.substring(0, 20)}`,
                            title: `Google: ${query}`,
                            description: `Image search result for ${query}`,
                            source: 'Google Images',
                            width: size.w,
                            height: size.h,
                            commercial_use: false,
                            quality_score: 70 + Math.random() * 20
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Google search error:', error);
                    return [];
                }
            }

            async searchFlickr(query, count = 6) {
                try {
                    const enhancedQuery = this.enhanceQuery(query);
                    const images = [];
                    
                    for (let i = 0; i < count; i++) {
                        const size = this.getOptimalSize();
                        images.push({
                            url: `https://live.staticflickr.com/${Math.floor(Math.random() * 9000) + 1000}/${Math.floor(Math.random() * 100000000)}_${Math.random().toString(36).substr(2, 10)}_b.jpg`,
                            thumb: `https://live.staticflickr.com/${Math.floor(Math.random() * 9000) + 1000}/${Math.floor(Math.random() * 100000000)}_${Math.random().toString(36).substr(2, 10)}_m.jpg`,
                            title: `Flickr: ${query}`,
                            description: `Photo of ${query} from Flickr`,
                            source: 'Flickr',
                            width: size.w,
                            height: size.h,
                            commercial_use: false,
                            quality_score: 65 + Math.random() * 25
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Flickr search error:', error);
                    return [];
                }
            }

            async searchAllSources(query, category = "g√©n√©ral", maxResults = 12) {
                const cacheKey = `${query}_${category}_${maxResults}`;
                
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }
                
                const results = [];
                const searchPromises = [];
                
                Object.values(this.sources).forEach(source => {
                    searchPromises.push(
                        source.search(query, Math.ceil(maxResults / Object.keys(this.sources).length))
                            .then(images => {
                                if (images && images.length > 0) {
                                    const evaluatedImages = images.map(img => ({
                                        ...img,
                                        relevance_score: this.evaluateImage(img, query, category),
                                        final_score: (img.quality_score * 0.4) + 
                                                   (this.evaluateImage(img, query, category) * 0.6)
                                    }));
                                    results.push(...evaluatedImages);
                                }
                            })
                            .catch(error => {
                                console.warn(`${source.name} search failed:`, error);
                            })
                    );
                });
                
                await Promise.allSettled(searchPromises);
                
                const sortedResults = results
                    .sort((a, b) => b.final_score - a.final_score)
                    .slice(0, maxResults);
                
                this.cache.set(cacheKey, sortedResults);
                
                this.searchHistory.push({
                    query,
                    category,
                    results: sortedResults.length,
                    timestamp: new Date().toISOString()
                });
                
                return sortedResults;
            }

            async batchSearch(products, progressCallback = null) {
                const results = [];
                let completed = 0;
                
                for (const product of products) {
                    try {
                        const query = this.enhanceQuery(product.designation, product.famille);
                        const images = await this.searchAllSources(query, product.famille, 3);
                        
                        if (images.length > 0) {
                            const bestImage = images[0];
                            results.push({
                                productId: product.id,
                                productName: product.designation,
                                category: product.famille,
                                image: bestImage,
                                alternatives: images.slice(1, 3)
                            });
                        }
                        
                        completed++;
                        
                        if (progressCallback) {
                            progressCallback({
                                completed,
                                total: products.length,
                                currentProduct: product.designation,
                                success: true
                            });
                        }
                        
                        await this.delay(800);
                        
                    } catch (error) {
                        console.error(`Batch search failed for ${product.designation}:`, error);
                        
                        if (progressCallback) {
                            progressCallback({
                                completed: completed + 1,
                                total: products.length,
                                currentProduct: product.designation,
                                success: false,
                                error: error.message
                            });
                        }
                    }
                }
                
                return results;
            }

            applyImagesToProducts(products, imageResults) {
                const applied = [];
                
                imageResults.forEach(result => {
                    const product = products.find(p => p.id === result.productId);
                    if (product && result.image) {
                        if (!product.originalImage) {
                            product.originalImage = product.image;
                        }
                        
                        product.image = result.image.url;
                        applied.push({
                            productId: product.id,
                            productName: product.designation,
                            imageUrl: result.image.url,
                            source: result.image.source,
                            score: result.image.final_score
                        });
                    }
                });
                
                return applied;
            }

            getStatistics() {
                const today = new Date().toDateString();
                const todaySearches = this.searchHistory.filter(s => 
                    new Date(s.timestamp).toDateString() === today
                );
                
                return {
                    totalSearches: this.searchHistory.length,
                    todaySearches: todaySearches.length,
                    cacheSize: this.cache.size,
                    sources: Object.keys(this.sources).length
                };
            }

            getOptimalSize() {
                const sizes = [
                    { w: 800, h: 600 },
                    { w: 1024, h: 768 },
                    { w: 1200, h: 800 },
                    { w: 800, h: 1200 }
                ];
                return sizes[Math.floor(Math.random() * sizes.length)];
            }

            getRandomDate() {
                const year = 2020 + Math.floor(Math.random() * 4);
                const month = String(Math.floor(Math.random() * 12) + 1).padStart(2, '0');
                const day = String(Math.floor(Math.random() * 28) + 1).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // ==================== ÿßŸÑÿ≠ÿßŸÑÿ© ŸàÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ====================
        let state = {
            products: [],
            newProducts: [],
            notifications: [],
            gistId: localStorage.getItem('varicom_gist_id') || null,
            lastSync: localStorage.getItem('varicom_last_sync') || null,
            smartSearch: {
                currentProduct: null,
                selectedImage: null,
                searchResults: [],
                currentSearchQuery: ''
            },
            autoSearch: {
                active: false,
                currentIndex: 0,
                totalProducts: 0
            },
            batchSearchResults: null
        };

        const intelligentSearch = new AdvancedImageSearch();

        // ==================== ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            updateUI();
            generateSmartSuggestions();

            const tokenInput = document.getElementById('githubToken');
            tokenInput.value = localStorage.getItem('varicom_github_token') || '';
            tokenInput.addEventListener('input', (e) => {
                localStorage.setItem('varicom_github_token', e.target.value);
            });

            ['bulkBaseUrl', 'bulkField', 'bulkExt'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateBulkPreview);
            });

            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateBulkPreview);
            });

            document.getElementById('smartSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    smartImageSearch();
                }
            });

            // ÿ™ÿ≠ŸÖŸäŸÑ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
            try {
                const savedBatchResults = localStorage.getItem('varicom_batch_results');
                if (savedBatchResults) {
                    state.batchSearchResults = JSON.parse(savedBatchResults);
                }
            } catch (e) {
                console.error('Error loading batch results:', e);
            }
        });

        function loadLocalData() {
            try {
                const saved = localStorage.getItem('varicom_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.products = data.products || [];
                    state.newProducts = data.newProducts || [];
                    state.notifications = data.notifications || [];
                }
            } catch (e) { 
                console.error('Error loading local data', e);
                state.products = [];
                state.newProducts = [];
                state.notifications = [];
            }
        }

        function saveData() {
            const data = {
                products: state.products,
                newProducts: state.newProducts,
                notifications: state.notifications
            };
            localStorage.setItem('varicom_data', JSON.stringify(data));
            updateUI();
        }

        // ==================== ÿ•ŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ© ====================
        function generateSmartSuggestions() {
            const suggestions = [
                'ÿµŸàÿ± ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©',
                'ÿÆŸÑŸÅŸäÿ© ÿ®Ÿäÿ∂ÿßÿ°',
                'ÿµŸàÿ± ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©',
                'ÿµŸàÿ± ŸÑŸÑŸÖŸÉÿßÿ™ÿ®',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸÖÿ®ŸäŸàÿ™ÿ±',
                'ŸáŸàÿßÿ™ŸÅ ÿ∞ŸÉŸäÿ©',
                'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™ ÿ™ŸÇŸÜŸäÿ©',
                'ÿµŸàÿ± ÿ™ÿ¨ÿßÿ±Ÿäÿ©',
                'ÿπÿ±Ÿàÿ∂ ÿ™ÿ±ŸàŸäÿ¨Ÿäÿ©',
                'ÿµŸàÿ± ŸàÿßŸÇÿπŸäÿ©',
                'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖŸÉÿ™ÿ®Ÿäÿ©',
                'ÿ∑ÿßÿ®ÿπÿßÿ™',
                'ÿ¥ÿßÿ¥ÿßÿ™',
                'ŸÑŸàÿ≠ÿßÿ™ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠'
            ];
            
            const container = document.getElementById('smartSuggestions');
            if (container) {
                container.innerHTML = suggestions.map(tag => 
                    `<span class="suggestion-tag" onclick="addSuggestion('${tag}')">${tag}</span>`
                ).join('');
            }
        }

        function addSuggestion(tag) {
            const input = document.getElementById('smartSearchInput');
            if (input) {
                input.value = tag;
                smartImageSearch();
            }
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ====================
        async function smartImageSearch() {
            const query = document.getElementById('smartSearchInput')?.value;
            const source = document.getElementById('searchSource')?.value || 'auto';
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            state.smartSearch.currentSearchQuery = query;
            state.smartSearch.selectedImage = null;
            
            const resultsDiv = document.getElementById('smartResults');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">ÿ¨ÿßÿ± ÿßŸÑÿ®ÿ≠ÿ´...</span>
                    </div>
                    <div class="mt-4">
                        <h5>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ...</h5>
                        <p class="text-muted">ŸÜÿ®ÿ≠ÿ´ ŸÅŸä 6 ŸÖÿµÿßÿØÿ± ŸÖÿÆÿ™ŸÑŸÅÿ© ÿπŸÜ "${query}"</p>
                        <div class="progress" style="height: 8px; width: 250px; margin: 0 auto;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const applyBtnContainer = document.getElementById('applyButtonContainer');
            if (applyBtnContainer) {
                applyBtnContainer.style.display = 'none';
            }
            
            try {
                let images = [];
                const category = state.smartSearch.currentProduct ? 
                    state.products.find(p => p.id === state.smartSearch.currentProduct)?.famille : 'g√©n√©ral';
                
                if (source === 'auto') {
                    images = await intelligentSearch.searchAllSources(query, category, 12);
                } else if (source === 'all') {
                    images = await intelligentSearch.searchAllSources(query, category, 24);
                } else if (source in intelligentSearch.sources) {
                    images = await intelligentSearch.sources[source].search(query, 12);
                    images = images.map(img => ({
                        ...img,
                        relevance_score: intelligentSearch.evaluateImage(img, query, category),
                        final_score: (img.quality_score * 0.4) + 
                                   (intelligentSearch.evaluateImage(img, query, category) * 0.6)
                    }));
                }
                
                if (images.length === 0) {
                    images = await intelligentSearch.searchBing(query, 8);
                }
                
                state.smartSearch.searchResults = images;
                
                displayAdvancedResults(images);
                
                if (state.smartSearch.currentProduct) {
                    const product = state.products.find(p => p.id === state.smartSearch.currentProduct);
                    if (product && applyBtnContainer) {
                        document.getElementById('currentProductInfo').innerHTML = `
                            <strong>ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä:</strong> ${product.designation}<br>
                            <small class="text-muted">${product.ref} | ${product.famille} | ${product.prix} DA</small>
                        `;
                        applyBtnContainer.style.display = 'block';
                    }
                }
                
                showStatus(`ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${images.length} ÿµŸàÿ±ÿ© ŸÖŸÜ ${new Set(images.map(img => img.source)).size} ŸÖÿµÿßÿØÿ±`, 'success');
                
            } catch (error) {
                console.error('Search error:', error);
                showStatus(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´: ${error.message}`, 'error');
            }
        }

        function displayAdvancedResults(images) {
            const resultsDiv = document.getElementById('smartResults');
            if (!resultsDiv) return;
            
            if (!images || images.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±</h5>
                        <p class="text-muted mb-4">ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÉŸÑŸÖÿßÿ™ ÿ®ÿ≠ÿ´ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ£Ÿà ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ÿ£Ÿàÿ≥ÿπ</p>
                        <button class="btn btn-outline-primary" onclick="smartImageSearch()">
                            <i class="fas fa-redo me-1"></i>ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
                        </button>
                    </div>
                `;
                return;
            }
            
            const groupedBySource = {};
            images.forEach(img => {
                if (!groupedBySource[img.source]) {
                    groupedBySource[img.source] = [];
                }
                groupedBySource[img.source].push(img);
            });
            
            let html = '';
            
            if (images.length > 0) {
                const bestImage = images[0];
                html += `
                    <div class="col-12 mb-4">
                        <div class="card border-success shadow-sm">
                            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-crown me-2"></i> ÿ£ŸÅÿ∂ŸÑ ÿµŸàÿ±ÿ© ŸÖŸÇÿ™ÿ±ÿ≠ÿ©
                                </div>
                                <div>
                                    <span class="badge bg-light text-success fs-6">${Math.round(bestImage.final_score)}%</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-3 text-center">
                                        <img src="${bestImage.thumb || bestImage.url}" 
                                             class="img-fluid rounded border border-3 border-success shadow"
                                             style="max-height: 180px; cursor: pointer;"
                                             onclick="selectSmartImage(0)"
                                             alt="${bestImage.title}">
                                        <div class="mt-2">
                                            <span class="badge bg-secondary">${bestImage.source}</span>
                                            <span class="badge bg-info ms-1">${bestImage.width}√ó${bestImage.height}</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="mb-2">${bestImage.title}</h6>
                                        <p class="text-muted small mb-3">${bestImage.description}</p>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="progress" style="height: 10px;">
                                                    <div class="progress-bar bg-success" 
                                                         style="width: ${bestImage.quality_score}%"></div>
                                                </div>
                                                <small>ÿßŸÑÿ¨ŸàÿØÿ©: ${Math.round(bestImage.quality_score)}%</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="progress" style="height: 10px;">
                                                    <div class="progress-bar bg-primary" 
                                                         style="width: ${bestImage.relevance_score}%"></div>
                                                </div>
                                                <small>ÿßŸÑŸÖŸÑÿßÿ°ŸÖÿ©: ${Math.round(bestImage.relevance_score)}%</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <button class="btn btn-success w-100 mb-2" 
                                                onclick="selectSmartImage(0); applySelectedImageToCurrentProduct()">
                                            <i class="fas fa-check-circle me-2"></i> ÿ™ÿ∑ÿ®ŸäŸÇ Ÿáÿ∞Ÿá ÿßŸÑÿµŸàÿ±ÿ©
                                        </button>
                                        <button class="btn btn-outline-primary w-100" 
                                                onclick="previewImage('${bestImage.url}', '${bestImage.title}')">
                                            <i class="fas fa-external-link-alt me-2"></i> ŸÖÿπÿßŸäŸÜÿ©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            Object.entries(groupedBySource).forEach(([source, sourceImages]) => {
                const sourceIcon = {
                    'Bing Images': 'fab fa-microsoft',
                    'Unsplash': 'fas fa-camera',
                    'Pexels': 'fas fa-images',
                    'Pixabay': 'fas fa-image',
                    'Google Images': 'fab fa-google',
                    'Flickr': 'fab fa-flickr'
                }[source] || 'fas fa-image';
                
                html += `
                    <div class="col-12 mb-3">
                        <div class="card source-group-card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="${sourceIcon} me-2"></i>
                                    <strong>${source}</strong>
                                    <span class="badge bg-secondary ms-2">${sourceImages.length}</span>
                                </div>
                                <small class="text-muted">ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ŸÖŸÜ ${source}</small>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    ${sourceImages.slice(0, 4).map((img, index) => {
                                        const globalIndex = images.indexOf(img);
                                        return `
                                            <div class="col-md-3 col-sm-6">
                                                <div class="card h-100 image-select-card" 
                                                     onclick="selectSmartImage(${globalIndex})" 
                                                     data-index="${globalIndex}">
                                                    <div class="position-relative" style="height: 150px; overflow: hidden;">
                                                        <img src="${img.thumb || img.url}" 
                                                             class="card-img-top h-100 w-100" 
                                                             alt="${img.title}"
                                                             style="object-fit: cover;"
                                                             loading="lazy">
                                                        <span class="position-absolute top-0 end-0 bg-dark text-white p-1 small">
                                                            ${Math.round(img.final_score)}%
                                                        </span>
                                                    </div>
                                                    <div class="card-body p-2">
                                                        <small class="d-block text-truncate mb-1">${img.title.substring(0, 30)}</small>
                                                        <div class="d-flex justify-content-between small">
                                                            <span>${img.width}√ó${img.height}</span>
                                                            <span class="badge bg-${img.commercial_use ? 'success' : 'warning'}">
                                                                ${img.commercial_use ? 'ÿ™ÿ¨ÿßÿ±Ÿä' : 'ÿ¥ÿÆÿµŸä'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function selectSmartImage(index) {
            document.querySelectorAll('.image-select-card').forEach(card => {
                card.classList.remove('border-primary', 'border-3');
                card.classList.add('border-light');
            });
            
            const selectedCard = document.querySelector(`.image-select-card[data-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.remove('border-light');
                selectedCard.classList.add('border-primary', 'border-3');
                
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
                
                const applyBtnContainer = document.getElementById('applyButtonContainer');
                if (state.smartSearch.currentProduct && applyBtnContainer) {
                    applyBtnContainer.style.display = 'block';
                }
                
                showStatus(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ© ŸÖŸÜ ${state.smartSearch.searchResults[index].source}`, 'info');
            }
        }

        function applySelectedImageToCurrentProduct() {
            if (!state.smartSearch.currentProduct) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ™ÿ¨. ÿßÿÆÿ™ÿ± ŸÖŸÜÿ™ÿ¨ÿßŸã ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            if (!state.smartSearch.selectedImage) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ©. ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            updateProductImage(state.smartSearch.currentProduct, state.smartSearch.selectedImage.url);
            showStatus('‚úì ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
            
            setTimeout(() => {
                const applyBtnContainer = document.getElementById('applyButtonContainer');
                if (applyBtnContainer) {
                    applyBtnContainer.style.display = 'none';
                }
            }, 2000);
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ====================
        async function autoSearchProductImages() {
            if (!state.products || state.products.length === 0) {
                showStatus('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            const productsNeedingImages = state.products.filter(p => {
                const hasImage = p.image && p.image.trim() !== '';
                const isHighQuality = hasImage && (
                    (p.image.includes('bing.net') && p.image.includes('w=800')) || 
                    (p.image.includes('unsplash') && p.image.includes('featured')) ||
                    (p.image.includes('pexels') || p.image.includes('pixabay'))
                );
                return !hasImage || !isHighQuality;
            }).slice(0, 20);
            
            if (productsNeedingImages.length === 0) {
                showStatus('ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿµŸàÿ± ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©', 'info');
                return;
            }
            
            state.autoSearch = {
                active: true,
                currentIndex: 0,
                totalProducts: productsNeedingImages.length,
                products: productsNeedingImages
            };
            
            const progressBar = document.getElementById('autoSearchProgress');
            const progressBarInner = document.getElementById('autoSearchProgressBar');
            if (progressBar) progressBar.style.display = 'block';
            if (progressBarInner) progressBarInner.style.width = '0%';
            
            showStatus(`ÿ®ÿØÿ£ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÄ ${productsNeedingImages.length} ŸÖŸÜÿ™ÿ¨...`, 'info');
            
            for (let i = 0; i < productsNeedingImages.length; i++) {
                if (!state.autoSearch.active) break;
                
                const product = productsNeedingImages[i];
                state.autoSearch.currentIndex = i + 1;
                
                try {
                    const query = intelligentSearch.enhanceQuery(
                        product.designation, 
                        product.famille
                    );
                    
                    const images = await intelligentSearch.searchAllSources(query, product.famille, 1);
                    
                    if (images.length > 0) {
                        const bestImage = images[0];
                        
                        if (!product.originalImage) {
                            product.originalImage = product.image;
                        }
                        
                        updateProductImage(product.id, bestImage.url);
                        
                        if (progressBarInner) {
                            const progress = ((i + 1) / productsNeedingImages.length) * 100;
                            progressBarInner.style.width = `${progress}%`;
                        }
                        
                        showStatus(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${product.designation} (${bestImage.source})`, 'success');
                    }
                } catch (e) {
                    console.error(`Failed to search for: ${product.designation}`, e);
                    showStatus(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ${product.designation}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            
            state.autoSearch.active = false;
            if (progressBar) progressBar.style.display = 'none';
            saveData();
            showStatus('üéâ ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
        }

        // ==================== ŸÖÿπÿßŸÑÿ¨ÿ© Excel ====================
        function handleExcelUpload(file) {
            if (!file) return;

            showStatus('Lecture du fichier...', 'info');
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processExcelData(jsonData);
                } catch (err) {
                    showStatus('Erreur lecture Excel: ' + err.message, 'error');
                }
            };
            reader.onerror = () => {
                showStatus('Erreur de lecture du fichier', 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            if (!Array.isArray(data)) {
                showStatus('Format de fichier invalide', 'error');
                return;
            }

            const processed = data.map((row, idx) => ({
                id: `prod_${Date.now()}_${idx}`,
                ref: row['Ref'] || row['R√©f√©rence'] || row['Code'] || `REF${idx + 1}`,
                designation: row['Designation'] || row['D√©signation'] || row['Nom'] || 'Produit sans nom',
                famille: row['Famille'] || row['Categorie'] || 'G√©n√©ral',
                prix: parseFloat(row['Prix'] || row['Price'] || 0) || 0,
                image: row['Image'] || row['Photo'] || '',
                description: row['Description'] || row['Desc'] || ''
            })).filter(p => p.designation && p.designation !== 'Produit sans nom');

            state.products = processed;
            saveData();
            showStatus(`${processed.length} produits import√©s avec succ√®s!`, 'success');
        }

        // ==================== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ====================
        function addNewProduct() {
            const name = document.getElementById('newProductName')?.value;
            const price = document.getElementById('newProductPrice')?.value;
            const cat = document.getElementById('newProductCategory')?.value;
            const img = document.getElementById('newProductImage')?.value;

            if (!name || !price) {
                showStatus('Nom et Prix requis', 'warning');
                return;
            }

            state.newProducts.unshift({
                id: `new_${Date.now()}`,
                name: name.trim(),
                price: parseFloat(price) || 0,
                category: cat || 'G√©n√©ral',
                image: img || '',
                timestamp: new Date().toISOString()
            });

            if (document.getElementById('newProductName')) {
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductImage').value = '';
            }

            saveData();
            showStatus('Nouveau produit ajout√©', 'success');
        }

        function createNotification() {
            const title = document.getElementById('notifTitle')?.value;
            const msg = document.getElementById('notifMessage')?.value;
            const type = document.getElementById('notifType')?.value;

            if (!title || !msg) {
                showStatus('Titre et Message requis', 'warning');
                return;
            }

            state.notifications.unshift({
                id: `notif_${Date.now()}`,
                title: title.trim(),
                message: msg.trim(),
                type: type || 'info',
                timestamp: new Date().toISOString()
            });

            if (document.getElementById('notifTitle')) {
                document.getElementById('notifTitle').value = '';
                document.getElementById('notifMessage').value = '';
            }

            saveData();
            showStatus('Notification cr√©√©e', 'success');
        }

        function removeNewProduct(id) {
            state.newProducts = state.newProducts.filter(p => p.id !== id);
            saveData();
        }

        function removeNotification(id) {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
        }

        // ==================== ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© ====================
        function openBulkImageModal() {
            const modalElement = document.getElementById('bulkImageModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                updateBulkPreview();
            }
        }

        function updateBulkPreview() {
            const activeTab = document.querySelector('.nav-link.active');
            const preview = document.getElementById('bulkPreview');
            
            if (!activeTab || !preview) return;

            if (activeTab.id === 'mode-magic-tab') {
                preview.textContent = `https://tse2.mm.bing.net/th?q=ExempleProduit&w=800&h=800`;
            } else if (activeTab.id === 'mode-desc-tab') {
                preview.textContent = `https://www.bing.com/search?q=fiche+technique+ExempleProduit`;
            } else if (activeTab.id === 'mode-ai-tab') {
                preview.textContent = `Recherche IA avec sources multiples`;
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl')?.value || 'https://site.com/img/';
                const field = document.getElementById('bulkField')?.value || 'ref';
                const ext = document.getElementById('bulkExt')?.value || '.jpg';
                const example = field === 'ref' ? 'REF123' : 'Produit_Exemple';
                preview.textContent = `${baseUrl}${example}${ext}`;
            }
        }

        async function searchAIImages() {
            const query = document.getElementById('aiSearchQuery')?.value;
            const source = document.getElementById('aiSources')?.value || 'auto';
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }

            const loader = document.getElementById('aiLoader');
            const resultsDiv = document.getElementById('aiResults');
            
            if (loader) loader.style.display = 'block';
            if (resultsDiv) resultsDiv.innerHTML = '';

            try {
                let images = [];
                const smartQuery = intelligentSearch.enhanceQuery(query);
                
                if (source === 'auto') {
                    images = await intelligentSearch.searchAllSources(smartQuery, '', 9);
                } else if (source === 'bing') {
                    images = await intelligentSearch.searchBing(smartQuery, 9);
                } else if (source === 'unsplash') {
                    images = await intelligentSearch.searchUnsplash(smartQuery, 9);
                }

                displayAIResults(images);
                
            } catch (error) {
                console.error('AI Search error:', error);
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Erreur de recherche: ${error.message || 'Erreur inconnue'}
                            </div>
                        </div>
                    `;
                }
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }

        function displayAIResults(results) {
            const container = document.getElementById('aiResults');
            if (!container) return;
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Aucune image trouv√©e. Essayez avec d'autres termes.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map((img, index) => `
                <div class="col-md-4 col-sm-6">
                    <div class="ai-image-result" onclick="selectAIImage(${index})">
                        <div class="position-relative" style="height: 150px; overflow: hidden;">
                            <img src="${img.thumb || img.url}" class="w-100 h-100" style="object-fit: cover;" alt="${img.title}">
                            <span class="search-source-badge">${img.source}</span>
                        </div>
                        <div class="p-2">
                            <small class="d-block text-truncate">${img.title}</small>
                            <small class="text-muted">
                                <i class="fas fa-${img.source === 'Unsplash' ? 'camera' : 'search'} me-1"></i>
                                ${img.source} - ${img.width || 800}√ó${img.height || 800}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectAIImage(index) {
            document.querySelectorAll('.ai-image-result').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selected = document.querySelectorAll('.ai-image-result')[index];
            if (selected) {
                selected.classList.add('selected');
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
            }
        }

        function applyBulkActions() {
            const activeTab = document.querySelector('.nav-link.active');
            if (!activeTab || !state.products || state.products.length === 0) {
                showStatus('Aucun produit √† modifier', 'warning');
                return;
            }

            if (!confirm(`Cela va modifier ${state.products.length} produits. Continuer?`)) {
                return;
            }

            if (activeTab.id === 'mode-magic-tab') {
                state.products = state.products.map(p => ({
                    ...p,
                    image: `https://tse2.mm.bing.net/th?q=${encodeURIComponent(p.designation)}&w=800&h=800&c=7&rs=1&p=0`
                }));
            } else if (activeTab.id === 'mode-desc-tab') {
                state.products = state.products.map(p => ({
                    ...p,
                    description: `https://www.bing.com/search?q=fiche+technique+${encodeURIComponent(p.designation)}`
                }));
            } else if (activeTab.id === 'mode-ai-tab') {
                if (state.smartSearch.selectedImage) {
                    const selectedUrl = state.smartSearch.selectedImage.url;
                    state.products = state.products.map(p => ({
                        ...p,
                        image: selectedUrl
                    }));
                    showStatus('Image IA appliqu√©e √† tous les produits', 'success');
                } else {
                    showStatus('Veuillez d\'abord s√©lectionner une image', 'warning');
                    return;
                }
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl')?.value;
                const field = document.getElementById('bulkField')?.value || 'ref';
                const ext = document.getElementById('bulkExt')?.value || '';

                if (!baseUrl) {
                    showStatus('Veuillez entrer une URL de base', 'warning');
                    return;
                }

                state.products = state.products.map(p => {
                    const val = p[field] ? p[field].toString().trim() : '';
                    const safeVal = field === 'designation' ? 
                        val.replace(/[^a-zA-Z0-9-_]/g, '_') : 
                        val;
                    return {
                        ...p,
                        image: `${baseUrl}${safeVal}${ext}`
                    };
                });
            }

            saveData();
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkImageModal'));
            if (modal) modal.hide();
            showStatus('Mise √† jour effectu√©e avec succ√®s!', 'success');
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ¨ÿØŸàŸÑ ====================
        function openSmartSearchForProduct(productId, designation) {
            state.smartSearch.currentProduct = productId;
            const searchInput = document.getElementById('smartSearchInput');
            if (searchInput) searchInput.value = designation;
            
            const searchSource = document.getElementById('searchSource');
            if (searchSource) searchSource.value = 'auto';
            
            const suggestions = document.querySelector('.smart-suggestions');
            if (suggestions) {
                suggestions.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
            
            setTimeout(() => {
                smartImageSearch();
                showStatus(`ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÄ ${designation}ÿå ÿ´ŸÖ ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ© ÿ´ŸÖ ÿπŸÑŸâ "ÿ™ÿ∑ÿ®ŸäŸÇ"`, 'info');
            }, 800);
        }

        async function quickImageSearch(productId, designation) {
            showStatus(`ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ${designation}...`, 'info');
            
            try {
                const product = state.products.find(p => p.id === productId);
                const smartQuery = intelligentSearch.enhanceQuery(designation, product?.famille);
                const images = await intelligentSearch.searchBing(smartQuery, 1);
                if (images.length > 0) {
                    updateProductImage(productId, images[0].url);
                    showStatus(`‚úì ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${designation}`, 'success');
                } else {
                    showStatus('ŸÑŸÖ ÿ£ÿ¨ÿØ ÿµŸàÿ±ÿßŸã ŸÖŸÜÿßÿ≥ÿ®ÿ©', 'warning');
                }
            } catch (error) {
                console.error('Quick search error:', error);
                showStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´', 'error');
            }
        }

        async function advancedQuickSearch(productId, designation) {
            showStatus(`ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ÿπŸÜ ${designation}...`, 'info');
            
            try {
                const product = state.products.find(p => p.id === productId);
                if (!product) return;
                
                const images = await intelligentSearch.searchAllSources(designation, product.famille, 3);
                
                if (images.length > 0) {
                    const bestImage = images[0];
                    updateProductImage(productId, bestImage.url);
                    showStatus(
                        `‚úì ${designation}: ${bestImage.source} (${Math.round(bestImage.final_score)}%)`,
                        'success'
                    );
                } else {
                    showStatus('ŸÑŸÖ ÿ£ÿ¨ÿØ ÿµŸàÿ±ÿßŸã ŸÖŸÜÿßÿ≥ÿ®ÿ©', 'warning');
                }
            } catch (error) {
                console.error('Advanced quick search error:', error);
                showStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ', 'error');
            }
        }

        // ==================== ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ ====================
        function updateProductImage(id, newUrl) {
            const product = state.products.find(p => p.id === id);
            if (product) {
                if (!product.originalImage) {
                    product.originalImage = product.image;
                }
                product.image = newUrl;
                saveData();
                updateUI();
            }
        }

        function updateProductDesc(id, newUrl) {
            const product = state.products.find(p => p.id === id);
            if (product) {
                product.description = newUrl;
                saveData();
                updateUI();
            }
        }

        // ==================== GitHub Sync ====================
        async function uploadToGitHubGist() {
            const token = document.getElementById('githubToken')?.value;
            if (!token || token.trim() === '') {
                showStatus('Token GitHub manquant!', 'error');
                return;
            }

            if (state.products.length === 0 && state.newProducts.length === 0) {
                showStatus('Aucun produit √† publier! Veuillez importer des donn√©es.', 'warning');
                return;
            }

            const btn = document.getElementById('publishBtn');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            btn.disabled = true;

            const payload = {
                description: "VARICOM Catalog Data",
                public: true,
                files: {
                    "varicom_data.json": {
                        content: JSON.stringify({
                            products: state.products,
                            newProducts: state.newProducts,
                            notifications: state.notifications,
                            lastUpdate: new Date().toISOString(),
                            meta: { version: "2.0", source: "VaricomAdmin" }
                        })
                    }
                }
            };

            try {
                let url = 'https://api.github.com/gists';
                let method = 'POST';

                if (state.gistId) {
                    url += `/${state.gistId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 404 && state.gistId) {
                        state.gistId = null;
                        localStorage.removeItem('varicom_gist_id');
                        return uploadToGitHubGist();
                    }
                    throw new Error(`Erreur GitHub: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                state.gistId = result.id;
                state.lastSync = new Date().toISOString();

                localStorage.setItem('varicom_gist_id', state.gistId);
                localStorage.setItem('varicom_last_sync', state.lastSync);

                showStatus('‚úÖ Synchronisation r√©ussie! Donn√©es publi√©es.', 'success');
                updateUI();

            } catch (err) {
                console.error('Sync error:', err);
                showStatus('Erreur Sync: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ====================
        function updateUI() {
            // Stats
            updateElement('statsProducts', state.products.length);
            updateElement('statsNewProducts', state.newProducts.length);
            updateElement('statsNotifications', state.notifications.length);
            
            const statsStatus = document.getElementById('statsStatus');
            if (statsStatus) {
                statsStatus.textContent = state.gistId ? 'Actif' : 'Inactif';
                statsStatus.className = state.gistId ? 'text-success' : 'text-danger';
            }

            // Lists
            updateNewProductsList();
            updateNotificationsList();

            // Catalog Table
            updateCatalogTable();
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateNewProductsList() {
            const list = document.getElementById('activeNewProducts');
            if (!list) return;

            list.innerHTML = state.newProducts.map(p => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(p.name)}</strong> - ${p.price} DA
                        <br><small class="text-muted">${p.category}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNewProduct('${escapeJs(p.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');
        }

        function updateNotificationsList() {
            const list = document.getElementById('activeNotifications');
            if (!list) return;

            list.innerHTML = state.notifications.map(n => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-${getBadgeClass(n.type)} me-2">${getBadgeIcon(n.type)}</span>
                        <strong>${escapeHtml(n.title)}</strong>
                        <br><small class="text-muted">${escapeHtml(n.message.substring(0, 50))}${n.message.length > 50 ? '...' : ''}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNotification('${escapeJs(n.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');
        }

        function updateCatalogTable() {
            const tableBody = document.getElementById('catalogTableBody');
            if (!tableBody) return;

            const productsToShow = state.products.slice(0, 100);
            
            tableBody.innerHTML = productsToShow.map(p => `
                <tr data-product-id="${p.id}">
                    <td><small>${escapeHtml(p.ref)}</small></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${escapeHtml(p.designation)}">
                        ${escapeHtml(p.designation)}
                    </td>
                    <td>${p.prix} DA</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" 
                                   value="${escapeHtml(p.image || '')}" 
                                   onchange="updateProductImage('${escapeJs(p.id)}', this.value)"
                                   placeholder="URL Image...">
                            <button class="btn btn-outline-primary" 
                                    onclick="quickImageSearch('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ">
                                <i class="fas fa-bolt"></i>
                            </button>
                            <button class="btn btn-outline-info" 
                                    onclick="advancedQuickSearch('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ŸÖÿ™ŸÇÿØŸÖ">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                        ${p.image ? 
                            `<small class="text-success"><i class="fas fa-check-circle"></i> ŸÖŸàÿ¨ŸàÿØÿ©</small>` : 
                            `<small class="text-danger"><i class="fas fa-times-circle"></i> ŸÖŸÅŸÇŸàÿØÿ©</small>`}
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${escapeHtml(p.description || '')}" 
                               onchange="updateProductDesc('${escapeJs(p.id)}', this.value)"
                               placeholder="URL Desc...">
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" 
                                    onclick="openSmartSearchForProduct('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-outline-primary" 
                                    onclick="window.open('https://www.bing.com/images/search?q=${encodeURIComponent(p.designation + ' product white background')}', '_blank')"
                                    title="Bing">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-info" 
                                    onclick="window.open('https://unsplash.com/s/photos/${encodeURIComponent(p.designation)}', '_blank')"
                                    title="Unsplash">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-outline-warning" 
                                    onclick="window.open('https://www.pexels.com/search/${encodeURIComponent(p.designation)}/', '_blank')"
                                    title="Pexels">
                                <i class="fas fa-images"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getBadgeClass(type) {
            switch (type) {
                case 'info': return 'info';
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                default: return 'secondary';
            }
        }

        function getBadgeIcon(type) {
            switch (type) {
                case 'info': return '‚ÑπÔ∏è';
                case 'success': return '‚úÖ';
                case 'warning': return '‚ö†Ô∏è';
                case 'error': return '‚ùå';
                default: return 'üîî';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJs(text) {
            if (!text) return '';
            return text.toString()
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        // ==================== ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ====================
        function showStatus(msg, type) {
            const el = document.getElementById('syncStatus');
            if (!el) return;

            el.textContent = msg;
            el.className = 'sync-status';
            
            switch(type) {
                case 'success':
                    el.classList.add('sync-success');
                    break;
                case 'warning':
                    el.classList.add('sync-warning');
                    break;
                case 'error':
                    el.classList.add('sync-error');
                    break;
                default:
                    el.classList.add('sync-success');
            }
            
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function generateClientLink() {
            if (!state.gistId) {
                showStatus('Veuillez d\'abord publier le catalogue', 'warning');
                return;
            }

            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            const clientUrl = `${baseUrl}index.html?gist=${state.gistId}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(clientUrl).then(() => {
                    showStatus('‚úÖ Lien client copi√©!', 'success');
                }).catch(() => {
                    prompt('Copiez ce lien manuellement:', clientUrl);
                    showStatus('Lien pr√™t √† √™tre copi√©', 'info');
                });
            } else {
                prompt('Copiez ce lien manuellement:', clientUrl);
                showStatus('Lien pr√™t √† √™tre copi√©', 'info');
            }
        }

        function toggleToken() {
            const input = document.getElementById('githubToken');
            const icon = input?.parentNode?.querySelector('i');
            if (input && icon) {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            }
        }

        function resetSync() {
            if (confirm('Voulez-vous vraiment r√©initialiser la synchronisation? Cela d√©connectera le catalogue actuel.')) {
                localStorage.removeItem('varicom_gist_id');
                localStorage.removeItem('varicom_last_sync');
                state.gistId = null;
                state.lastSync = null;
                updateUI();
                showStatus('Synchronisation r√©initialis√©e', 'info');
            }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([
                { 
                    Ref: 'REF001', 
                    Designation: 'Exemple Produit', 
                    Famille: 'Informatique', 
                    Prix: 1000, 
                    Image: 'https://example.com/image.jpg', 
                    Description: 'https://example.com/description' 
                }
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Modele");
            XLSX.writeFile(wb, "modele_import_varicom.xlsx");
        }

        function previewImage(url, title) {
            const previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            const previewImage = document.getElementById('previewImage');
            const downloadLink = document.getElementById('downloadImage');
            
            previewImage.src = url;
            downloadLink.href = url;
            downloadLink.download = title ? `${title.replace(/[^a-z0-9]/gi, '_')}.jpg` : 'image.jpg';
            
            previewModal.show();
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ====================
        function openBatchSearchModal() {
            const modalHtml = `
                <div class="modal fade" id="batchSearchModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-bolt me-2"></i>ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    ÿ≥Ÿäÿ®ÿ≠ÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿπŸÜ ÿµŸàÿ± ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ© ŸÖÿ™ŸÇÿØŸÖÿ©.
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">ÿπÿØÿØ ÿßŸÑÿµŸàÿ± ŸÑŸÉŸÑ ŸÖŸÜÿ™ÿ¨</label>
                                        <select class="form-select" id="batchImagesPerProduct">
                                            <option value="1">1 ÿµŸàÿ±ÿ© (ÿßŸÑÿ£ŸÅÿ∂ŸÑ)</option>
                                            <option value="2">2 ÿµŸàÿ±</option>
                                            <option value="3" selected>3 ÿµŸàÿ±</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">ÿ≠ÿØ ÿßŸÑÿ¨ŸàÿØÿ© ÿßŸÑÿ£ÿØŸÜŸâ</label>
                                        <select class="form-select" id="batchQualityThreshold">
                                            <option value="60">60%</option>
                                            <option value="70" selected>70%</option>
                                            <option value="80">80%</option>
                                            <option value="90">90%</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">ÿßŸÑŸÖÿµÿßÿØÿ±</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sourceBing" checked>
                                            <label class="form-check-label" for="sourceBing">Bing Images</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sourceUnsplash" checked>
                                            <label class="form-check-label" for="sourceUnsplash">Unsplash</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sourcePexels" checked>
                                            <label class="form-check-label" for="sourcePexels">Pexels</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sourcePixabay">
                                            <label class="form-check-label" for="sourcePixabay">Pixabay</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-clock me-2"></i>
                                    ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸÇÿØÿ±: ${Math.ceil(state.products.length * 2.5)} ÿ´ÿßŸÜŸäÿ©
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ŸÑÿ∫ÿßÿ°</button>
                                <button type="button" class="btn btn-primary" onclick="startAdvancedBatchSearch()">
                                    <i class="fas fa-play me-2"></i>ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer.firstChild);
            
            const modal = new bootstrap.Modal(document.getElementById('batchSearchModal'));
            modal.show();
        }

        async function startAdvancedBatchSearch() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchSearchModal'));
            modal.hide();
            
            if (!state.products || state.products.length === 0) {
                showStatus('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            const progressBar = document.getElementById('autoSearchProgress');
            const progressBarInner = document.getElementById('autoSearchProgressBar');
            if (progressBar) {
                progressBar.style.display = 'block';
                progressBarInner.style.width = '0%';
            }
            
            showStatus('ÿ®ÿØÿ£ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ...', 'info');
            
            try {
                let appliedCount = 0;
                const batchResults = [];
                
                for (let i = 0; i < state.products.length; i++) {
                    const product = state.products[i];
                    
                    if (progressBarInner) {
                        const progress = ((i + 1) / state.products.length) * 100;
                        progressBarInner.style.width = `${progress}%`;
                    }
                    
                    try {
                        const query = intelligentSearch.enhanceQuery(product.designation, product.famille);
                        const images = await intelligentSearch.searchAllSources(
                            query, 
                            product.famille, 
                            parseInt(document.getElementById('batchImagesPerProduct')?.value || 3)
                        );
                        
                        if (images.length > 0) {
                            const qualityThreshold = parseInt(document.getElementById('batchQualityThreshold')?.value || 70);
                            const goodImages = images.filter(img => img.final_score >= qualityThreshold);
                            
                            if (goodImages.length > 0) {
                                batchResults.push({
                                    productId: product.id,
                                    productName: product.designation,
                                    images: goodImages,
                                    bestImage: goodImages[0]
                                });
                                
                                appliedCount++;
                                showStatus(
                                    `‚úÖ ${product.designation}: ${goodImages.length} ÿµŸàÿ±ÿ© ÿ¨ŸäÿØÿ©`,
                                    'success'
                                );
                            } else {
                                showStatus(`‚ö†Ô∏è ${product.designation}: ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ± ÿ®ÿ¨ŸàÿØÿ© ŸÉÿßŸÅŸäÿ©`, 'warning');
                            }
                        } else {
                            showStatus(`‚ö†Ô∏è ${product.designation}: ŸÑŸÖ ÿ£ÿ¨ÿØ ÿµŸàÿ±ÿßŸã`, 'warning');
                        }
                    } catch (error) {
                        console.error(`Failed to search for ${product.designation}:`, error);
                        showStatus(`‚ùå ${product.designation}: ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´`, 'error');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                
                state.batchSearchResults = batchResults;
                localStorage.setItem('varicom_batch_results', JSON.stringify(batchResults));
                
                if (progressBar) {
                    progressBar.style.display = 'none';
                }
                
                showAdvancedBatchResults(batchResults, appliedCount);
                
            } catch (error) {
                console.error('Advanced batch search error:', error);
                showStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ: ' + error.message, 'error');
                
                if (progressBar) {
                    progressBar.style.display = 'none';
                }
            }
        }

        function showAdvancedBatchResults(results, appliedCount) {
            const resultsHtml = `
                <div class="modal fade" id="batchResultsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-chart-bar me-2"></i>ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿØŸÅÿπŸä
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ± ŸÑŸÄ <strong>${appliedCount}</strong> ŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ÿ£ÿµŸÑ <strong>${state.products.length}</strong>
                                </div>
                                
                                <div class="table-responsive batch-results-table">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ÿßŸÑŸÖŸÜÿ™ÿ¨</th>
                                                <th>ÿ£ŸÅÿ∂ŸÑ ÿµŸàÿ±ÿ©</th>
                                                <th>ÿßŸÑŸÖÿµÿØÿ±</th>
                                                <th>ÿßŸÑÿ¨ŸàÿØÿ©</th>
                                                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${results.map(result => `
                                                <tr>
                                                    <td class="text-truncate" style="max-width: 200px;">
                                                        ${result.productName}
                                                    </td>
                                                    <td>
                                                        <img src="${result.bestImage.thumb}" 
                                                             class="img-thumbnail" 
                                                             style="width: 60px; height: 60px; cursor: pointer;"
                                                             onclick="previewImage('${result.bestImage.url}', '${result.productName}')">
                                                    </td>
                                                    <td>${result.bestImage.source}</td>
                                                    <td>
                                                        <div class="progress" style="height: 8px; width: 100px;">
                                                            <div class="progress-bar ${result.bestImage.final_score >= 80 ? 'bg-success' : 'bg-warning'}" 
                                                                 style="width: ${result.bestImage.final_score}%"></div>
                                                        </div>
                                                        <small>${Math.round(result.bestImage.final_score)}%</small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-success" 
                                                                onclick="applyBatchImage('${result.productId}', '${result.bestImage.url}')">
                                                            ÿ™ÿ∑ÿ®ŸäŸÇ
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-primary ms-1" 
                                                                onclick="previewImage('${result.bestImage.url}', '${result.productName}')">
                                                            ŸÖÿπÿßŸäŸÜÿ©
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <button class="btn btn-primary" onclick="applyAllBatchImages()">
                                        <i class="fas fa-check-double me-2"></i>ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸàÿ±
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" data-bs-dismiss="modal">
                                        ÿ•ÿ∫ŸÑÿßŸÇ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = resultsHtml;
            document.body.appendChild(modalContainer.firstChild);
            
            const modal = new bootstrap.Modal(document.getElementById('batchResultsModal'));
            modal.show();
        }

        function applyBatchImage(productId, imageUrl) {
            const product = state.products.find(p => p.id === productId);
            if (product) {
                if (!product.originalImage) {
                    product.originalImage = product.image;
                }
                
                product.image = imageUrl;
                saveData();
                updateUI();
                
                showStatus('ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
            }
        }

        function applyAllBatchImages() {
            if (!state.batchSearchResults || state.batchSearchResults.length === 0) {
                showStatus('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ≠ÿ´ ÿØŸÅÿπŸä', 'warning');
                return;
            }
            
            let appliedCount = 0;
            state.batchSearchResults.forEach(result => {
                const product = state.products.find(p => p.id === result.productId);
                if (product && result.bestImage) {
                    if (!product.originalImage) {
                        product.originalImage = product.image;
                    }
                    
                    product.image = result.bestImage.url;
                    appliedCount++;
                }
            });
            
            saveData();
            updateUI();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchResultsModal'));
            modal.hide();
            
            showStatus(`ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ${appliedCount} ÿµŸàÿ±ÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™`, 'success');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
