<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARICOM - Catalogue Intelligent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1a3a6c;
            --secondary-color: #e63946;
            --accent-color: #2a9d8f;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }
        
        [data-theme="dark"] {
            --primary-color: #3498db;
            --secondary-color: #e74c3c;
            --accent-color: #1abc9c;
            --dark-color: #ecf0f1;
            --light-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--light-color);
            min-height: 100vh;
            color: var(--dark-color);
            transition: all 0.3s ease;
        }

        .company-header {
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .company-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
        }

        .sync-status-bar {
            background: linear-gradient(135deg, var(--accent-color), #229f8f);
            color: white;
            padding: 0.75rem 0;
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }

        .sync-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .product-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            overflow: hidden;
            background: white;
            position: relative;
        }

        [data-theme="dark"] .product-card {
            background: #34495e;
            color: var(--dark-color);
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card:hover::before {
            opacity: 1;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .product-image {
            height: 220px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            color: var(--primary-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .product-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, var(--secondary-color), #c1121f);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 25px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 2;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }

        .new-product-badge {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
        }

        .live-sync-indicator {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: white;
            border-radius: 12px;
            padding: 12px 18px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--accent-color);
            backdrop-filter: blur(10px);
            animation: slideInUp 0.5s ease;
        }

        [data-theme="dark"] .live-sync-indicator {
            background: #34495e;
            color: white;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .stat-card {
            background: #34495e;
            color: white;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .notifications-container {
            max-height: 450px;
            overflow-y: auto;
            border-radius: 12px;
        }

        .notification-item {
            border-left: 4px solid;
            padding: 1.25rem;
            margin: 0.75rem 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .notification-item {
            background: #2c3e50;
        }

        .notification-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: translateX(-100%);
        }

        .notification-item:hover::before {
            transform: translateX(100%);
            transition: transform 0.6s ease;
        }

        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .notification-info { 
            border-left-color: #17a2b8; 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .notification-success { 
            border-left-color: #28a745; 
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
        }
        .notification-warning { 
            border-left-color: #ffc107; 
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
        }
        .notification-error { 
            border-left-color: #dc3545; 
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        [data-theme="dark"] .notification-info { background: linear-gradient(135deg, #1a5276, #154360); }
        [data-theme="dark"] .notification-success { background: linear-gradient(135deg, #145a32, #0e4d2a); }
        [data-theme="dark"] .notification-warning { background: linear-gradient(135deg, #7d6608, #665200); }
        [data-theme="dark"] .notification-error { background: linear-gradient(135deg, #78281f, #641e16); }

        .fab {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            border: none;
        }

        .fab:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .search-highlight {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
        }

        .new-product-highlight {
            position: relative;
            overflow: hidden;
        }

        .new-product-highlight::before {
            content: 'NOUVEAU';
            position: absolute;
            top: 12px;
            right: -32px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 6px 45px;
            font-size: 0.7rem;
            font-weight: bold;
            transform: rotate(45deg);
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .category-badge {
            background: linear-gradient(135deg, var(--primary-color), #2a4d7a);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .product-card:hover .category-badge {
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .product-image {
                height: 180px;
            }
            
            .fab {
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
            }
        }

        .floating-notification {
            position: fixed;
            bottom: 90px;
            left: 25px;
            z-index: 1000;
            max-width: 320px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Enhanced Sync Status Bar -->
    <div class="sync-status-bar">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small><i class="fas fa-sync-alt sync-pulse me-2"></i> <span id="syncStatusText">Synchronisation temps r√©el active</span></small>
                </div>
                <div class="col-md-6 text-end">
                    <small><i class="fas fa-clock me-1"></i> MAJ: <span id="lastUpdateTime">--:--:--</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Sync Indicator -->
    <div class="live-sync-indicator" id="liveSyncIndicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span id="liveSyncText">Mise √† jour en cours...</span>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" onclick="scrollToTop()" title="Remonter en haut">
        <i class="fas fa-arrow-up"></i>
    </div>

    <header class="company-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="company-logo">
                        <h2 class="mb-1"><i class="fas fa-bolt me-2"></i>VARICOM LIVE</h2>
                        <p class="mb-0 opacity-75">Catalogue intelligent synchronis√© en temps r√©el</p>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex justify-content-end gap-2 align-items-center">
                        <button class="btn btn-sm btn-light" onclick="toggleTheme()" title="Changer le th√®me">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button class="btn btn-sm btn-light" onclick="forceRefresh()" id="refreshBtn">
                            <i class="fas fa-sync-alt"></i> Actualiser
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="checkSyncStatus()">
                                <i class="fas fa-wifi"></i> Statut
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon text-primary">
                    <i class="fas fa-box fa-2x mb-2"></i>
                </div>
                <div class="stat-value fs-3 fw-bold" id="totalProducts">0</div>
                <div class="stat-label">Produits Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-success">
                    <i class="fas fa-star fa-2x mb-2"></i>
                </div>
                <div class="stat-value fs-3 fw-bold" id="totalNewProducts">0</div>
                <div class="stat-label">Nouveaut√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-info">
                    <i class="fas fa-bell fa-2x mb-2"></i>
                </div>
                <div class="stat-value fs-3 fw-bold" id="totalNotifications">0</div>
                <div class="stat-label">Notifications</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon text-warning">
                    <i class="fas fa-sync-alt fa-2x mb-2"></i>
                </div>
                <div class="stat-value fs-3 fw-bold" id="syncVersion">v3.0</div>
                <div class="stat-label">Version Sync</div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="card mb-4" id="notificationsCard" style="display: none;">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notifications R√©centes</h5>
                <div>
                    <button class="btn btn-sm btn-outline-dark me-2" onclick="markAllNotificationsAsRead()">
                        <i class="fas fa-check-double"></i> Tout marquer comme lu
                    </button>
                    <button class="btn btn-sm btn-outline-dark" onclick="hideNotifications()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="notifications-container" id="notificationsContainer">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Enhanced Search and Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label fw-bold"><i class="fas fa-search me-2"></i>Recherche avanc√©e</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Rechercher un produit, r√©f√©rence, cat√©gorie...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold"><i class="fas fa-filter me-2"></i>Filtres</label>
                        <select id="categoryFilter" class="form-select">
                            <option value="">Toutes les cat√©gories</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="R√©initialiser les filtres">
                            <i class="fas fa-eraser"></i> Effacer
                        </button>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showNewProductsOnly" onchange="filterNewProducts()">
                            <label class="form-check-label" for="showNewProductsOnly">
                                <i class="fas fa-star me-1 text-warning"></i> Afficher seulement les nouveaut√©s
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="row" id="productsGrid">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                <h4>Chargement du catalogue VARICOM...</h4>
                <p class="text-muted">Synchronisation avec le serveur en cours</p>
            </div>
        </div>

        <!-- Sync Information -->
        <div class="card mt-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations de Synchronisation</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleSyncDetails()">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body" id="syncDetails" style="display: none;">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <small class="text-muted d-block">ID de synchronisation:</small>
                        <div><code id="syncId" class="bg-light p-1 rounded">N/A</code></div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <small class="text-muted d-block">Derni√®re mise √† jour:</small>
                        <div id="lastSyncDetails" class="fw-bold">Non synchronis√©</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <small class="text-muted d-block">Prochaine synchronisation:</small>
                        <div id="nextSync" class="fw-bold">--:--:--</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="progress" style="height: 6px;">
                            <div id="syncProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="syncProgressText">Synchronisation pr√™te</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION ET VARIABLES GLOBALES
        // =============================================
        let products = [];
        let newProducts = [];
        let categories = [];
        let notifications = [];
        let currentGistId = null;
        let lastSyncHash = '';
        let autoRefreshInterval;
        let liveSyncEnabled = true;
        let nextSyncTime = null;
        let unreadNotifications = 0;

        // =============================================
        // INITIALISATION DE L'APPLICATION
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initialisation du Catalogue VARICOM Client');
            initializeApp();
            setupEventListeners();
            startAutoRefresh();
            checkForNewNotifications();
            
            // Charger le th√®me sauvegard√©
            const savedTheme = localStorage.getItem('varicom_theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        });

        function initializeApp() {
            loadFromURL();
            updateSyncStatus('Initialisation du catalogue...', 'info');
            updateNextSyncTime();
        }

        function setupEventListeners() {
            // Recherche en temps r√©el
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterProducts(e.target.value);
                }, 300);
            });

            // Filtre par cat√©gorie
            document.getElementById('categoryFilter').addEventListener('change', function(e) {
                filterByCategory(e.target.value);
            });

            // D√©tection de la connexion
            window.addEventListener('online', function() {
                updateSyncStatus('Connexion r√©tablie - Synchronisation...', 'success');
                forceRefresh();
            });

            window.addEventListener('offline', function() {
                updateSyncStatus('Mode hors ligne - Donn√©es locales', 'warning');
            });

            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    forceRefresh();
                }
                if (e.key === 'Escape') {
                    clearFilters();
                }
                if (e.key === 'F1') {
                    e.preventDefault();
                    showHelp();
                }
            });
        }

        // =============================================
        // CHARGEMENT DES DONN√âES
        // =============================================
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const gistId = urlParams.get('gist');
            
            if (gistId) {
                currentGistId = gistId;
                localStorage.setItem('varicom_client_gist_id', gistId);
                loadFromGitHubGist(gistId);
            } else {
                const savedGistId = localStorage.getItem('varicom_client_gist_id');
                if (savedGistId) {
                    currentGistId = savedGistId;
                    loadFromGitHubGist(savedGistId);
                } else {
                    showError('Aucun catalogue configur√©. Contactez l\'administrateur VARICOM.');
                }
            }
        }

        async function loadFromGitHubGist(gistId, isRetry = false) {
            showLiveSync('Connexion au catalogue...');
            setRefreshButtonLoading(true);
            updateSyncProgress(10, 'D√©but de la synchronisation');
            
            try {
                console.log('üîÑ Chargement depuis Gist:', gistId);
                updateSyncProgress(30, 'Connexion √† GitHub...');
                
                const response = await fetch(`https://api.github.com/gists/${gistId}?t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                updateSyncProgress(60, 'Traitement des donn√©es...');
                const gistData = await response.json();

                const dataFile = gistData.files['varicom_data.json'];
                if (!dataFile || !dataFile.content) {
                    throw new Error('Fichier de donn√©es introuvable dans le catalogue');
                }

                updateSyncProgress(80, 'Mise √† jour de l\'interface...');
                const completeData = JSON.parse(dataFile.content);
                processClientData(completeData);
                
                updateSyncProgress(100, 'Synchronisation termin√©e');
                showLiveSync('‚úÖ Catalogue synchronis√©');
                
                setTimeout(() => {
                    updateSyncProgress(0, 'Pr√™t pour la prochaine synchronisation');
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erreur synchronisation:', error);
                showLiveSync('‚ùå Erreur de synchronisation');
                updateSyncProgress(0, 'Erreur de synchronisation');
                
                if (!isRetry) {
                    showSyncStatus('Nouvelle tentative dans 5 secondes...', 'warning');
                    setTimeout(() => loadFromGitHubGist(gistId, true), 5000);
                } else {
                    showError(`Impossible de charger le catalogue: ${error.message}`);
                }
            } finally {
                setRefreshButtonLoading(false);
            }
        }

        function processClientData(completeData) {
            // Traitement des produits principaux
            if (completeData.products && Array.isArray(completeData.products)) {
                products = completeData.products.map(p => ({
                    id: p.id || generateId(),
                    ref: p.ref || 'N/A',
                    designation: p.designation || 'Produit sans nom',
                    famille: p.famille || 'G√©n√©ral',
                    prix: parseFloat(p.prix) || 0,
                    image: p.image || null,
                    timestamp: p.timestamp || new Date().toISOString()
                }));
            }

            // Traitement des nouveaux produits
            if (completeData.newProducts && Array.isArray(completeData.newProducts)) {
                newProducts = completeData.newProducts.map(np => ({
                    id: np.id || generateId(),
                    name: np.name || 'Nouveau produit',
                    price: parseFloat(np.price) || 0,
                    image: np.image || 'https://via.placeholder.com/300x200/6c757d/ffffff?text=VARICOM+PRO',
                    category: np.category || 'G√©n√©ral',
                    timestamp: np.timestamp || new Date().toISOString()
                }));
            }

            // Traitement des notifications
            if (completeData.notifications && Array.isArray(completeData.notifications)) {
                const newNotifications = completeData.notifications;
                checkForNewNotifications(newNotifications);
                notifications = newNotifications;
            }

            // Mise √† jour de l'interface
            updateStats();
            displayProducts();
            updateCategories();
            updateSyncInfo(completeData);

            // V√©rification des changements
            const newHash = generateDataHash(completeData);
            if (lastSyncHash && lastSyncHash !== newHash) {
                showEnhancedNotification('Catalogue mis √† jour', 'Nouveaux produits et notifications disponibles', 'success');
            }
            lastSyncHash = newHash;

            updateSyncStatus('Catalogue synchronis√© ‚úì', 'success');
            updateNextSyncTime();
        }

        // =============================================
        // GESTION DES NOTIFICATIONS
        // =============================================
        function checkForNewNotifications(newNotifications = null) {
            const notificationsToCheck = newNotifications || notifications;
            const lastNotificationCheck = localStorage.getItem('varicom_last_notification_check') || 0;
            let newNotificationsCount = 0;
            
            if (notificationsToCheck.length > 0) {
                notificationsToCheck.forEach(notification => {
                    if (new Date(notification.timestamp).getTime() > parseInt(lastNotificationCheck)) {
                        newNotificationsCount++;
                    }
                });
                
                if (newNotificationsCount > 0) {
                    unreadNotifications = newNotificationsCount;
                    showNotificationsPanel();
                    showFloatingNotification(`üîî ${newNotificationsCount} nouvelle(s) notification(s)`);
                }
            }
            
            localStorage.setItem('varicom_last_notification_check', Date.now().toString());
        }

        function showNotificationsPanel() {
            const notificationsCard = document.getElementById('notificationsCard');
            const notificationsContainer = document.getElementById('notificationsContainer');
            
            if (notifications.length === 0) {
                notificationsCard.style.display = 'none';
                return;
            }

            let notificationsHTML = '';
            notifications.slice(0, 10).forEach(notification => {
                const time = new Date(notification.timestamp).toLocaleString('fr-FR');
                const icon = getNotificationIcon(notification.type);
                const isNew = new Date(notification.timestamp).getTime() > parseInt(localStorage.getItem('varicom_last_notification_check') || 0);
                
                notificationsHTML += `
                    <div class="notification-item notification-${notification.type} ${isNew ? 'border-2 border-warning' : ''}">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-${icon} me-3 mt-1 fa-lg"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${notification.title}</h6>
                                <p class="mb-2">${notification.message}</p>
                                <small class="text-muted"><i class="fas fa-clock me-1"></i>${time}</small>
                            </div>
                            ${isNew ? '<span class="badge bg-warning ms-2">Nouveau</span>' : ''}
                        </div>
                    </div>
                `;
            });

            notificationsContainer.innerHTML = notificationsHTML;
            notificationsCard.style.display = 'block';
        }

        function markAllNotificationsAsRead() {
            localStorage.setItem('varicom_last_notification_check', Date.now().toString());
            unreadNotifications = 0;
            showNotificationsPanel();
            showSyncStatus('Toutes les notifications marqu√©es comme lues', 'success');
        }

        function hideNotifications() {
            document.getElementById('notificationsCard').style.display = 'none';
        }

        function showFloatingNotification(message) {
            // Cr√©er une notification flottante
            const existingNotification = document.getElementById('floatingNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'floatingNotification';
            notification.className = 'floating-notification alert alert-info alert-dismissible fade show';
            notification.innerHTML = `
                <i class="fas fa-bell me-2"></i>
                ${message}
                <button type="button" class="btn-close btn-sm" onclick="this.parentElement.remove()"></button>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // =============================================
        // AFFICHAGE DES PRODUITS
        // =============================================
        function displayProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0 && newProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h4>Aucun produit disponible</h4>
                        <p class="text-muted">Le catalogue est en cours de mise √† jour par l'administrateur</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            // Afficher les nouveaux produits en premier
            newProducts.forEach(product => {
                html += createProductCard(product, true);
            });

            // Afficher les produits r√©guliers
            products.forEach(product => {
                html += createProductCard(product, false);
            });

            grid.innerHTML = html;
        }

        function createProductCard(product, isNewProduct = false) {
            const isNew = isNewProduct || isNewProductTimestamp(product);
            const productName = isNewProduct ? product.name : product.designation;
            const productRef = isNewProduct ? 'NV-' + product.id.substring(0, 8) : product.ref;
            const productPrice = isNewProduct ? product.price : product.prix;
            const productCategory = isNewProduct ? product.category : product.famille;
            const productImage = product.image || (isNewProduct ? product.image : null);
            const isNewFlag = isNewProduct || isNewProductTimestamp(product);
            
            return `
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card product-card h-100 ${isNewFlag ? 'new-product-highlight' : ''}">
                        <div class="product-image position-relative">
                            ${productImage ? 
                                `<img src="${productImage}" alt="${productName}" 
                                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                      class="product-image-img">` : 
                                ''
                            }
                            <div class="w-100 h-100 d-flex align-items-center justify-content-center ${productImage ? 'd-none' : ''}">
                                <i class="fas fa-box-open fa-3x" style="color: var(--primary-color)"></i>
                            </div>
                            ${isNew ? 
                                `<div class="product-badge new-product-badge">
                                    <i class="fas fa-star me-1"></i>NOUVEAU
                                </div>` : 
                                (isNewProductTimestamp(product) ? 
                                    `<div class="product-badge">
                                        <i class="fas fa-bolt me-1"></i>R√âCENT
                                    </div>` : '')
                            }
                        </div>
                        <div class="card-body">
                            <h6 class="card-title fw-bold">${escapeHtml(productName)}</h6>
                            <p class="text-muted small mb-2">
                                <i class="fas fa-hashtag me-1"></i>R√©f: ${escapeHtml(productRef)}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="category-badge">${escapeHtml(productCategory)}</span>
                                <strong class="text-success fs-5">${formatPrice(productPrice)}</strong>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-0 pt-0">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm" onclick="addToCart('${product.id}')">
                                    <i class="fas fa-cart-plus me-1"></i>Ajouter au panier
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // FONCTIONS DE FILTRAGE ET RECHERCHE
        // =============================================
        function filterProducts(searchTerm) {
            if (!searchTerm) {
                displayProducts();
                return;
            }

            const filteredProducts = products.filter(p => 
                p.designation.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.ref.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.famille.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const filteredNewProducts = newProducts.filter(np => 
                np.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                np.category.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayFilteredProducts(filteredProducts, filteredNewProducts, searchTerm);
        }

        function filterByCategory(category) {
            const filteredProducts = category ? 
                products.filter(p => p.famille === category) : 
                products;
                
            const filteredNewProducts = category ?
                newProducts.filter(np => np.category === category) :
                newProducts;
                
            displayFilteredProducts(filteredProducts, filteredNewProducts);
        }

        function filterNewProducts() {
            const showNewOnly = document.getElementById('showNewProductsOnly').checked;
            
            if (showNewOnly) {
                displayFilteredProducts([], newProducts);
            } else {
                displayProducts();
            }
        }

        function displayFilteredProducts(filteredProducts, filteredNewProducts, searchTerm = '') {
            const grid = document.getElementById('productsGrid');
            
            if (filteredProducts.length === 0 && filteredNewProducts.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h4>Aucun produit trouv√©</h4>
                        <p class="text-muted">Essayez de modifier vos crit√®res de recherche</p>
                        <button class="btn btn-outline-primary mt-2" onclick="clearFilters()">
                            <i class="fas fa-eraser me-1"></i>R√©initialiser les filtres
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            
            // Produits nouveaux filtr√©s
            filteredNewProducts.forEach(product => {
                html += createProductCard(product, true);
            });

            // Produits r√©guliers filtr√©s
            filteredProducts.forEach(product => {
                html += createProductCard(product, false);
            });

            grid.innerHTML = html;
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('showNewProductsOnly').checked = false;
            displayProducts();
            showSyncStatus('Filtres r√©initialis√©s', 'info');
        }

        // =============================================
        // FONCTIONS DE SYNCHRONISATION
        // =============================================
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                if (liveSyncEnabled && currentGistId) {
                    console.log('üîÑ Synchronisation automatique...');
                    loadFromGitHubGist(currentGistId);
                }
            }, 2 * 60 * 1000); // Toutes les 2 minutes
        }

        function forceRefresh() {
            if (currentGistId) {
                loadFromGitHubGist(currentGistId);
            } else {
                loadFromURL();
            }
        }

        function checkSyncStatus() {
            if (!currentGistId) {
                showNotification('Aucun catalogue configur√©', 'warning');
                return;
            }

            showLiveSync('V√©rification du statut...');
            loadFromGitHubGist(currentGistId).then(() => {
                showNotification('Synchronisation v√©rifi√©e avec succ√®s', 'success');
            });
        }

        // =============================================
        // FONCTIONS D'INTERFACE UTILISATEUR
        // =============================================
        function updateSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatusText');
            statusElement.textContent = message;
            
            const colors = {
                'info': '#17a2b8',
                'success': '#28a745',
                'warning': '#ffc107',
                'error': '#dc3545'
            };
            
            document.querySelector('.sync-status-bar').style.background = 
                `linear-gradient(135deg, ${colors[type] || colors.info}, ${colors[type] || colors.info})`;
        }

        function showLiveSync(message) {
            const indicator = document.getElementById('liveSyncIndicator');
            const text = document.getElementById('liveSyncText');
            
            text.textContent = message;
            indicator.style.display = 'flex';
            
            if (!message.includes('‚úÖ') && !message.includes('‚ùå')) {
                indicator.querySelector('i').className = 'fas fa-sync-alt fa-spin';
            } else if (message.includes('‚úÖ')) {
                indicator.querySelector('i').className = 'fas fa-check text-success';
                setTimeout(() => indicator.style.display = 'none', 3000);
            } else {
                indicator.querySelector('i').className = 'fas fa-times text-danger';
                setTimeout(() => indicator.style.display = 'none', 5000);
            }
        }

        function updateSyncProgress(percent, text) {
            const progressBar = document.getElementById('syncProgress');
            const progressText = document.getElementById('syncProgressText');
            
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
            
            if (percent === 100) {
                setTimeout(() => {
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Pr√™t pour la prochaine synchronisation';
                }, 2000);
            }
        }

        function setRefreshButtonLoading(loading) {
            const button = document.getElementById('refreshBtn');
            const icon = button.querySelector('i');
            
            if (loading) {
                icon.className = 'loading-spinner';
                button.disabled = true;
            } else {
                icon.className = 'fas fa-sync-alt';
                button.disabled = false;
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('varicom_theme', newTheme);
            
            showNotification(`Th√®me ${newTheme === 'dark' ? 'sombre' : 'clair'} activ√©`, 'info');
        }

        function toggleSyncDetails() {
            const details = document.getElementById('syncDetails');
            const button = document.querySelector('#syncDetails').previousElementSibling.querySelector('button');
            const icon = button.querySelector('i');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showHelp() {
            alert(`üéØ GUIDE VARICOM - RACCOURCIS ET FONCTIONNALIT√âS

üîç RECHERCHE AVANC√âE:
‚Ä¢ Tapez pour rechercher dans les noms, r√©f√©rences et cat√©gories
‚Ä¢ Utilisez les filtres pour affiner les r√©sultats
‚Ä¢ Ctrl+R: Actualiser le catalogue

üé® PERSONNALISATION:
‚Ä¢ Cliquez sur la lune pour changer le th√®me
‚Ä¢ Les notifications s'affichent automatiquement

üîÑ SYNCHRONISATION:
‚Ä¢ Automatique toutes les 2 minutes
‚Ä¢ Statut en temps r√©el en haut de page
‚Ä¢ Cliquez sur Actualiser pour forcer une sync

üì± OPTIMIS√â MOBILE:
‚Ä¢ Interface responsive
‚Ä¢ Gestes tactiles support√©s
‚Ä¢ Chargement rapide

üí° ASTUCES:
‚Ä¢ √âchap: Effacer les filtres
‚Ä¢ F1: Afficher cette aide
‚Ä¢ Clic produit: D√©tails rapides`);
        }

        // =============================================
        // FONCTIONS UTILITAIRES
        // =============================================
        function updateStats() {
            document.getElementById('totalProducts').textContent = (products.length + newProducts.length).toLocaleString();
            document.getElementById('totalNewProducts').textContent = newProducts.length.toLocaleString();
            document.getElementById('totalNotifications').textContent = notifications.length.toLocaleString();
        }

        function updateSyncInfo(data) {
            if (data.metadata) {
                document.getElementById('syncVersion').textContent = data.metadata.version || 'v3.0';
                document.getElementById('syncId').textContent = data.metadata.syncId || 'N/A';
            }
            
            if (data.lastUpdate) {
                const lastUpdate = new Date(data.lastUpdate);
                document.getElementById('lastUpdateTime').textContent = lastUpdate.toLocaleTimeString('fr-FR');
                document.getElementById('lastSyncDetails').textContent = lastUpdate.toLocaleString('fr-FR');
            }
        }

        function updateNextSyncTime() {
            const now = new Date();
            const nextSync = new Date(now.getTime() + 2 * 60 * 1000);
            document.getElementById('nextSync').textContent = nextSync.toLocaleTimeString('fr-FR');
            nextSyncTime = nextSync;
        }

        function updateCategories() {
            const categorySet = new Set();
            products.forEach(p => categorySet.add(p.famille));
            newProducts.forEach(np => categorySet.add(np.category));
            
            const categories = Array.from(categorySet).sort();
            const filter = document.getElementById('categoryFilter');
            
            let options = '<option value="">Toutes les cat√©gories</option>';
            categories.forEach(cat => {
                options += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
            });
            
            filter.innerHTML = options;
        }

        function isNewProductTimestamp(product) {
            if (!product.timestamp) return false;
            const productDate = new Date(product.timestamp);
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            return productDate > sevenDaysAgo;
        }

        function generateDataHash(data) {
            return btoa(JSON.stringify({
                products: data.products?.length || 0,
                newProducts: data.newProducts?.length || 0,
                notifications: data.notifications?.length || 0,
                lastUpdate: data.lastUpdate
            }));
        }

        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getNotificationIcon(type) {
            const icons = {
                'info': 'info-circle',
                'success': 'check-circle',
                'warning': 'exclamation-triangle',
                'error': 'exclamation-circle'
            };
            return icons[type] || 'info-circle';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================
        // FONCTIONS DE NOTIFICATION
        // =============================================
        function showError(message) {
            updateSyncStatus(message, 'error');
            showNotification(message, 'error');
        }

        function showNotification(message, type) {
            showEnhancedNotification(
                type === 'success' ? 'Succ√®s' : 
                type === 'error' ? 'Erreur' : 
                type === 'warning' ? 'Attention' : 'Information',
                message, 
                type
            );
        }

        function showEnhancedNotification(title, message, type) {
            // Cr√©er une notification toast moderne
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = `
                top: 80px; 
                right: 20px; 
                z-index: 1000; 
                min-width: 350px; 
                max-width: 400px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.15);
                border-left: 4px solid ${getNotificationColor(type)};
                border-radius: 10px;
            `;
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${getNotificationIcon(type)} me-3 fa-lg"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">${title}</h6>
                        <p class="mb-0 small">${message}</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Animation d'entr√©e
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
                notification.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        function getNotificationColor(type) {
            const colors = {
                'info': '#17a2b8',
                'success': '#28a745',
                'warning': '#ffc107',
                'error': '#dc3545'
            };
            return colors[type] || colors.info;
        }

        // =============================================
        // FONCTIONS INTERACTIVES
        // =============================================
        function addToCart(productId) {
            showEnhancedNotification('Panier', 'Produit ajout√© au panier avec succ√®s', 'success');
            
            // Animation sur le bouton
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-1"></i>Ajout√©!';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(price) + ' DA';
        }

        // =============================================
        // INITIALISATION FINALE
        // =============================================
        console.log('‚úÖ Catalogue VARICOM Client initialis√© avec succ√®s!');
    </script>
</body>
</html>
