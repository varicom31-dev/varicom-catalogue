<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VARICOM - Administration Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* === ÿ£ŸÑŸàÿßŸÜ ŸÖÿ™ŸÜÿßÿ≥ŸÇÿ© ŸÖÿπ ÿ¥ÿπÿßÿ± VARICOM (ÿ£ÿ≤ÿ±ŸÇ ÿ™ÿØÿ±ÿ¨Ÿä + ÿ£ÿ≠ŸÖÿ±/Ÿàÿ±ÿØŸä) === */
        :root {
            --primary-color: #114a9f;       /* ÿ£ÿ≤ÿ±ŸÇ ÿØÿßŸÉŸÜ */
            --primary-color-2: #2b73d6;     /* ÿ£ÿ≤ÿ±ŸÇ ŸÅÿßÿ™ÿ≠ (ŸÑÿ™ÿØÿ±ÿ¨) */
            --primary-gradient: linear-gradient(90deg, #114a9f 0%, #2b73d6 100%);
            --secondary-color: #ff2d55;     /* ÿ£ÿ≠ŸÖÿ±/Ÿàÿ±ÿØŸä ÿ¥ÿπÿßÿ± */
            --accent-color: #0ea5a8;        /* ŸÑŸàŸÜ ÿØÿßÿπŸÖ */
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --card-bg: #ffffff;
            --bg-page: linear-gradient(135deg, rgba(17,74,159,0.12), rgba(43,115,214,0.06));
        }

        /* ÿØÿßŸÉŸÜ */
        [data-theme="dark"] {
            --primary-color: #2b73d6;
            --primary-color-2: #114a9f;
            --primary-gradient: linear-gradient(90deg,#2b73d6 0%, #114a9f 100%);
            --secondary-color: #ff6b85;
            --accent-color: #34d399;
            --dark-color: #0b1220;
            --light-color: #0f1720;
            --card-bg: #0f1720;
            --bg-page: linear-gradient(135deg, rgba(43,115,214,0.06), rgba(17,74,159,0.06));
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-page);
            min-height: 100vh;
            padding: 20px;
            color: #0b1b2b;
            transition: background .25s ease, color .25s ease;
        }

        [data-theme="dark"] body {
            color: #e6eef8;
        }

        .admin-container {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(16, 40, 80, 0.08);
            margin: 0 auto;
            max-width: 1400px;
            overflow: hidden;
        }

        .admin-header {
            background: var(--primary-gradient);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:6px;
        }

        .admin-header h1 {
            margin:0;
            font-weight:700;
            letter-spacing:0.6px;
        }

        .admin-header p { margin:0; opacity:0.95; }

        .brand-mark {
            width:48px;
            height:48px;
            border-radius:8px;
            background: conic-gradient(from 200deg, var(--secondary-color), var(--primary-color), var(--primary-color-2));
            box-shadow: 0 8px 18px rgba(17,74,159,0.15);
            display:inline-block;
            margin-bottom:6px;
        }

        .upload-section {
            background: linear-gradient(135deg, rgba(40,167,69,0.08), rgba(16,185,129,0.02));
            color: #0d1b2a;
            border-radius: 15px;
            padding: 25px;
            margin: 20px;
            box-shadow: 0 6px 18px rgba(16,40,80,0.04);
        }

        .upload-area {
            border: 3px dashed rgba(17, 74, 159, 0.18);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.28s ease;
            background: rgba(255,255,255,0.9);
        }

        .upload-area:hover {
            background: rgba(251,251,251,0.98);
            border-color: var(--primary-color);
            transform: translateY(-4px);
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
            animation: slideInRight 0.45s ease;
            color: white;
            font-weight:600;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-success { background: var(--accent-color); border-left: 5px solid #0b845f; }
        .sync-warning { background: #ffc107; color: #000; border-left: 5px solid #e0a800; }
        .sync-error { background: var(--secondary-color); border-left: 5px solid #bd2130; }

        .stats-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(16, 40, 80, 0.04);
            transition: transform 0.28s;
        }

        .stats-card:hover { transform: translateY(-6px); }

        .feature-card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(16, 40, 80, 0.04);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .btn-pulse {
            animation: pulse 2.2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.6); }
            70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .ai-image-result {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.25s;
            cursor: pointer;
            height: 100%;
            background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
        }

        .ai-image-result:hover {
            border-color: var(--primary-color);
            transform: translateY(-6px);
            box-shadow: 0 8px 22px rgba(16,40,80,0.08);
        }

        .ai-image-result.selected {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 6px rgba(255,45,85,0.08);
        }

        .search-tags { display:flex; flex-wrap:wrap; gap:6px; margin:10px 0; }
        .search-tag {
            background: #eef2f7;
            padding:6px 10px;
            border-radius: 999px;
            font-size:0.85rem;
            cursor:pointer;
            transition:all .18s;
        }
        .search-tag:hover { background: var(--primary-color); color:white; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .search-source-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0,0,0,0.62);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.72rem;
        }

        .smart-suggestions {
            background: #f8f9fb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .suggestion-tag {
            display:inline-block;
            background:#eef2f7;
            border:1px solid #e2e8f0;
            border-radius:20px;
            padding:6px 12px;
            margin:5px;
            cursor:pointer;
            transition:all .18s;
        }
        .suggestion-tag:hover { background: var(--primary-color); color:#fff; border-color:var(--primary-color); }

        .image-select-card { transition: all .25s; cursor:pointer; }
        .image-select-card:hover { transform: translateY(-6px); box-shadow: 0 10px 24px rgba(16,40,80,0.07); }

        .auto-search-progress { height: 5px; background: #e9ecef; border-radius:10px; overflow:hidden; margin-top:10px; }
        .auto-search-progress-bar { height:100%; background: linear-gradient(90deg,var(--accent-color), #20c997); transition:width .3s; }

        .quality-badge { position:absolute; top:5px; left:5px; background: linear-gradient(135deg,#28a745,#20c997); color:white; padding:3px 8px; border-radius:8px; font-size:.72rem; font-weight:700; }
        .relevance-badge { position:absolute; top:5px; right:5px; background: linear-gradient(135deg,var(--primary-color),var(--primary-color-2)); color:white; padding:3px 8px; border-radius:8px; font-size:.72rem; font-weight:700; }

        /* Table header sticky */
        thead.sticky-top { top: 0; z-index: 2; background: linear-gradient(90deg,#ffffff,#f8fbff); }
        [data-theme="dark"] thead.sticky-top { background: linear-gradient(90deg,#0b1220,#0f1720); color: #e6eef8; }

        /* small responsive tweaks */
        @media (max-width: 768px) {
            .admin-header { padding:16px; }
            .upload-area { padding:28px 14px; }
        }
    </style>
</head>
<body>
    <div id="syncStatus" class="sync-status"></div>

    <div class="admin-container">
        <div class="admin-header text-center">
            <span class="brand-mark" aria-hidden="true"></span>
            <h1><i class="fas fa-user-shield me-3"></i>PANEL ADMINISTRATEUR VARICOM</h1>
            <p class="lead mb-0">Solution Professionnelle - Synchronisation Temps R√©el</p>
        </div>

        <!-- Quick Actions -->
        <div class="p-4 bg-light border-bottom">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-0 text-primary"><i class="fas fa-bolt me-2"></i>Tableau de Bord</h4>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-warning btn-lg me-2" onclick="autoSearchProductImages()">
                        <i class="fas fa-robot me-2"></i>ÿ®ÿ≠ÿ´ ÿ™ŸÑŸÇÿßÿ¶Ÿä
                    </button>
                    <button class="btn" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white;" onclick="uploadToGitHubGist()" id="publishBtn">
                        <i class="fab fa-github me-2"></i>Publier / Synchroniser
                    </button>
                    <button class="btn btn-outline-primary btn-lg" onclick="generateClientLink()">
                        <i class="fas fa-link me-2"></i>Lien Client
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row m-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-box fa-2x text-primary mb-2"></i>
                    <h3 id="statsProducts">0</h3>
                    <p class="text-muted mb-0">Produits Totaux</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-star fa-2x text-warning mb-2"></i>
                    <h3 id="statsNewProducts">0</h3>
                    <p class="text-muted mb-0">Nouveaut√©s</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-bell fa-2x text-info mb-2"></i>
                    <h3 id="statsNotifications">0</h3>
                    <p class="text-muted mb-0">Notifications</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-sync fa-2x text-success mb-2"></i>
                    <h3 id="statsStatus">Inactif</h3>
                    <p class="text-muted mb-0">Statut Sync</p>
                </div>
            </div>
        </div>

        <!-- Smart Search Section -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white;">
                        <h5 class="mb-0"><i class="fas fa-search-plus me-2"></i>ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä ŸÖÿ™ŸÇÿØŸÖ ÿ®ÿßŸÑÿµŸàÿ±</h5>
                    </div>
                    <div class="card-body">
                        <div class="smart-suggestions">
                            <h6><i class="fas fa-lightbulb me-2"></i>ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ©:</h6>
                            <div id="smartSuggestions">
                                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿá ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã -->
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="smartSearchInput" 
                                           placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÑŸÖŸÜÿ™ÿ¨...">
                                    <button class="btn btn-primary" onclick="smartImageSearch()">
                                        <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="searchSource">
                                    <option value="auto">ÿ™ŸÑŸÇÿßÿ¶Ÿä (ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨)</option>
                                    <option value="bing">Bing Images</option>
                                    <option value="unsplash">Unsplash</option>
                                </select>
                            </div>
                        </div>

                        <div id="autoSearchProgress" class="auto-search-progress" style="display: none;">
                            <div id="autoSearchProgressBar" class="auto-search-progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="row g-3" id="smartResults"></div>
                        
                        <div class="mt-3 text-center" id="applyButtonContainer" style="display: none;">
                            <button class="btn" style="background:var(--secondary-color); color:white;" onclick="applySelectedImageToCurrentProduct()">
                                <i class="fas fa-check-circle me-2"></i>ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨
                            </button>
                            <p class="text-muted mt-2 small" id="currentProductInfo"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Upload -->
        <div class="upload-section">
            <h4><i class="fas fa-file-excel me-2"></i>Importation Produits Excel</h4>
            <div class="upload-area" id="excelUploadArea" onclick="document.getElementById('excelFile').click()">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                <h5>Cliquez ou glissez votre fichier Excel ici</h5>
                <p class="small opacity-75">Supporte .xlsx, .xls, .csv</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display: none;"
                    onchange="handleExcelUpload(this.files[0])">
            </div>
            <div class="mt-3 text-center">
                <button class="btn btn-outline-secondary btn-sm" onclick="downloadTemplate()">
                    <i class="fas fa-download me-1"></i>T√©l√©charger Mod√®le
                </button>
            </div>
        </div>

        <div class="row m-4">
            <!-- New Products -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white;">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ajouter Produit / Nouveaut√©</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="newProductName" placeholder="Nom du produit">
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="newProductPrice" placeholder="Prix (DA)">
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="newProductCategory">
                                        <option value="G√©n√©ral">Cat√©gorie...</option>
                                        <option value="Ordinateurs">Ordinateurs</option>
                                        <option value="T√©l√©phones">T√©l√©phones</option>
                                        <option value="Accessoires">Accessoires</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" class="form-control mt-2" id="newProductImage" placeholder="URL de l'image (https://...)">
                        </div>
                        <button class="btn" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white;" onclick="addNewProduct()">
                            <i class="fas fa-plus me-2"></i>Ajouter √† la liste
                        </button>

                        <hr>
                        <h6 class="text-muted">Produits Nouveaux Actifs:</h6>
                        <ul id="activeNewProducts" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="col-md-6">
                <div class="feature-card h-100">
                    <div class="card-header" style="background: linear-gradient(90deg,#ffc107,#ff8a00); color:#000;">
                        <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>G√©rer Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control mb-2" id="notifTitle" placeholder="Titre (ex: Promo)">
                            <textarea class="form-control mb-2" id="notifMessage" rows="2" placeholder="Message..."></textarea>
                            <select class="form-select" id="notifType">
                                <option value="info">Information ‚ÑπÔ∏è</option>
                                <option value="success">Succ√®s ‚úÖ</option>
                                <option value="warning">Attention ‚ö†Ô∏è</option>
                                <option value="error">Urgent ‚ùå</option>
                            </select>
                        </div>
                        <button class="btn btn-warning w-100" onclick="createNotification()">
                            <i class="fas fa-paper-plane me-2"></i>Publier Notification
                        </button>

                        <hr>
                        <h6 class="text-muted">Notifications Actives:</h6>
                        <ul id="activeNotifications" class="list-group list-group-flush small" style="max-height: 200px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Token GitHub (Personnel Access Token)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-github"></i></span>
                                    <input type="password" class="form-control" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleToken()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">N√©cessaire pour la synchronisation. Stock√© localement.</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-danger w-100" onclick="resetSync()">
                                    <i class="fas fa-trash-alt me-2"></i>R√©initialiser Sync
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Catalog Management -->
        <div class="row m-4">
            <div class="col-12">
                <div class="feature-card">
                    <div class="card-header" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white; display:flex; justify-content:space-between; align-items:center;">
                        <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Gestion du Catalogue</h5>
                        <button class="btn btn-light btn-sm text-primary fw-bold" onclick="openBulkImageModal()">
                            <i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover align-middle">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Ref</th>
                                        <th>D√©signation</th>
                                        <th>Prix</th>
                                        <th style="width: 25%;">Image URL</th>
                                        <th style="width: 20%;">Description URL</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="catalogTableBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <small class="text-muted">Affichage limit√© aux 100 premiers produits pour la performance.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Image Modal (unchanged structure but colors consistent) -->
    <div class="modal fade" id="bulkImageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background:linear-gradient(90deg,var(--primary-color),var(--primary-color-2)); color:white;">
                    <h5 class="modal-title"><i class="fas fa-magic me-2"></i>G√©n√©rateur de Liens Image/Desc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="bulkTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="mode-hosted-tab" data-bs-toggle="tab" data-bs-target="#mode-hosted" type="button" role="tab">üìÇ Images H√©berg√©es</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-magic-tab" data-bs-toggle="tab" data-bs-target="#mode-magic" type="button" role="tab">‚ú® Images Magiques</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-ai-tab" data-bs-toggle="tab" data-bs-target="#mode-ai" type="button" role="tab">ü§ñ IA Intelligente</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mode-desc-tab" data-bs-toggle="tab" data-bs-target="#mode-desc" type="button" role="tab">üìù Descriptions Auto</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="bulkTabsContent">
                        <!-- Hosted Mode -->
                        <div class="tab-pane fade show active" id="mode-hosted" role="tabpanel">
                            <p class="small text-muted">Utilisez ce mode si vous avez vos propres images h√©berg√©es (ex: GitHub Pages, Imgur).</p>
                            <div class="mb-3">
                                <label class="form-label">Base URL</label>
                                <input type="text" class="form-control" id="bulkBaseUrl" placeholder="ex: https://monsite.com/images/">
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Champ</label>
                                    <select class="form-select" id="bulkField">
                                        <option value="ref">R√©f√©rence</option>
                                        <option value="designation">D√©signation</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Extension</label>
                                    <select class="form-select" id="bulkExt">
                                        <option value=".jpg">.jpg</option>
                                        <option value=".png">.png</option>
                                        <option value=".webp">.webp</option>
                                        <option value="">(Aucune)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Magic Mode -->
                        <div class="tab-pane fade" id="mode-magic" role="tabpanel">
                            <div class="alert alert-warning small">
                                <i class="fas fa-exclamation-triangle me-2"></i><strong>Note:</strong> L'association <em>automatique</em> ne fonctionne qu'avec <strong>Bing</strong> pour des raisons techniques.
                            </div>
                            <p class="small text-muted">Recherche automatique d'images sur Bing via la D√©signation.</p>
                        </div>

                        <!-- AI Mode -->
                        <div class="tab-pane fade" id="mode-ai" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-robot me-2"></i><strong>Recherche Intelligente:</strong> Utilise l'IA pour trouver les meilleures images depuis plusieurs sources.
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label class="form-label">Recherche intelligente</label>
                                    <input type="text" class="form-control" id="aiSearchQuery" placeholder="Entrez le nom du produit ou laissez vide pour utiliser la d√©signation">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Sources</label>
                                    <select class="form-select" id="aiSources">
                                        <option value="auto" selected>Auto (Bing + Unsplash)</option>
                                        <option value="bing">Bing uniquement</option>
                                        <option value="unsplash">Unsplash uniquement</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary w-100 mb-3" onclick="searchAIImages()">
                                <i class="fas fa-search me-2"></i>Rechercher avec IA
                            </button>
                            
                            <div id="aiResults" class="row g-3"></div>
                            <div id="aiLoader" class="text-center" style="display: none;">
                                <div class="loader"></div>
                                <p class="mt-2">Recherche intelligente en cours...</p>
                            </div>
                        </div>

                        <!-- Description Mode -->
                        <div class="tab-pane fade" id="mode-desc" role="tabpanel">
                            <div class="alert alert-info small">
                                <i class="fas fa-info-circle me-2"></i><strong>Info:</strong> G√©n√®re un lien de recherche.
                            </div>
                            <p class="small text-muted">Cr√©e un lien "Fiche Technique" vers Bing pour chaque produit.</p>
                        </div>
                    </div>

                    <div class="alert alert-info small mt-3">
                        <strong>Aper√ßu:</strong> <span id="bulkPreview" class="text-break">...</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="applyBulkActions()">Appliquer √† tous</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ© ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ====================
        class IntelligentImageSearch {
            constructor() {
                this.sources = {
                    bing: {
                        name: "Bing Images",
                        priority: 1,
                        baseUrl: "https://www.bing.com/images/search"
                    },
                    unsplash: {
                        name: "Unsplash",
                        priority: 2,
                        baseUrl: "https://api.unsplash.com/search/photos"
                    }
                };

                this.qualityKeywords = [
                    "product photography", "white background", "professional", 
                    "commercial use", "high quality", "isolated", "clean",
                    "studio shot", "3d render", "realistic"
                ];

                this.productCategories = {
                    "ordinateurs": ["computer", "pc", "laptop", "desktop", "workstation"],
                    "t√©l√©phones": ["smartphone", "mobile phone", "cell phone", "iphone", "android"],
                    "accessoires": ["accessory", "gadget", "tech accessory", "electronic"],
                    "g√©n√©ral": ["product", "item", "merchandise", "goods"]
                };
            }

            generateSmartQuery(productName, category = "g√©n√©ral") {
                const baseQuery = productName.toLowerCase();
                let enhancedQuery = baseQuery;
                
                if (category && this.productCategories[category.toLowerCase()]) {
                    const catKeywords = this.productCategories[category.toLowerCase()];
                    const randomKeyword = catKeywords[Math.floor(Math.random() * catKeywords.length)];
                    enhancedQuery += " " + randomKeyword;
                }
                
                const randomQualityKeywords = this.qualityKeywords
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 2);
                
                enhancedQuery += " " + randomQualityKeywords.join(" ");
                
                const words = enhancedQuery.split(" ").filter((word, index, self) => {
                    return word.length > 2 && self.indexOf(word) === index;
                });
                
                return words.join(" ");
            }

            calculateImageScore(image, productName) {
                let score = 50;
                
                if (image.source === 'Unsplash') score += 30;
                if (image.source === 'Bing Images') score += 20;
                
                if (image.width >= 800 && image.height >= 600) score += 20;
                if (image.width >= 1200 && image.height >= 800) score += 30;
                
                const imageText = (image.title + " " + (image.description || "")).toLowerCase();
                const productWords = productName.toLowerCase().split(/[\s\-_]+/).filter(w => w.length > 3);
                
                let matches = 0;
                productWords.forEach(word => {
                    if (imageText.includes(word)) matches++;
                });
                
                score += (matches / productWords.length) * 30;
                
                if (imageText.includes('white background') || imageText.includes('isolated')) score += 15;
                if (imageText.includes('product') || imageText.includes('professional')) score += 10;
                
                return Math.min(100, score);
            }

            async searchBingEnhanced(query, count = 6) {
                try {
                    const encodedQuery = encodeURIComponent(query + " product commercial white background");
                    const images = [];
                    
                    for (let i = 0; i < count; i++) {
                        images.push({
                            url: `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=800&h=800&c=7&rs=1&p=0&dpr=2&tid=image&t=${Date.now() + i}`,
                            thumb: `https://tse2.mm.bing.net/th?q=${encodedQuery}&w=300&h=300&c=7&rs=1&p=0&t=${Date.now() + i}`,
                            title: query,
                            description: `Image produit: ${query}`,
                            source: 'Bing Images',
                            width: 800,
                            height: 800,
                            commercial_use: true,
                            quality_score: 85
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Bing search error:', error);
                    return [];
                }
            }

            async searchUnsplashEnhanced(query, count = 6) {
                try {
                    const encodedQuery = encodeURIComponent(query);
                    const images = [];
                    const sizes = ['600x600', '800x800', '1000x1000'];
                    
                    for (let i = 0; i < count; i++) {
                        const size = sizes[i % sizes.length];
                        images.push({
                            url: `https://source.unsplash.com/featured/${size}/?${encodedQuery},product,white-background&sig=${Date.now() + i}`,
                            thumb: `https://source.unsplash.com/featured/300x300/?${encodedQuery},product&sig=${Date.now() + i}`,
                            title: query,
                            description: `Professional product photography of ${query}`,
                            source: 'Unsplash',
                            width: parseInt(size.split('x')[0]),
                            height: parseInt(size.split('x')[1]),
                            commercial_use: true,
                            quality_score: 90
                        });
                    }
                    return images;
                } catch (error) {
                    console.error('Unsplash search error:', error);
                    return [];
                }
            }

            async searchAllSources(query, category, maxResults = 12) {
                const results = [];
                
                try {
                    const bingResults = await this.searchBingEnhanced(query, 4);
                    results.push(...bingResults);
                } catch (e) {
                    console.warn('Bing search failed:', e);
                }
                
                try {
                    const unsplashResults = await this.searchUnsplashEnhanced(query, 4);
                    results.push(...unsplashResults);
                } catch (e) {
                    console.warn('Unsplash search failed:', e);
                }
                
                return results
                    .map(img => ({
                        ...img,
                        relevance_score: this.calculateImageScore(img, query),
                        final_score: (img.quality_score * 0.6) + (this.calculateImageScore(img, query) * 0.4)
                    }))
                    .sort((a, b) => b.final_score - a.final_score)
                    .slice(0, maxResults);
            }
        }

        // ==================== ÿßŸÑÿ≠ÿßŸÑÿ© ŸàÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ====================
        let state = {
            products: [],
            newProducts: [],
            notifications: [],
            gistId: localStorage.getItem('varicom_gist_id') || null,
            lastSync: localStorage.getItem('varicom_last_sync') || null,
            smartSearch: {
                currentProduct: null,
                selectedImage: null,
                searchResults: [],
                currentSearchQuery: ''
            },
            autoSearch: {
                active: false,
                currentIndex: 0,
                totalProducts: 0
            }
        };

        const intelligentSearch = new IntelligentImageSearch();

        // ==================== ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalData();
            updateUI();
            generateSmartSuggestions();

            const tokenInput = document.getElementById('githubToken');
            tokenInput.value = localStorage.getItem('varicom_github_token') || '';
            tokenInput.addEventListener('input', (e) => {
                localStorage.setItem('varicom_github_token', e.target.value);
            });

            ['bulkBaseUrl', 'bulkField', 'bulkExt'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateBulkPreview);
            });

            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateBulkPreview);
            });

            document.getElementById('smartSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    smartImageSearch();
                }
            });
        });

        function loadLocalData() {
            try {
                const saved = localStorage.getItem('varicom_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.products = data.products || [];
                    state.newProducts = data.newProducts || [];
                    state.notifications = data.notifications || [];
                }
            } catch (e) { 
                console.error('Error loading local data', e);
                state.products = [];
                state.newProducts = [];
                state.notifications = [];
            }
        }

        function saveData() {
            const data = {
                products: state.products,
                newProducts: state.newProducts,
                notifications: state.notifications
            };
            localStorage.setItem('varicom_data', JSON.stringify(data));
            updateUI();
        }

        // ==================== ÿ•ŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿ∞ŸÉŸäÿ© ====================
        function generateSmartSuggestions() {
            const suggestions = [
                'ÿµŸàÿ± ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸäÿ©',
                'ÿÆŸÑŸÅŸäÿ© ÿ®Ÿäÿ∂ÿßÿ°',
                'ÿµŸàÿ± ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©',
                'ÿµŸàÿ± ŸÑŸÑŸÖŸÉÿßÿ™ÿ®',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÉŸÖÿ®ŸäŸàÿ™ÿ±',
                'ŸáŸàÿßÿ™ŸÅ ÿ∞ŸÉŸäÿ©',
                'ÿ•ŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™ ÿ™ŸÇŸÜŸäÿ©',
                'ÿµŸàÿ± ÿ™ÿ¨ÿßÿ±Ÿäÿ©',
                'ÿπÿ±Ÿàÿ∂ ÿ™ÿ±ŸàŸäÿ¨Ÿäÿ©',
                'ÿµŸàÿ± ŸàÿßŸÇÿπŸäÿ©',
                'ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿßÿ™',
                'ÿ£ÿ¨Ÿáÿ≤ÿ© ŸÖŸÉÿ™ÿ®Ÿäÿ©',
                'ÿ∑ÿßÿ®ÿπÿßÿ™',
                'ÿ¥ÿßÿ¥ÿßÿ™',
                'ŸÑŸàÿ≠ÿßÿ™ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠'
            ];
            
            const container = document.getElementById('smartSuggestions');
            if (container) {
                container.innerHTML = suggestions.map(tag => 
                    `<span class="suggestion-tag" onclick="addSuggestion('${tag}')">${tag}</span>`
                ).join('');
            }
        }

        function addSuggestion(tag) {
            const input = document.getElementById('smartSearchInput');
            if (input) {
                input.value = tag;
                smartImageSearch();
            }
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ====================
        async function smartImageSearch() {
            const query = document.getElementById('smartSearchInput')?.value;
            const source = document.getElementById('searchSource')?.value || 'auto';
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            state.smartSearch.currentSearchQuery = query;
            state.smartSearch.selectedImage = null;
            
            const resultsDiv = document.getElementById('smartResults');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">ÿ¨ÿßÿ± ÿßŸÑÿ®ÿ≠ÿ´...</span>
                    </div>
                    <div class="mt-4">
                        <h5>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä...</h5>
                        <p class="text-muted">ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑÿ•Ÿäÿ¨ÿßÿØ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿµŸàÿ± ŸÑŸÄ "${query}"</p>
                        <div class="progress" style="height: 8px; width: 200px; margin: 0 auto;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const applyBtnContainer = document.getElementById('applyButtonContainer');
            if (applyBtnContainer) {
                applyBtnContainer.style.display = 'none';
            }
            
            try {
                let images = [];
                const category = state.smartSearch.currentProduct ? 
                    state.products.find(p => p.id === state.smartSearch.currentProduct)?.famille : '';
                
                const smartQuery = intelligentSearch.generateSmartQuery(query, category);
                
                if (source === 'auto') {
                    images = await intelligentSearch.searchAllSources(smartQuery, category, 12);
                } else if (source === 'bing') {
                    images = await intelligentSearch.searchBingEnhanced(smartQuery, 12);
                } else if (source === 'unsplash') {
                    images = await intelligentSearch.searchUnsplashEnhanced(smartQuery, 12);
                }
                
                if (images.length === 0) {
                    const broaderQuery = query.split(' ')[0];
                    images = await intelligentSearch.searchAllSources(broaderQuery, category, 12);
                }
                
                state.smartSearch.searchResults = images;
                
                displaySmartResults(images);
                
                if (state.smartSearch.currentProduct) {
                    const product = state.products.find(p => p.id === state.smartSearch.currentProduct);
                    if (product && applyBtnContainer) {
                        document.getElementById('currentProductInfo').innerHTML = `
                            <strong>ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä:</strong> ${product.designation}<br>
                            <small class="text-muted">${product.ref} | ${product.famille} | ${product.prix} DA</small>
                        `;
                        applyBtnContainer.style.display = 'block';
                    }
                }
                
                showStatus(`ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${images.length} ÿµŸàÿ±ÿ© ÿ®ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©`, 'success');
                
            } catch (error) {
                console.error('Search error:', error);
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä:</strong> ${error.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÇÿπ'}
                                <br>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="smartImageSearch()">
                                    <i class="fas fa-redo me-1"></i>ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
        }

        function displaySmartResults(images) {
            const resultsDiv = document.getElementById('smartResults');
            if (!resultsDiv) return;
            
            if (!images || images.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±</h5>
                        <p class="text-muted mb-4">ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÉŸÑŸÖÿßÿ™ ÿ®ÿ≠ÿ´ ŸÖÿÆÿ™ŸÑŸÅÿ© ÿ£Ÿà ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ ÿ£Ÿàÿ≥ÿπ</p>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = images.map((img, index) => `
                <div class="col-md-3 col-sm-4 col-6 mb-4">
                    <div class="card h-100 image-select-card" onclick="selectSmartImage(${index})" 
                         data-index="${index}">
                        <div class="position-relative" style="height: 180px; overflow: hidden;">
                            <img src="${img.thumb || img.url}" 
                                 class="card-img-top h-100 w-100" 
                                 alt="${img.title}"
                                 style="object-fit: cover;"
                                 onerror="this.src='https://via.placeholder.com/300x200/4A90E2/FFFFFF?text=VARICOM'"
                                 loading="lazy">
                            <span class="search-source-badge">${img.source}</span>
                            
                            <span class="quality-badge" title="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ¨ŸàÿØÿ©">
                                <i class="fas fa-star me-1"></i>${Math.round(img.quality_score || 75)}
                            </span>
                            
                            <span class="relevance-badge" title="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿµŸÑÿ©">
                                <i class="fas fa-bullseye me-1"></i>${Math.round(img.relevance_score || 70)}
                            </span>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <small class="text-muted d-block text-truncate" style="max-width: 70%;" 
                                       title="${img.title}">
                                    ${img.title.substring(0, 20)}${img.title.length > 20 ? '...' : ''}
                                </small>
                                <small class="text-success fw-bold">
                                    ${img.width || 800}√ó${img.height || 800}
                                </small>
                            </div>
                            
                            <div class="progress mb-2" style="height: 4px;" title="ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ¨ŸàÿØÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©">
                                <div class="progress-bar ${img.final_score > 80 ? 'bg-success' : img.final_score > 60 ? 'bg-primary' : 'bg-warning'}" 
                                     style="width: ${img.final_score || 70}%"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">
                                    <i class="fas fa-expand-alt me-1"></i>${img.width || 800}√ó${img.height || 800}
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-percentage me-1"></i>${Math.round(img.final_score || 70)}%
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectSmartImage(index) {
            document.querySelectorAll('.image-select-card').forEach(card => {
                card.classList.remove('border-primary', 'border-3');
                card.classList.add('border-light');
            });
            
            const selectedCard = document.querySelector(`.image-select-card[data-index="${index}"]`);
            if (selectedCard) {
                selectedCard.classList.remove('border-light');
                selectedCard.classList.add('border-primary', 'border-3');
                
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
                
                const applyBtnContainer = document.getElementById('applyButtonContainer');
                if (state.smartSearch.currentProduct && applyBtnContainer) {
                    applyBtnContainer.style.display = 'block';
                }
                
                showStatus(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ© ŸÖŸÜ ${state.smartSearch.searchResults[index].source}`, 'info');
            }
        }

        function applySelectedImageToCurrentProduct() {
            if (!state.smartSearch.currentProduct) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÜÿ™ÿ¨. ÿßÿÆÿ™ÿ± ŸÖŸÜÿ™ÿ¨ÿßŸã ŸÖŸÜ ÿßŸÑÿ¨ÿØŸàŸÑ ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            if (!state.smartSearch.selectedImage) {
                showStatus('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿµŸàÿ±ÿ©. ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ© ÿ£ŸàŸÑÿßŸã.', 'warning');
                return;
            }
            
            updateProductImage(state.smartSearch.currentProduct, state.smartSearch.selectedImage.url);
            showStatus('‚úì ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
            
            setTimeout(() => {
                const applyBtnContainer = document.getElementById('applyButtonContainer');
                if (applyBtnContainer) {
                    applyBtnContainer.style.display = 'none';
                }
            }, 2000);
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ====================
        async function autoSearchProductImages() {
            if (!state.products || state.products.length === 0) {
                showStatus('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }
            
            const productsNeedingImages = state.products.filter(p => {
                const hasImage = p.image && p.image.trim() !== '';
                const isHighQuality = hasImage && (
                    (p.image.includes('bing.net') && p.image.includes('w=800')) || 
                    (p.image.includes('unsplash') && p.image.includes('featured'))
                );
                return !hasImage || !isHighQuality;
            }).slice(0, 20);
            
            if (productsNeedingImages.length === 0) {
                showStatus('ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿµŸàÿ± ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©', 'info');
                return;
            }
            
            state.autoSearch = {
                active: true,
                currentIndex: 0,
                totalProducts: productsNeedingImages.length,
                products: productsNeedingImages
            };
            
            const progressBar = document.getElementById('autoSearchProgress');
            const progressBarInner = document.getElementById('autoSearchProgressBar');
            if (progressBar) progressBar.style.display = 'block';
            if (progressBarInner) progressBarInner.style.width = '0%';
            
            showStatus(`ÿ®ÿØÿ£ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ŸÑŸÄ ${productsNeedingImages.length} ŸÖŸÜÿ™ÿ¨...`, 'info');
            
            for (let i = 0; i < productsNeedingImages.length; i++) {
                if (!state.autoSearch.active) break;
                
                const product = productsNeedingImages[i];
                state.autoSearch.currentIndex = i + 1;
                
                try {
                    const smartQuery = intelligentSearch.generateSmartQuery(
                        product.designation, 
                        product.famille
                    );
                    
                    const images = await intelligentSearch.searchAllSources(smartQuery, product.famille, 1);
                    
                    if (images.length > 0) {
                        const bestImage = images[0];
                        updateProductImage(product.id, bestImage.url);
                        
                        if (progressBarInner) {
                            const progress = ((i + 1) / productsNeedingImages.length) * 100;
                            progressBarInner.style.width = `${progress}%`;
                        }
                        
                        showStatus(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${product.designation} (${i+1}/${productsNeedingImages.length})`, 'success');
                    }
                } catch (e) {
                    console.error(`Failed to search for: ${product.designation}`, e);
                    showStatus(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ${product.designation}`, 'error');
                }
                
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            
            state.autoSearch.active = false;
            if (progressBar) progressBar.style.display = 'none';
            showStatus('üéâ ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ∞ŸÉŸä ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
        }

        // ==================== ŸÖÿπÿßŸÑÿ¨ÿ© Excel ====================
        function handleExcelUpload(file) {
            if (!file) return;

            showStatus('Lecture du fichier...', 'info');
            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    processExcelData(jsonData);
                } catch (err) {
                    showStatus('Erreur lecture Excel: ' + err.message, 'error');
                }
            };
            reader.onerror = () => {
                showStatus('Erreur de lecture du fichier', 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            if (!Array.isArray(data)) {
                showStatus('Format de fichier invalide', 'error');
                return;
            }

            const processed = data.map((row, idx) => ({
                id: `prod_${Date.now()}_${idx}`,
                ref: row['Ref'] || row['R√©f√©rence'] || row['Code'] || `REF${idx + 1}`,
                designation: row['Designation'] || row['D√©signation'] || row['Nom'] || 'Produit sans nom',
                famille: row['Famille'] || row['Categorie'] || 'G√©n√©ral',
                prix: parseFloat(row['Prix'] || row['Price'] || 0) || 0,
                image: row['Image'] || row['Photo'] || '',
                description: row['Description'] || row['Desc'] || ''
            })).filter(p => p.designation && p.designation !== 'Produit sans nom');

            state.products = processed;
            saveData();
            showStatus(`${processed.length} produits import√©s avec succ√®s!`, 'success');
        }

        // ==================== ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸàÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ====================
        function addNewProduct() {
            const name = document.getElementById('newProductName')?.value;
            const price = document.getElementById('newProductPrice')?.value;
            const cat = document.getElementById('newProductCategory')?.value;
            const img = document.getElementById('newProductImage')?.value;

            if (!name || !price) {
                showStatus('Nom et Prix requis', 'warning');
                return;
            }

            state.newProducts.unshift({
                id: `new_${Date.now()}`,
                name: name.trim(),
                price: parseFloat(price) || 0,
                category: cat || 'G√©n√©ral',
                image: img || '',
                timestamp: new Date().toISOString()
            });

            if (document.getElementById('newProductName')) {
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductImage').value = '';
            }

            saveData();
            showStatus('Nouveau produit ajout√©', 'success');
        }

        function createNotification() {
            const title = document.getElementById('notifTitle')?.value;
            const msg = document.getElementById('notifMessage')?.value;
            const type = document.getElementById('notifType')?.value;

            if (!title || !msg) {
                showStatus('Titre et Message requis', 'warning');
                return;
            }

            state.notifications.unshift({
                id: `notif_${Date.now()}`,
                title: title.trim(),
                message: msg.trim(),
                type: type || 'info',
                timestamp: new Date().toISOString()
            });

            if (document.getElementById('notifTitle')) {
                document.getElementById('notifTitle').value = '';
                document.getElementById('notifMessage').value = '';
            }

            saveData();
            showStatus('Notification cr√©√©e', 'success');
        }

        function removeNewProduct(id) {
            state.newProducts = state.newProducts.filter(p => p.id !== id);
            saveData();
        }

        function removeNotification(id) {
            state.notifications = state.notifications.filter(n => n.id !== id);
            saveData();
        }

        // ==================== ÿßŸÑÿØŸàÿßŸÑ ÿßŸÑÿ¨ŸÖÿßÿπŸäÿ© ====================
        function openBulkImageModal() {
            const modalElement = document.getElementById('bulkImageModal');
            if (modalElement) {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                updateBulkPreview();
            }
        }

        function updateBulkPreview() {
            const activeTab = document.querySelector('.nav-link.active');
            const preview = document.getElementById('bulkPreview');
            
            if (!activeTab || !preview) return;

            if (activeTab.id === 'mode-magic-tab') {
                preview.textContent = `https://tse2.mm.bing.net/th?q=ExempleProduit&w=800&h=800`;
            } else if (activeTab.id === 'mode-desc-tab') {
                preview.textContent = `https://www.bing.com/search?q=fiche+technique+ExempleProduit`;
            } else if (activeTab.id === 'mode-ai-tab') {
                preview.textContent = `Recherche IA avec sources multiples`;
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl')?.value || 'https://site.com/img/';
                const field = document.getElementById('bulkField')?.value || 'ref';
                const ext = document.getElementById('bulkExt')?.value || '.jpg';
                const example = field === 'ref' ? 'REF123' : 'Produit_Exemple';
                preview.textContent = `${baseUrl}${example}${ext}`;
            }
        }

        async function searchAIImages() {
            const query = document.getElementById('aiSearchQuery')?.value;
            const source = document.getElementById('aiSources')?.value || 'auto';
            
            if (!query) {
                showStatus('ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ŸÑŸÑÿ®ÿ≠ÿ´', 'warning');
                return;
            }

            const loader = document.getElementById('aiLoader');
            const resultsDiv = document.getElementById('aiResults');
            
            if (loader) loader.style.display = 'block';
            if (resultsDiv) resultsDiv.innerHTML = '';

            try {
                let images = [];
                const smartQuery = intelligentSearch.generateSmartQuery(query);
                
                if (source === 'auto') {
                    images = await intelligentSearch.searchAllSources(smartQuery, '', 9);
                } else if (source === 'bing') {
                    images = await intelligentSearch.searchBingEnhanced(smartQuery, 9);
                } else if (source === 'unsplash') {
                    images = await intelligentSearch.searchUnsplashEnhanced(smartQuery, 9);
                }

                displayAIResults(images);
                
            } catch (error) {
                console.error('AI Search error:', error);
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                Erreur de recherche: ${error.message || 'Erreur inconnue'}
                            </div>
                        </div>
                    `;
                }
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }

        function displayAIResults(results) {
            const container = document.getElementById('aiResults');
            if (!container) return;
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            Aucune image trouv√©e. Essayez avec d'autres termes.
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map((img, index) => `
                <div class="col-md-4 col-sm-6">
                    <div class="ai-image-result" onclick="selectAIImage(${index})">
                        <div class="position-relative" style="height: 150px; overflow: hidden;">
                            <img src="${img.thumb || img.url}" class="w-100 h-100" style="object-fit: cover;" alt="${img.title}">
                            <span class="search-source-badge">${img.source}</span>
                        </div>
                        <div class="p-2">
                            <small class="d-block text-truncate">${img.title}</small>
                            <small class="text-muted">
                                <i class="fas fa-${img.source === 'Unsplash' ? 'camera' : 'search'} me-1"></i>
                                ${img.source} - ${img.width || 800}√ó${img.height || 800}
                            </small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectAIImage(index) {
            document.querySelectorAll('.ai-image-result').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selected = document.querySelectorAll('.ai-image-result')[index];
            if (selected) {
                selected.classList.add('selected');
                state.smartSearch.selectedImage = state.smartSearch.searchResults[index];
            }
        }

        function applyBulkActions() {
            const activeTab = document.querySelector('.nav-link.active');
            if (!activeTab || !state.products || state.products.length === 0) {
                showStatus('Aucun produit √† modifier', 'warning');
                return;
            }

            if (!confirm(`Cela va modifier ${state.products.length} produits. Continuer?`)) {
                return;
            }

            if (activeTab.id === 'mode-magic-tab') {
                state.products = state.products.map(p => ({
                    ...p,
                    image: `https://tse2.mm.bing.net/th?q=${encodeURIComponent(p.designation)}&w=800&h=800&c=7&rs=1&p=0`
                }));
            } else if (activeTab.id === 'mode-desc-tab') {
                state.products = state.products.map(p => ({
                    ...p,
                    description: `https://www.bing.com/search?q=fiche+technique+${encodeURIComponent(p.designation)}`
                }));
            } else if (activeTab.id === 'mode-ai-tab') {
                if (state.smartSearch.selectedImage) {
                    const selectedUrl = state.smartSearch.selectedImage.url;
                    state.products = state.products.map(p => ({
                        ...p,
                        image: selectedUrl
                    }));
                    showStatus('Image IA appliqu√©e √† tous les produits', 'success');
                } else {
                    showStatus('Veuillez d\'abord s√©lectionner une image', 'warning');
                    return;
                }
            } else {
                const baseUrl = document.getElementById('bulkBaseUrl')?.value;
                const field = document.getElementById('bulkField')?.value || 'ref';
                const ext = document.getElementById('bulkExt')?.value || '';

                if (!baseUrl) {
                    showStatus('Veuillez entrer une URL de base', 'warning');
                    return;
                }

                state.products = state.products.map(p => {
                    const val = p[field] ? p[field].toString().trim() : '';
                    const safeVal = field === 'designation' ? 
                        val.replace(/[^a-zA-Z0-9-_]/g, '_') : 
                        val;
                    return {
                        ...p,
                        image: `${baseUrl}${safeVal}${ext}`
                    };
                });
            }

            saveData();
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkImageModal'));
            if (modal) modal.hide();
            showStatus('Mise √† jour effectu√©e avec succ√®s!', 'success');
        }

        // ==================== ÿßŸÑÿ®ÿ≠ÿ´ ŸÑŸÑÿ¨ÿØŸàŸÑ ====================
        function openSmartSearchForProduct(productId, designation) {
            state.smartSearch.currentProduct = productId;
            const searchInput = document.getElementById('smartSearchInput');
            if (searchInput) searchInput.value = designation;
            
            const searchSource = document.getElementById('searchSource');
            if (searchSource) searchSource.value = 'auto';
            
            const suggestions = document.querySelector('.smart-suggestions');
            if (suggestions) {
                suggestions.scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
            
            setTimeout(() => {
                smartImageSearch();
                showStatus(`ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ± ŸÑŸÄ ${designation}ÿå ÿ´ŸÖ ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ© ÿ´ŸÖ ÿπŸÑŸâ "ÿ™ÿ∑ÿ®ŸäŸÇ"`, 'info');
            }, 800);
        }

        async function quickImageSearch(productId, designation) {
            showStatus(`ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ${designation}...`, 'info');
            
            try {
                const smartQuery = intelligentSearch.generateSmartQuery(designation);
                const images = await intelligentSearch.searchBingEnhanced(smartQuery, 1);
                if (images.length > 0) {
                    updateProductImage(productId, images[0].url);
                    showStatus(`‚úì ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ© ŸÑŸÄ ${designation}`, 'success');
                } else {
                    showStatus('ŸÑŸÖ ÿ£ÿ¨ÿØ ÿµŸàÿ±ÿßŸã ŸÖŸÜÿßÿ≥ÿ®ÿ©', 'warning');
                }
            } catch (error) {
                console.error('Quick search error:', error);
                showStatus('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´', 'error');
            }
        }

        // ==================== ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ ====================
        function updateProductImage(id, newUrl) {
            const product = state.products.find(p => p.id === id);
            if (product) {
                product.image = newUrl;
                saveData();
                updateUI();
            }
        }

        function updateProductDesc(id, newUrl) {
            const product = state.products.find(p => p.id === id);
            if (product) {
                product.description = newUrl;
                saveData();
                updateUI();
            }
        }

        // ==================== GitHub Sync ====================
        async function uploadToGitHubGist() {
            const token = document.getElementById('githubToken')?.value;
            if (!token || token.trim() === '') {
                showStatus('Token GitHub manquant!', 'error');
                return;
            }

            if (state.products.length === 0 && state.newProducts.length === 0) {
                showStatus('Aucun produit √† publier! Veuillez importer des donn√©es.', 'warning');
                return;
            }

            const btn = document.getElementById('publishBtn');
            if (!btn) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synchronisation...';
            btn.disabled = true;

            const payload = {
                description: "VARICOM Catalog Data",
                public: true,
                files: {
                    "varicom_data.json": {
                        content: JSON.stringify({
                            products: state.products,
                            newProducts: state.newProducts,
                            notifications: state.notifications,
                            lastUpdate: new Date().toISOString(),
                            meta: { version: "2.0", source: "VaricomAdmin" }
                        })
                    }
                }
            };

            try {
                let url = 'https://api.github.com/gists';
                let method = 'POST';

                if (state.gistId) {
                    url += `/${state.gistId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 404 && state.gistId) {
                        state.gistId = null;
                        localStorage.removeItem('varicom_gist_id');
                        return uploadToGitHubGist();
                    }
                    throw new Error(`Erreur GitHub: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                state.gistId = result.id;
                state.lastSync = new Date().toISOString();

                localStorage.setItem('varicom_gist_id', state.gistId);
                localStorage.setItem('varicom_last_sync', state.lastSync);

                showStatus('‚úÖ Synchronisation r√©ussie! Donn√©es publi√©es.', 'success');
                updateUI();

            } catch (err) {
                console.error('Sync error:', err);
                showStatus('Erreur Sync: ' + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ====================
        function updateUI() {
            // Stats
            updateElement('statsProducts', state.products.length);
            updateElement('statsNewProducts', state.newProducts.length);
            updateElement('statsNotifications', state.notifications.length);
            
            const statsStatus = document.getElementById('statsStatus');
            if (statsStatus) {
                statsStatus.textContent = state.gistId ? 'Actif' : 'Inactif';
                statsStatus.className = state.gistId ? 'text-success' : 'text-danger';
            }

            // Lists
            updateNewProductsList();
            updateNotificationsList();

            // Catalog Table
            updateCatalogTable();
        }

        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function updateNewProductsList() {
            const list = document.getElementById('activeNewProducts');
            if (!list) return;

            list.innerHTML = state.newProducts.map(p => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(p.name)}</strong> - ${p.price} DA
                        <br><small class="text-muted">${p.category}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNewProduct('${escapeJs(p.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');
        }

        function updateNotificationsList() {
            const list = document.getElementById('activeNotifications');
            if (!list) return;

            list.innerHTML = state.notifications.map(n => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-${getBadgeClass(n.type)} me-2">${getBadgeIcon(n.type)}</span>
                        <strong>${escapeHtml(n.title)}</strong>
                        <br><small class="text-muted">${escapeHtml(n.message.substring(0, 50))}${n.message.length > 50 ? '...' : ''}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeNotification('${escapeJs(n.id)}')">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `).join('');
        }

        function updateCatalogTable() {
            const tableBody = document.getElementById('catalogTableBody');
            if (!tableBody) return;

            const productsToShow = state.products.slice(0, 100);
            
            tableBody.innerHTML = productsToShow.map(p => `
                <tr data-product-id="${p.id}">
                    <td><small>${escapeHtml(p.ref)}</small></td>
                    <td class="text-truncate" style="max-width: 150px;" title="${escapeHtml(p.designation)}">
                        ${escapeHtml(p.designation)}
                    </td>
                    <td>${p.prix} DA</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" 
                                   value="${escapeHtml(p.image || '')}" 
                                   onchange="updateProductImage('${escapeJs(p.id)}', this.value)"
                                   placeholder="URL Image...">
                            <button class="btn btn-outline-primary" 
                                    onclick="quickImageSearch('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ">
                                <i class="fas fa-bolt"></i>
                            </button>
                        </div>
                        ${p.image ? 
                            `<small class="text-success"><i class="fas fa-check-circle"></i> ŸÖŸàÿ¨ŸàÿØÿ©</small>` : 
                            `<small class="text-danger"><i class="fas fa-times-circle"></i> ŸÖŸÅŸÇŸàÿØÿ©</small>`}
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${escapeHtml(p.description || '')}" 
                               onchange="updateProductDesc('${escapeJs(p.id)}', this.value)"
                               placeholder="URL Desc...">
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" 
                                    onclick="openSmartSearchForProduct('${escapeJs(p.id)}', '${escapeJs(p.designation)}')"
                                    title="ÿ®ÿ≠ÿ´ ÿ∞ŸÉŸä">
                                <i class="fas fa-robot"></i>
                            </button>
                            <button class="btn btn-outline-primary" 
                                    onclick="window.open('https://www.bing.com/images/search?q=${encodeURIComponent(p.designation + ' product white background')}', '_blank')"
                                    title="Bing">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-info" 
                                    onclick="window.open('https://unsplash.com/s/photos/${encodeURIComponent(p.designation)}', '_blank')"
                                    title="Unsplash">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getBadgeClass(type) {
            switch (type) {
                case 'info': return 'info';
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'danger';
                default: return 'secondary';
            }
        }

        function getBadgeIcon(type) {
            switch (type) {
                case 'info': return '‚ÑπÔ∏è';
                case 'success': return '‚úÖ';
                case 'warning': return '‚ö†Ô∏è';
                case 'error': return '‚ùå';
                default: return 'üîî';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeJs(text) {
            if (!text) return '';
            return text.toString()
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }

        // ==================== ÿØŸàÿßŸÑ ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ© ====================
        function showStatus(msg, type) {
            const el = document.getElementById('syncStatus');
            if (!el) return;

            el.textContent = msg;
            el.className = 'sync-status';
            
            switch(type) {
                case 'success':
                    el.classList.add('sync-success');
                    break;
                case 'warning':
                    el.classList.add('sync-warning');
                    break;
                case 'error':
                    el.classList.add('sync-error');
                    break;
                default:
                    el.classList.add('sync-success');
            }
            
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        function generateClientLink() {
            if (!state.gistId) {
                showStatus('Veuillez d\'abord publier le catalogue', 'warning');
                return;
            }

            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            const clientUrl = `${baseUrl}index.html?gist=${state.gistId}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(clientUrl).then(() => {
                    showStatus('‚úÖ Lien client copi√©!', 'success');
                }).catch(() => {
                    prompt('Copiez ce lien manuellement:', clientUrl);
                    showStatus('Lien pr√™t √† √™tre copi√©', 'info');
                });
            } else {
                prompt('Copiez ce lien manuellement:', clientUrl);
                showStatus('Lien pr√™t √† √™tre copi√©', 'info');
            }
        }

        function toggleToken() {
            const input = document.getElementById('githubToken');
            const icon = input?.parentNode?.querySelector('i');
            if (input && icon) {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                }
            }
        }

        function resetSync() {
            if (confirm('Voulez-vous vraiment r√©initialiser la synchronisation? Cela d√©connectera le catalogue actuel.')) {
                localStorage.removeItem('varicom_gist_id');
                localStorage.removeItem('varicom_last_sync');
                state.gistId = null;
                state.lastSync = null;
                updateUI();
                showStatus('Synchronisation r√©initialis√©e', 'info');
            }
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([
                { 
                    Ref: 'REF001', 
                    Designation: 'Exemple Produit', 
                    Famille: 'Informatique', 
                    Prix: 1000, 
                    Image: 'https://example.com/image.jpg', 
                    Description: 'https://example.com/description' 
                }
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Modele");
            XLSX.writeFile(wb, "modele_import_varicom.xlsx");
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
